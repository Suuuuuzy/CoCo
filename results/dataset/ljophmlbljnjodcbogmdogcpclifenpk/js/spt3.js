var clientversion="0.0.0.6";var naclEnabled,base64EncodeChars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";if("undefined"==typeof MsgTag)var MsgTag={Audio:0,Command:1,Video:2,Heartbeat:3};
function base64encode(b){var c,f,e,d,g,a;e=b.length;f=0;for(c="";f<e;){d=b.charCodeAt(f++)&255;if(f==e){c+=base64EncodeChars.charAt(d>>2);c+=base64EncodeChars.charAt((d&3)<<4);c+="==";break}g=b.charCodeAt(f++);if(f==e){c+=base64EncodeChars.charAt(d>>2);c+=base64EncodeChars.charAt((d&3)<<4|(g&240)>>4);c+=base64EncodeChars.charAt((g&15)<<2);c+="=";break}a=b.charCodeAt(f++);c+=base64EncodeChars.charAt(d>>2);c+=base64EncodeChars.charAt((d&3)<<4|(g&240)>>4);c+=base64EncodeChars.charAt((g&15)<<2|(a&192)>>
6);c+=base64EncodeChars.charAt(a&63)}return c}var base64DecodeChars=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1];
function base64decode(b){var c,f,e,d,g;d=b.length;e=0;for(g="";e<d;){do c=base64DecodeChars[b.charCodeAt(e++)&255];while(e<d&&-1==c);if(-1==c)break;do f=base64DecodeChars[b.charCodeAt(e++)&255];while(e<d&&-1==f);if(-1==f)break;g+=String.fromCharCode(c<<2|(f&48)>>4);do{c=b.charCodeAt(e++)&255;if(61==c)return g;c=base64DecodeChars[c]}while(e<d&&-1==c);if(-1==c)break;g+=String.fromCharCode((f&15)<<4|(c&60)>>2);do{f=b.charCodeAt(e++)&255;if(61==f)return g;f=base64DecodeChars[f]}while(e<d&&-1==f);if(-1==
f)break;g+=String.fromCharCode((c&3)<<6|f)}return g}function getAppName(){var b=navigator.userAgent.toLowerCase();return b.match(/msie ([\d.]+)/)?"Microsoft IE":b.match(/firefox\/([\d.]+)/)?"Mozilla Firefox":b.match(/chrome\/([\d.]+)/)?b.match(/cros/)?"Google Chrome OS":"Google Chrome":b.match(/opera.*version.([\d.]+)/)?"Opera":b.match(/version\/([\d.]+).*safari/)?"Apple Safari":b.match(/version\/([\d.]+).*mobile\/([\d.]+).*safari/)?"Mobile Safari":"Unknown Browser"}
function getPlatform(){var b=navigator.platform.toLowerCase();if(b.match(/^win/))return navigator.appVersion.toLowerCase().match(/windows nt 6\.2/)?"win8":"win";if(b.match(/^linux/))return"linux";if(b.match(/^mac/))return"mac"}
function getAppVersion(){var b=navigator.userAgent.toLowerCase(),c;return(c=b.match(/msie ([\d.]+)/))?c[1]:(c=b.match(/firefox\/([\d.]+)/))?c[1]:(c=b.match(/chrome\/([\d.]+)/))?c[1]:(c=b.match(/opera.*version.([\d.]+)/))?c[1]:(c=b.match(/version\/([\d.]+).*safari/))?c[1]:(c=b.match(/version\/([\d.]+).*mobile\/([\d.]+).*safari/))?c[1]:"0.0"}
function getPlatformVersion(){var b="Unknown OS",c=getAppVersion();if(isCrOS())b="chromoebook "+c;else{var f=navigator.platform.toLowerCase();if(f.match(/^win/))b=navigator.appVersion.toLowerCase(),b=b.match(/windows nt 6\.2/)?"window 8":b.match(/windows nt 6\.1/)?"window 7":"window";else{if(f.match(/^linux/))return"linux";if(f.match(/^mac/))return"osx"}b+="(chrome "+c+")"}return b}
function isCrOS(){var b=!1,c=navigator.appVersion;c&&(c=c.split(") ")[0])&&1<c.length&&(c=c.split("; ")[1])&&1<c.length&&(c=c.split(" ")[0])&&"CrOS"==c&&(b=!0);return b}
function isNaclEnabled(){naclEnabled=naclEnabled||!1;if(!naclEnabled){var b=document.createElement("embed");b.setAttribute("type","application/x-nacl");b.setAttribute("width",0);b.setAttribute("height",0);b.setAttribute("src","../nacl/videoview.nmf");document.body.appendChild(b);"undefined"!=typeof b.postMessage&&(naclEnabled=!0);document.body.removeChild(b)}return naclEnabled}
function checkBrowserWS(){var b={},c=navigator.userAgent.toLowerCase(),f;(f=c.match(/msie ([\d.]+)/))?b.ie=f[1]:(f=c.match(/firefox\/([\d.]+)/))?b.firefox=f[1]:(f=c.match(/chrome\/([\d.]+)/))?b.chrome=f[1]:(f=c.match(/opera.*version.([\d.]+)/))?b.opera=f[1]:(f=c.match(/version\/([\d.]+).*safari/))?b.safari=f[1]:(f=c.match(/version\/([\d.]+).*mobile\/([\d.]+).*safari/))?b.msafari=f[1]:b={};b.msafari&&(b.safari=null);return b.firefox&&(c=b.firefox.split("."),c=c[0],6<=parseInt(c,10))||b.chrome&&(c=
b.chrome.split("."),c=c[0],14<=parseInt(c,10))?!0:b.safari&&(c=b.safari.split("."),c=c[0],5<=parseInt(c,10))?!1:b.ie&&(c=b.ie.split(".")[0],10<=parseInt(c,10))||b.opera&&(c=parseInt(b.opera.split(".")[0],10),b=parseInt(b.opera.split(".")[1],10),12<c||12==c&&10<=b)?!0:!1}
function compareVersion(b,c){try{var f=b.split("."),e=c.split("."),d=f.length;d>e.length&&(d=e.length);for(var g=0;g<d;g++){if(parseInt(f[g])>parseInt(e[g]))return 1;if(parseInt(f[g])<parseInt(e[g]))return-1;if(g==d-1)return f.length>e.length?1:f.length<e.length?-1:0}}catch(a){return-2}}
function parseUrl(b,c){b||(b=location.search);if(!b||""==b||"?"==b)return null;var f,e=[];f=b.split("?")[1];if(!f)return null;if(c){for(var d=f.split("&"),g=0;g<d.length;g++){var a=d[g].split("=");"key"==a[0]?f=a[1]:e[a[0]]=1<a.length?a[1]:null}f=decodeURIComponent(base64decode(f))}f=f.split("&");for(g=0;g<f.length;g++)a=f[g].split("="),e[a[0]]=1<a.length?a[1]:null;return e}
function genUUID(b,c){var f=[],e,d="0123456789abcdefghijklmnopqrstuvwxyz".split("");b=b||32;6>b&&(b=32);c=c||d.length;c>d.length&&(c=d.length);for(e=0;e<b;e++)f[e]=d[0|parseInt(Math.random()*c)];return f.join("")}function getUUID(){var b=location.host+"/connect.html",c=storageGet(b);c&&""!=c||(c=genUUID(32,16),storageSet(b,c));return c}function setConnectURI(b){storageSet("connectURI",b)}function getConnectURI(){return storageGet("connectURI")}
function setConnectState(b){return storageSet("connectResult",b)}function getConnectState(){return storageGet("connectResult")}function setSessionConnecting(){setConnectState(1)}function setSessionConnectFail(){setConnectState(-1)}function setSessionConnectSucc(){setConnectState(0)}function sessionConnecting(){return 1==getConnectState()?!0:!1}function sessionFailed(){return-1==getConnectState()?!0:!1}function sessionConnected(){return 0==getConnectState()?!0:!1};var singal_server_addr="wss://wbs.relay.splashtop.com",extid_receiver="gjchibeaaphfidcocagddaebmbiondki",extid_sender="bnonegmlejfmmbiifekcakemjeeeoaim",m360_native_app_name="com.crestron.airmedia.native",config_oem="splashtop",config_uuid="bc75c746-6e64-3a54-a5ba-1b0983df9125",websocket_sub_protocol="com.splashtop.webrtc2",wbsserver_api_version="0.5";var p=null,storageGet=function(b){return p},storageSet=function(b,c){return p},storageRemove=function(b){return p},storageClear=function(){return p},storageInit=function(){return p},storageInited=!1;
if(chrome&&chrome.app.window&&chrome.storage&&chrome.storage.local){var w=chrome.app.window.current.parentwindow;w||(console.log("reget window"),w=chrome.app.window.current,w.s={});w.s||(console.log("Redefine w.s"),w.s={});try{chrome.storage.local.get(p,function(b){storageInited=!0;w.s=b})}catch(e$$13){console.log("chrome storage error!")}storageInit=function(){try{chrome.storage.onChanged.addListener(function(b,f){for(k in b)w.s[k]=b[k].newValue})}catch(b){console.log("chrome storage error!")}};
storageGet=function(b,c){var f=null;b in w.s&&(f=w.s[b]);if(c)if(storageInited)c(f);else{storageInit();try{chrome.storage.local.get(b,function(d){storageInited=!0;d&&(w.s=d,c(d[b]))})}catch(e){console.log("chrome storage error!"),c(f)}}return f};storageSet=function(b,c){w.s[b]=c;var f={};f[b]=c;chrome.storage.local.set(f)};storageRemove=function(b){w.s[b]=p;chrome.storage.local.remove(b)};storageClear=function(){w.s={};chrome.storage.local.clear()}}else window.localStorage&&(storageGet=function(b){return window.localStorage.getItem(b)},
storageSet=function(b,c){window.localStorage.setItem(b,c);storageGet(b)},storageRemove=function(b){window.localStorage.removeItem(b)},storageClear=function(){window.localStorage.clear()});Array.prototype.push||(Array.prototype.push=function(){for(var b=0,c=arguments.length;b<c;b++)this[this.length]=arguments[b];return this.length});Array.prototype.shift||(Array.prototype.shift=function(){if(0<this.length){for(var b=this[0],c=0,f=this.length-1;c<f;c++)this[c]=this[c+1];this.length-=1;return b}});
Array.prototype.splice||(Array.prototype.splice=function(b,c){var f=this.slice(b+c),e=this.slice(b,b+c);this.length=b;for(var d=[],g=0,a=arguments.length;g<a;g++)d[g]=arguments[g];f=2<d.length?d.slice(2).concat(f):f;g=0;for(a=f.length;g<a;g++)this.push(f[g]);return e});function getCallStack(){var b=[];try{call.doesnt.method+=1}catch(c){for(var f=c.stack?c.stack.split("\n"):c.message?c.message.split("\n"):[],e=0;e<f.length;e++)f[e].match(/^\s*at.*/)&&b.push(f[e])}return b}
function getFunctionName(b){var c="System call";(b=b.split(" ("))&&1<b.length&&(b=b[0].split(" at "))&&1<b.length&&(c=b[1]);return c}function getFileName(b){var c="";0<b.indexOf("?")&&(b=b.split("?")[0]);(b=b.split("/"))&&1<b.length&&(b=b[b.length-1],0<b.indexOf(":")?(b=b.split(":"))&&1<b.length&&(c=b[0]):c=b);return c}function getLine(b){var c=0;(b=b.split("/"))&&1<b.length&&(b=b[b.length-1].split(":"))&&1<b.length&&(c=b[1]);return c}function getCallLine(b){return 4<b.length?b[4]:""}
var log4splashtop=function(){function b(a,b){void 0===b&&(b=a,a=new Date);var c={M:a.getMonth()+1,d:a.getDate(),h:a.getHours(),m:a.getMinutes(),s:a.getSeconds(),q:Math.floor((a.getMonth()+3)/3)};return b=b.replace(/([yMdhmsqS])+/g,function(b,h){var d=c[h];return void 0!==d?(1<b.length&&(d="0"+d,d=d.substr(d.length-2)),d):"S"===h?a.getMilliseconds():"y"===h?(a.getFullYear()+"").substr(4-b.length):b})}function c(a,h,c,d){this.time=a;this.level=h;this.name=c;this.message=d;var e=getCallStack(),t=getCallLine(e);
this.format=function(){for(var a="",h=0;h<this.message.length;h++)a+=b(this.time,"yyyy-MM-dd hh:mm:ss:SSS")+" "+this.level.toString()+" ("+getFileName(t)+":"+getFunctionName(t)+":"+getLine(t)+") "+this.message[h];return a};this.trace=function(){for(var a=b(this.time,"yyyy-MM-dd hh:mm:ss:SSS")+" "+this.level.toString()+" ("+getFileName(t)+":"+getFunctionName(t)+":"+getLine(t)+") "+this.message+"\n",h=4;h<e.length;h++)a+=e[h]+"\n";return a}}function f(b){this.getMessages=function(){return n};this.name=
b;storageGet("savedlogcount")&&(d=parseInt(storageGet("savedlogcount")));this.setLogLevel=function(a){storageSet("loglevel",a);a=a.toLowerCase();"debug"==a?g=e.DEBUG:"trace"==a?g=e.TRACE:"info"==a?g=e.INFO:"warn"==a?g=e.WARN:"error"==a&&(g=e.ERROR)};this.log=function(a,b){if(a.isGreaterOrEqual(g)){var d=new c(new Date,a,this.name,b);n[n.length]=d;if(!0===s){var e="";storageGet(l)&&(e=storageGet(l));e+=d.format();storageSet(l,e+"\n")}"undefined"!=typeof console&&console.log(d.format())}};this.dump=
function(a){a=new c(new Date,e.TRACE,this.name,a);n[n.length]=a;var b="";storageGet(l)&&(b=storageGet(l));b+=a.trace();storageSet(l,b)};this.printLog=function(){if(console&&n)for(var a=0;a<n.length;a++)for(var b=n[a],c=0;c<b.length;c++)console.log(b[c].format())};this.startNewLog=function(){this.bLog(a)};this.initStorage=function(){storageGet(l)||storageSet(l,"");var b=storageGet(l);if(b&&""!=b){var c=b.split(a);if(!(c.length<=d)){for(var b=[],e=c.length-d;e<c.length;e++)b.push(c[e]);b=a+b.join(a)}b+=
a}else b=a;storageSet(l,b)};this.save=function(){if(storageGet(l)){for(var a=storageGet(l),b=0;b<n.length;b++)a+=n[b].format();storageSet(l,a);n.clear()}};this.clear=function(){storageRemove(l);n.clear()};this.resetStorage=function(){this.initStorage()};this.setLevel=function(a){loggerLevel=a};this.getLevel=function(){return loggerLevel};this.toString=function(){return"Logger["+this.name+"]"};this.SaveToStorage=function(a){s=a}}var e=function(a,b){this.level=a;this.name=b};e.prototype={toString:function(){return this.name},
equals:function(a){return this.level==a.level},isGreaterOrEqual:function(a){return this.level>=a.level}};e.TRACE=new e(1E4,"TRACE");e.DEBUG=new e(2E4,"DEBUG");e.INFO=new e(3E4,"INFO");e.WARN=new e(4E4,"WARN");e.ERROR=new e(5E4,"ERROR");e.LOG=new e(6E4,"LOG");var d=1,g=e.INFO,a="***START A NEW SESSION LOG***\n",l="Splashtop_saved_log",s=!1,q={},m=[],n=[];(function(a){var b={};a.replace(/(\w+)=(\w+)/ig,function(a,c,d){b[c]=d});return b})(location.href);f.prototype={trace:function(){this.log(e.TRACE,
arguments)},debug:function(){this.log(e.DEBUG,arguments)},info:function(){this.log(e.INFO,arguments)},warn:function(){this.log(e.WARN,arguments)},error:function(){this.log(e.ERROR,arguments)},bLog:function(){this.log(e.LOG,arguments)}};log4splashtop=function(){};log4splashtop.getLogger=function(a){a||(a="Splashtop_default_logger_name");if(!q[a]){var b=new f(a);q[a]=b;m.push(a)}return q[a]};log4splashtop.printLog=function(){var a=storageGet(l);console&&a&&console.log(a)};return window.log4splashtop=
log4splashtop}();window.log=window.log||log4splashtop.getLogger();var l18n=l18n||{};
l18n.dotranslation=function(){$(".need_l18n").each(function(b,c){$(c).text(chrome.i18n.getMessage($(c).attr("id")))});$(".need_l18n_raw_html").each(function(b,c){$(c).html(chrome.i18n.getMessage($(c).attr("id")))});$(".need_l18n_input").each(function(b,c){$(c).val(chrome.i18n.getMessage($(c).attr("id")))});$(".need_l18n_title").each(function(b,c){document.title=chrome.i18n.getMessage($(c).attr("id"))});$(".need_l18n_placeholder").each(function(b,c){});$(".need_l18n_style").each(function(b,c){if(chrome.i18n.getMessage($(c).attr("id")+
"_styles")){var f=chrome.i18n.getMessage($(c).attr("id")+"_styles").split(";");for(b in f){var e=f[b].replace(/(^\s*)|(\s*$)/g,"").split(":");1<e.length&&(c.style[e[0]]=e[1])}}})};function STWSOperation(b){this.onClose=this.onError=this.onMessage=this.onOpen=null;this.owner=b}var websocketTimeout=3E4,websockets=[],wstimeout=0;function clearWSTimeout(b){var c=websockets.length;if(b)for(var f=0;f<c;f++)if(websockets[f]==b){websockets.splice(f,1);break}}
function checkWSTimeout(b){var c=websockets.length,f=!1;if(b){for(var e=0;e<c;e++)if(websockets[e]==b){f=!0;break}f||websockets.splice(-1,-1,b)}b=(new Date).getTime();c=websockets.length;for(e=c-1;0<=e;e--)b-websockets[e].last_time>websocketTimeout&&websockets[e].errorHandler&&(websockets[e].errorHandler("Connect timeout!"),websockets.splice(e,1),e--);0<wstimeout&&(clearTimeout(wstimeout),wstimeout=0);0<websockets.length&&(wstimeout=setTimeout(checkWSTimeout,1E3))}
function STWebsocket(b,c,f){this.host="";this.port="443";this.protocol="http:";this.last_time=0;this.sub_protocol=f;this.operation=c;this.sessioncode=this.nickname="";this.serverinfo={};this.owner=this.closeHandler=this.errorHandler=this.messageHandler=this.openHandler=this.socket=null;this.autoConnect=!1;this.connectState=-1;this.setAutoConnect=function(b){this.autoConnect=b};this.updateTimer=function(){this.last_time=(new Date).getTime()};this.setIP=function(b){this.host=b};this.setIP=function(b){this.port=
b};this.setProt=function(b){this.protocol=b};this.setname=function(b){this.nickname=b};this.setAddr=function(b){if(b&&(b=b.split("?")[0])){var c=b.split("//");c&&1<c.length?(this.protocol=c[0],b=c[1]):this.protocol="http:";c=b.split(":");this.host=c[0];1<c.length&&(this.port=c[1])}};this.clearSocket=function(){clearWSTimeout(this)};this.getWebsocket=function(){return this.socket};this.send=function(b){this.socket&&1==this.socket.readyState&&0==this.connectState?this.socket.send(b):log&&log.debug("Cannot send msg with the state: "+
this.socket.readyState)};this.close=function(){(this.socket&&0==this.socket.readyState||1==this.socket.readyState)&&this.socket.close()};this.setOpenHandler=function(b){this.openHandler=b};this.setMessageHandler=function(b){this.messageHandler=b};this.setErrorHandler=function(b){this.errorHandler=b};this.setCloseHandler=function(b){this.closeHandler=b};this.getState=function(){return this.socket?this.socket.readyState:-1};this.setOperation=function(b){b&&b instanceof STWSOperation&&(b.onOpen&&this.setOpenHandler(b.onOpen),
b.onMessage&&this.setMessageHandler(b.onMessage),b.onClose&&this.setCloseHandler(b.onClose),b.onError&&this.setErrorHandler(b.onError),b.owner&&(this.owner=b.owner))};this.setBinaryType=function(b){this.socket&&(this.socket.binaryType="arraybuffer")};this.connect=function(b,c){this.connectState=1;this.setAddr(b);this.setOperation(c);if(""==this.host)errH&&errH("Please specify the address!");else try{if(!this.socket||2==this.socket.readyState||3==this.socket.readyState)try{var f=("https:"==this.protocol||
"wss:"==this.protocol?"wss:":"ws:")+"//"+this.host+":"+this.port,a="MozWebSocket"in window?MozWebSocket:WebSocket;log&&log.debug("Connect WebSocket: "+f);this.sub_protocol?(log&&log.debug("sub_protocol: "+this.sub_protocol),this.socket=new a(f,this.sub_protocol)):this.socket=new a(f);this.socket.owner=this;this.socket.binaryType="arraybuffer";this.updateTimer()}catch(l){}this.socket.onopen=function(a){this.owner&&this.owner.openHandler&&(this.owner.connectState=0);this.owner.updateTimer();checkWSTimeout(this.owner);
this.owner.openHandler(a,this.owner.owner)};this.socket.onmessage=function(a){clearWSTimeout(this.owner);this.owner&&this.owner.messageHandler&&this.owner.updateTimer();this.owner.messageHandler(a,this.owner.owner)};this.socket.onerror=function(a){try{clearWSTimeout(this.owner),this.owner&&(this.owner.connectState=-2),this.owner&&this.owner.errorHandler&&this.owner.errorHandler(a,this.owner.owner)}catch(b){log&&log.error("Connect socket error:"+b),this.owner&&this.owner.errorHandler&&this.owner.errorHandler(a,
this.owner.owner)}};this.socket.onclose=function(a){try{clearWSTimeout(this.owner),this.owner&&(this.owner.connectState=-1),this.owner&&this.owner.closeHandler&&this.owner.closeHandler(a,this.owner.owner)}catch(b){log&&log.error("Connect socket close:"+b),this.owner&&this.owner.closeHandler&&this.owner.closeHandler(a,this.owner.owner)}}}catch(s){log&&log.debug("<p> Error"+s)}};this.setOperation(c);this.setAddr(b)};var listMirrorID=null,listMirrorFav=null,listMirrorAuto=null,mir_desk=null,mir_tab=null,mir_tab_id=0,CurrentSelect=1,wbs=null,oem=null,feature={};chrome.windows.getCurrent(null,function(b){b&&chrome.tabs.query({active:!0},function(c){if(c)for(var f=0;f<c.length;f++)c[f].windowId==b.id&&(mir_tab_id=c[f].id)})});window.getMirrorID=function(b){chrome.runtime.sendMessage({id:"getMirID"},function(c){c&&"getMirID"==c.id&&b&&b(c.value)})};
window.connectSpecifiedServer=function(b){chrome.runtime.sendMessage({id:"connectSpecifiedServer",value:b,sel:getCurrentSelect(),mir_tab_id:mir_tab_id},function(b){})};window.setCurrentSelect=function(b){CurrentSelect=b;storageSet("CaptureCurrentSelect",b)};window.getCurrentSelect=function(){return CurrentSelect=storageGet("CaptureCurrentSelect")};
window.connectServer=function(b){var c="session=",c={id:"shareTo",name:b.name,code:b.scode,sel:getCurrentSelect(),mir_tab_id:mir_tab_id};b.wbs&&(c.wbs=b.wbs);chrome.runtime.sendMessage(c,function(b){window.close()})};
window.disconnectServer=function(b){b&&"undefined"!=typeof b.scode&&chrome.runtime.sendMessage({id:"disconnectServer",code:b.scode},function(b){try{log&&log.debug("disconnectServer: "+JSON.stringify(b))}catch(f){}b&&"disconnectServer"==b.id&&0==b.code&&(feature.fav&&listMirrorFav.setConnected(0),feature.auto&&listMirrorAuto.setConnected(0))})};window.loadFavorities=function(b){chrome.runtime.sendMessage({id:"getFavList"},function(c){c&&c.list&&b&&b(c.list)})};
var resetPage=function(){var b=document.getElementById("main_page");b&&(b.style.height="100%")};
window.onload=function(){function b(a,b){log&&log.debug("Send msg:"+JSON.stringify(a));chrome.runtime.sendMessage(a,function(a){if(a&&b)b(a),a&&a.id&&window.requestCommandList[a.id]&&window.requestCommandList[a.id].pop();else{var c=function(){window.interval&&(clearTimeout(window.interval),window.interval=0);var a=(new Date).getTime(),b;for(b in window.requestCommandList){var h=window.requestCommandList[b];0<h.length&&a-h[h.length-1].time>window.commandTimeout&&((h=window.requestCommandList[b].pop())&&
h.cb?h.cb(-2):log&&log.info("Timeout, the api no response!"))}chrome.runtime.sendMessage({id:"getCommandResult"},function(a){if(-2==a)log&&log.debug("getCommandResult, res: "+a),window.receivedServerList&&g(window.receivedServerList);else if(-3==a)log&&log.error("getCommandResult error, res: "+a),onConnectError();else if(window.interval=setTimeout(c,window.commandPollTime),a&&a.id&&window.requestCommandList[a.id]){log&&log.debug("Get the command result: "+JSON.stringify(a));var b=window.requestCommandList[a.id].pop();
b&&b.cb?(log&&log.debug("call callback"),b.cb(a)):n(a)}else n(a)})};window.interval=setTimeout(c,window.commandPollTime)}});var c={time:(new Date).getTime(),msg:a,cb:b};window.requestCommandList[a.id]=window.requestCommandList[a.id]||[];window.requestCommandList[a.id].push(c)}function c(a){if(listMirrorFav&&(chrome.runtime.sendMessage({id:"removeFromFav",scode:a.scode},function(a){}),listMirrorFav.removeItem(a),feature.auto&&listMirrorAuto&&listMirrorAuto.onRemoveItem))listMirrorAuto.onRemoveItem(a)}
function f(a){listMirrorFav||(listMirrorFav=new STList({titleValue:chrome.i18n.getMessage("msgFavorites"),type:"normal"},r,{onconnect:connectServer,onremovefav:c,ondisconnect:disconnectServer}));connectedCode&&listMirrorFav.setConnected(connectedCode);for(var b in a)0==b.indexOf("idx_")&&listMirrorFav.addItem(a[b]);feature.fav&&listMirrorFav.show()}function e(){listMirrorFav||loadFavorities(function(a){f(a)})}function d(a){var b={id:"addSpecToFav",type:"normal",scode:a.scode,name:a.name},c=feature.auto&&
listMirrorAuto?listMirrorAuto.getItem(a.scode):null;"undefined"!=typeof c&&(b.name=c.name,"undefined"!=typeof c.wbs&&(b.wbs=c.wbs,a.wbs=c.wbs));chrome.runtime.sendMessage(b,function(a){});listMirrorFav?(listMirrorFav.addItem(a),listMirrorFav.show()):e()}function g(a){log&&log.debug("slist:"+JSON.stringify(a));feature.auto&&(listMirrorAuto||(listMirrorAuto=new STList({titleValue:chrome.i18n.getMessage("msgAutoDiscovered")},r,{onconnect:connectServer,onaddfav:d,onremovefav:c,ondisconnect:disconnectServer},
listMirrorFav)),connectedCode&&listMirrorAuto.setConnected(connectedCode),a&&0<a.length&&(loadFavorities(function(a){f(a)}),a.forEach(function(a){if(a.scode==window.receiverSessionid)return!0;var b=null;try{b=decodeURIComponent(a.name)}catch(c){b=a.name}if(!b||""==b||""==b.replace(/(^\s*)|(\s*$)/g,""))if("undefined"!=typeof a.scode&&0!=a.scode)b=a.scode;else return log&&log.error("Invalid user name: ["+b+"]"),!0;b={type:"normal",name:b,scode:a.scode};a.wbs&&(b.wbs=a.wbs);listMirrorAuto.addItem(b)}),
listMirrorAuto.show()));resetPage()}storageInit();var a=null,l=0,s=null;mir_desk=document.getElementById("mir_desk");mir_tab=document.getElementById("mir_tab");2==getCurrentSelect()?(mir_desk.style.backgroundImage="url(../image/mir_dsk_d.png)",mir_tab.style.backgroundImage="url(../image/mir_tab_e.png)",mir_desk.style.color="#00a4d9",mir_tab.style.color="#FFFFFF"):(mir_desk.style.backgroundImage="url(../image/mir_dsk_e.png)",mir_tab.style.backgroundImage="url(../image/mir_tab_d.png)",mir_desk.style.color=
"#FFFFFF",mir_tab.style.color="#00a4d9");mir_desk.onclick=function(){setCurrentSelect(1);mir_desk.style.backgroundImage="url(../image/mir_dsk_e.png)";mir_tab.style.backgroundImage="url(../image/mir_tab_d.png)";mir_desk.style.color="#FFFFFF";mir_tab.style.color="#00a4d9"};mir_tab.onclick=function(){setCurrentSelect(2);mir_desk.style.backgroundImage="url(../image/mir_dsk_d.png)";mir_tab.style.backgroundImage="url(../image/mir_tab_e.png)";mir_desk.style.color="#00a4d9";mir_tab.style.color="#FFFFFF"};
chrome.runtime.sendMessage({id:"debug"},function(b){b&&0!=b&&-1!=b&&(log&&log.setLogLevel("debug"),a=b)});chrome.runtime.sendMessage({id:"oem"},function(a){a&&0!=a&&(oem=a)});chrome.runtime.sendMessage({id:"wbs"},function(a){a&&0!=a&&-1!=a&&(wbs=a)});chrome.runtime.sendMessage({id:"capturetab"},function(a){a&&0!=a&&-1!=a&&(l=a)});chrome.runtime.sendMessage({id:"backend"},function(a){a&&0!=a&&-1!=a&&(s=a)});var q=location.href+"/receiverSessionid";l18n.dotranslation();window.requestCommandList=window.requestCommandList||
{};window.interval=0;window.commandPollTime=300;window.commandTimeout=3E4;window.connectedCode=0;window.selfRecieved=!1;window.receiverSessionid=storageGet(q);var m=document.getElementById("img_help");m&&(m.onclick=function(){var b="/options.html";wbs&&wbs!=singal_server_addr?(b+="?wbs="+wbs,1==a&&(b+="&debug=1")):1==a&&(b+="?debug=1");1==l&&(b=0<b.indexOf("?")?b+"&":b+"?",b+="capturetab=1");s&&(b=0<b.indexOf("?")?b+"&":b+"?",b+="backend="+s);oem&&oem!=window.config_oem&&(b=0<b.indexOf("?")?b+"&":
b+"?",b+="oem="+oem);window.open(b)},resetPage());var n=function(a){if(!(0>a))try{a&&a.id&&"getlist"==a.id?g(a.ack):"getConnectedCode"==a.id&&(window.connectedCode=a)}catch(b){}};M360API={setWSAddress:function(){},getFeature:function(){b({id:"getfeature"},function(a){if(0>a)log&&log.info("get feature Timeout!!");else if(a&&a.features){a=a.features;for(var b in a)feature[b]=a[b];feature.fav&&listMirrorFav&&f({});feature.auto&&listMirrorAuto&&listMirrorAuto.show();feature.mid&&listMirrorID&&listMirrorID.show()}})},
getlist:function(){window.receivedServerList=null;b({id:"getlist"},function(a){log&&log.debug("getlist, res: "+JSON.stringify(a));-2==a?log&&log.info("Timeout!!"):a&&a.id&&(selfRecieved?g(a.ack):window.receivedServerList=a.ack)})},getsessionid:function(){b({id:"getsessionid"},function(a){selfRecieved=!0;0>a?log&&log.error("getsessionid Error!!"):!a||!a.sessionid||""==a.sessionid||window.receiverSessionid&&""!=window.receiverSessionid&&window.receiverSessionid==a.sessionid||(window.receiverSessionid=
a.sessionid,storageSet(q,a.sessionid));window.receivedServerList&&g(window.receivedServerList)})},getConnectedCode:function(){chrome.runtime.sendMessage({id:"connected"},function(a){log&&log.debug("Connected code: "+a);window.connectedCode=a;listMirrorFav&&listMirrorFav.setConnected(connectedCode);feature.auto&&listMirrorAuto&&listMirrorAuto.setConnected(connectedCode)})},addSpecToFav:function(){b({id:"addSpecToFav"},function(a){a&&a.scode&&a.name&&(listMirrorFav&&listMirrorFav.setConnected(connectedCode),
feature.auto&&listMirrorAuto&&listMirrorAuto.setConnected(connectedCode))})}};window.onConnectError=function(){};var r=document.getElementById("ServerListPage");listMirrorID||(m={titleValue:chrome.i18n.getMessage("msgMirroringId"),type:"specify",mid:"",attr:{mouseclick:!1}},listMirrorID=new STList(m,r,{onconnect:connectSpecifiedServer}));getMirrorID(function(a){listMirrorID.setSpecifySession(a);feature.mid&&listMirrorID.show();e()});M360API.getFeature();if(m=document.getElementById("main_page"))m.style.display=
"block"};var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;function trace(b){"\n"==b[b.length-1]&&(b=b.substring(0,b.length-1));log&&log.debug((performance.now()/1E3).toFixed(3)+": "+b)}
navigator.mozGetUserMedia?(log&&log.debug("This appears to be Firefox"),webrtcDetectedBrowser="firefox",RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),createIceServer=function(b,c,f){return{url:b,credential:f,username:c}},attachMediaStream=function(b,c){log&&log.debug("Attaching media stream");b.mozSrcObject=c;b.play()},reattachMediaStream=function(b,c){log&&log.debug("Reattaching media stream");
b.mozSrcObject=c.mozSrcObject;b.play()},MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]}):navigator.webkitGetUserMedia?(log&&log.debug("This appears to be Chrome"),webrtcDetectedBrowser="chrome",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]),createIceServer=28>webrtcDetectedVersion?function(b,c,f){return{url:"turn:"+c+"@"+b,credential:f}}:function(b,c,f){return{url:b,credential:f,username:c}},
RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(b,c){"undefined"!==typeof b.srcObject?b.srcObject=c:"undefined"!==typeof b.mozSrcObject?b.mozSrcObject=c:"undefined"!==typeof b.src?b.src=URL.createObjectURL(c):log&&log.debug("Error attaching stream to element.")},reattachMediaStream=function(b,c){b.src=c.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},
webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):log&&log.info("Browser does not appear to be WebRTC-capable");function PeerConnection(b,c,f,e,d){this.connection=b;this.index=c;this.guest=f;this.localStream=e;this.remoteIndex=d;this.started=!1;this.singleChannel=this.remoteVideo=this.pc=null;this.sessionid=1;this.channelReady=!1;this.remoteRes=null;var g=this;this.iceConfig=null;var a={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},l={iceServers:[{url:"turn:turn.relay.splashtop.com:443",credential:"1234",username:"eric"}]},s={optional:[{DtlsSrtpKeyAgreement:!0},{googDscp:!0}]},q={optional:[],mandatory:{}};
this.doCandidateMsg=function(a){log&&log.info("doCandidateMsg");a=new RTCIceCandidate({sdpMLineIndex:a.label,candidate:a.candidate});g.pc.addIceCandidate(a,v,x)};this.setIceConfig=function(a){a&&(g.iceConfig={iceServers:a})};this.doSessionMsg=function(a){log&&log.info("doSessionMsg, guest: "+this.guest);this.guest&&m()};this.setResolution=function(a){a&&(g.remoteRes=a)};this.doOfferMsg=function(b){log&&log.info("doOfferMsg");g.guest||m();g.pc.setRemoteDescription(new RTCSessionDescription(b));log&&
log.info("Sending answer to peer.");50<=parseFloat(getAppVersion())?g.pc.createAnswer(r,n,a):g.pc.createAnswer(r,null,a)};this.doAnswerMsg=function(a){g.pc.setRemoteDescription(new RTCSessionDescription(a))};this.doByeMsg=function(a){window.doByeMsg&&window.doByeMsg(a.index)};this.setLocalStream=function(a){g.localStream=a};var m=function(){log&&log.info("maybeStart enter");if(!g.started&&(log&&log.info("Creating PeerConnection."),h(),g.localStream&&(log&&log.info("Adding local stream."),g.pc.addStream(g.localStream)),
g.started=!0,g.guest)){for(var b in a.mandatory)q.mandatory[b]=a.mandatory[b];q.optional.concat(a.optional);log&&log.info("Sending offer to peer");log&&log.debug("offer constraints: \n  '"+JSON.stringify(q)+"'.");50<=parseFloat(getAppVersion())?g.pc.createOffer(r,n,q):g.pc.createOffer(r,null,q)}},n=function(a){log&&log.info("Create error callback!")},r=function(a){log&&log.info("setLocalAndSendMessage!");a.sdp=preferOpus(a.sdp);var b=a.sdp,b=b.replace(/a=rtpmap:(\d*) rtx\/(\d*)(\r\n)?/g,""),b=b.replace(/a=fmtp:(\d*) apt=(\d*)(\r\n)?/g,
"");a.sdp=b;b={sdp:a.sdp,type:a.type};g.remoteRes&&(b.res=g.remoteRes);g.pc.setLocalDescription(a);u(b)},h=function(){try{var a=l;g.iceConfig&&(a=g.iceConfig);50<=parseFloat(getAppVersion())?g.pc=new RTCPeerConnection(a):g.pc=new RTCPeerConnection(a,s);g.pc.onicecandidate=function(a){a.candidate?u({type:"candidate",label:a.candidate.sdpMLineIndex,id:a.candidate.sdpMid,candidate:a.candidate.candidate}):log&&log.info("End of candidates.")};log&&log.info("Created RTCPeerConnnection");log&&log.debug("New RTCPeerConnnection with:\n  config: '"+
JSON.stringify(a)+"';\n  constraints: '"+JSON.stringify(s)+"'.")}catch(b){log&&log.error("Failed to create PeerConnection, exception: "+b.message);return}g.pc.onaddstream=function(a){log&&log.info("Remote stream added.");if(window.onAddStream)window.onAddStream(g.remoteIndex,g.remoteRes,a)};g.pc.oniceconnectionstatechange=function(a){if(a&&a.target)switch(a.target.iceConnectionState){case "failed":if(window.onStreamFailed)window.onStreamFailed();break;case "disconnected":g.pc&&g.pc.close&&g.pc.close();
case "closed":if(window.onSessionDisconnected)window.onSessionDisconnected(g.remoteIndex);break;case "connected":case "completed":if(window.onStreamConnect)window.onStreamConnect(!0)}};g.pc.oniceconnectionchange=function(a){};g.pc.onremovestream=onRemoteStreamRemoved},u=function(a){a={id:"forward",type:"webrtc/"+wbsserver_api_version,data:a};a.index=g.index;0!=g.remoteIndex&&(a.toIndex=g.remoteIndex);a=JSON.stringify(a);log&&log.debug("onSignalingMessage "+a);g.connection?g.connection.send(a):window.opener&&
window.opener.sendWSMsg?window.opener.sendWSMsg(a):log&&log.info("Has no the send ws message handler!")};this.onHangup=function(){log&&log.info("Hanging up.");if(g.localStream)try{g.localStream.getVideoTracks()[0].stop(),"function"==typeof g.localStream.stop&&g.localStream.stop(),g.localStream=null}catch(a){log&&log.info("Has no stop function!")}if(g.pc)try{g.pc.close()}catch(b){log&&log.info("This pc has closed!")}};var v=function(){log&&log.info("Romote candidate added successfully!")},x=function(a){log&&
log.info("Remote candidate error: "+a.toString())};onSessionConnecting=function(a){log&&log.info("Session connecting.")};onSessionOpened=function(a){log&&log.info("Session opened.");f&&m()};onRemoteStreamRemoved=function(a){log&&log.info("Remote stream removed.")};preferOpus=function(a){for(var b=a.split("\r\n"),c=null,d=0;d<b.length;d++)b[d]=b[d].replace(/UDP\/TLS\//g,"");for(d=0;d<b.length;d++)if(-1!==b[d].search("m=audio")){c=d;break}if(null===c)return a;for(d=0;d<b.length;d++)if(-1!==b[d].search("opus/48000")){(a=
extractSdp(b[d],/:(\d+) opus\/48000/i))&&(b[c]=setDefaultCodec(b[c],a));break}b=removeCN(b,c);return a=b.join("\r\n")};extractSdp=function(a,b){var c=a.match(b);return c&&2==c.length?c[1]:null};setDefaultCodec=function(a,b){for(var c=a.split(" "),d=[],f=0,h=0;h<c.length;h++)3===f&&(d[f++]=b),c[h]!==b&&(d[f++]=c[h]);return d.join(" ")};removeCN=function(a,b){for(var c=a[b].split(" "),d=a.length-1;0<=d;d--){var f=extractSdp(a[d],/a=rtpmap:(\d+) CN\/\d+/i);f&&(f=c.indexOf(f),-1!==f&&c.splice(f,1),a.splice(d,
1))}a[b]=c.join(" ");return a}};function getTop(b){var c=b.offsetTop;null!=b.offsetParent&&(c+=getTop(b.offsetParent));return c}function getLeft(b){var c=b.offsetLeft;null!=b.offsetParent&&(c+=getLeft(b.offsetParent));return c}
function STList(b,c,f,e){this.listProp=b;this.name=b.titleValue;this.attrs=b.attr;this.owner=c;this.height=24;this.width=c.offsetWidth-24;this.page=null;this.lHide=!0;this.itemSpecify=this.listTitle=this.listItem=this.cntnt=this.icon=this.list=null;this.items={};this.btnRemFav=this.btnAddFav=this.btnSpecify=this.btnGo=null;this.callbacks=f;this.favList=e;this.timeHideBtn=0;this.maxShowItemCount=5;this.connSessionid=0;this.touchStartItem=null;var d=this;this.setMaxShowItems=function(a){this.maxShowItemCount=
a};this.setConnected=function(a){0==a&&0!=this.connSessionid&&"undefined"!=typeof d.items["idx_"+this.connSessionid]?(d.items["idx_"+this.connSessionid].btnFav&&(d.favList?d.favList.isInList(this.connSessionid)?d.items["idx_"+this.connSessionid].btnFav.src="image/hs.png":d.items["idx_"+this.connSessionid].btnFav.src="image/hp.png":d.items["idx_"+this.connSessionid].btnFav.src="image/hs.png"),d.items["idx_"+this.connSessionid].label.style.color="black",d.items["idx_"+this.connSessionid].icon.src="image/user_off.png",
d.items["idx_"+this.connSessionid].btnGo.style.display="none"):d.items&&d.items["idx_"+a]&&d.items["idx_"+a].btnFav&&(d.favList?d.favList.isInList(a)?d.items["idx_"+a].btnFav.src="image/hc.png":d.items["idx_"+a].btnFav.src="image/hcp.png":d.items["idx_"+a].btnFav.src="image/hc.png",d.items["idx_"+a].label.style.color="#00a4d9",d.items["idx_"+a].icon.src="image/user_on.png",d.items["idx_"+a].btnGo.style.display="block");this.connSessionid=a};this.isInList=function(a){return d.items["idx_"+a]?!0:!1};
this.updateItem=function(a){d.items["idx_"+a.scode]&&(g(a,d.items["idx_"+a.scode]),d.items["idx_"+a.scode].label&&(d.items["idx_"+a.scode].label.innerText=a.name))};this._s_h_list=function(){d.lHide?(d.lHide=!1,d.icon.src="image/r.png",d.list&&(d.list.style.display="none"),d.btnGo&&(d.btnGo.style.display="none")):(d.lHide=!0,d.icon.src="image/b.png",d.list&&(d.list.style.display="block"))};this._create=function(){this.page||(this.page=document.createElement("dt"),this.owner&&this.owner.appendChild(this.page),
this.page.style.display="none",this.listTitle=document.createElement("div"),this.page.appendChild(this.listTitle),this.listTitle.setAttribute("class","list_title"),this.icon=new Image,this.icon.src="image/r.png",this.icon.setAttribute("class","list_title_icon"),this.page.setAttribute("class","list_page"),this.listTitle.appendChild(this.icon),this.displayName=document.createElement("label"),this.displayName.setAttribute("class","list_title_name"),this.displayName.innerText=this.name,this.listTitle.appendChild(this.displayName),
"specify"==this.listProp.type&&(this.itemSpecify=document.createElement("input"),this.itemSpecify.setAttribute("class","list_title_input"),this.itemSpecify.setAttribute("type","text"),this.itemSpecify.value=this.listProp.mid?this.listProp.mid:"",d.listTitle.appendChild(this.itemSpecify),this.itemSpecify.onkeydown=function(a){if(a&&13==a.keyCode){if(!this.value)return this.focus(),!1;if(d.callbacks&&d.callbacks.onconnect)d.callbacks.onconnect(this.value)}},this.btnSpecify=new Image,this.btnSpecify.src=
"image/g.png",this.btnSpecify.setAttribute("class","list_title_connect"),d.listTitle.appendChild(this.btnSpecify),d.btnSpecify&&(d.btnSpecify.onclick=function(){if(!d.itemSpecify.value)return d.itemSpecify.focus(),!1;if(d.callbacks&&d.callbacks.onconnect)d.callbacks.onconnect(d.itemSpecify.value)})),this.attrs&&"undefined"!=typeof this.attrs.mouseclick&&!0!=this.attrs.mouseclick||(this.icon.src="image/b.png",this.icon.onclick=function(){d._s_h_list()},this.displayName.onclick=function(){d._s_h_list()}))};
this.setSpecifySession=function(a){this.itemSpecify&&(this.itemSpecify.value=a)};this.show=function(){this._create();this.page&&(this.page.style.display="block")};var g=function(a,b){for(var c in a)b[c]=a[c]};this.removeItem=function(a){if(a&&d.items&&a.scode&&"undefined"!=typeof d.items["idx_"+a.scode])try{d.cntnt.removeChild(d.items["idx_"+a.scode].label.parentElement.parentElement.parentElement),d._refreshScroll(),delete d.items["idx_"+a.scode]}catch(b){}};this.onRemoveItem=function(a){if(a&&d.items&&
a.scode&&"undefined"!=typeof d.items["idx_"+a.scode])try{var b=d.items["idx_"+a.scode].label.parentElement.parentElement.parentElement.btnFav;b&&(b.src=a.scode==d.connSessionid?"image/hcp.png":"image/hp.png")}catch(c){}};this._refreshScroll=function(){d.cntnt.childElementCount>d.maxShowItemCount?d.list.setAttribute("class","list_content_scroll"):d.list.setAttribute("class","list_content_no_scroll")};this.create=function(){this._create()};this.getItem=function(a){return this.items["idx_"+a]};this.addItem=
function(a){if(a)if(d._create(),d.list||(d.list=document.createElement("dd"),d.page.appendChild(d.list)),d.cntnt||(d.cntnt=document.createElement("div"),d.list.appendChild(d.cntnt),d.cntnt.setAttribute("class","list_content")),"specify"==a.type)log&&log.info("Please call setSpecifySession");else if("normal"==a.type)if(d.items["idx_"+a.scode])g(a,d.items["idx_"+a.scode]),d.items["idx_"+a.scode].label&&(d.items["idx_"+a.scode].label.innerText=a.name);else{d.items["idx_"+a.scode]={};g(a,d.items["idx_"+
a.scode]);var b=document.createElement("div");b.setAttribute("class","list_item");d.cntnt.appendChild(b);var c=document.createElement("div");c.setAttribute("class","list_iten_content");b.appendChild(c);b.server=c;var f=document.createElement("div");f.setAttribute("class","list_item_event_area");c.appendChild(f);f.server=c;var e=new Image;d.items["idx_"+a.scode].icon=e;e.src=a.scode==d.connSessionid?"image/user_on.png":"image/user_off.png";e.setAttribute("class","list_item_icon");f.appendChild(e);
e=document.createElement("label");e.setAttribute("class","list_item_name");d.items["idx_"+a.scode].label=e;e.innerText=a.name;a.scode==d.connSessionid&&(e.style.color="#00a4d9");c.name=a.name;c.scode=a.scode;a.wbs&&(c.wbs=a.wbs);"undefined"!=typeof a.specifiedcode&&(c.specifiedcode=a.specifiedcode);f.appendChild(e);b.btnGo=new Image;b.btnGo.src="image/c.png";a.scode!=d.connSessionid&&(b.btnGo.style.display="none");d.items["idx_"+a.scode].btnGo=b.btnGo;b.btnGo.setAttribute("class","list_item_img_connect");
b.btnGo.style.display="none";b.btnGo.onclick=function(a){if(d.callbacks&&d.callbacks.ondisconnect)d.callbacks.ondisconnect(this.parentElement)};c.appendChild(b.btnGo);d.callbacks&&(d.callbacks.onaddfav||d.callbacks.onremovefav)&&(b.btnFav=new Image,d.items["idx_"+a.scode].btnFav=b.btnFav,c.scode==d.connSessionid?d.favList?d.favList.isInList(a.scode)?b.btnFav.src="image/hc.png":b.btnFav.src="image/hcp.png":b.btnFav.src="image/hc.png":d.favList?d.favList.isInList(a.scode)?b.btnFav.src="image/hs.png":
b.btnFav.src="image/hp.png":b.btnFav.src="image/hs.png",b.btnFav.setAttribute("class","list_item_img_favorite"),b.btnFav.style.display="none",c.appendChild(b.btnFav));f.onclick=function(a){d.callbacks&&d.callbacks.onconnect&&(log&&log.info("Connect to: "+this.server.scode+":("+this.server.name+")"),a={name:this.server.name,scode:this.server.scode},this.server.wbs&&(a.wbs=this.server.wbs),this.server.specifiedcode&&(a.specifiedcode=this.server.specifiedcode),d.callbacks.onconnect(a))};b.ontouchstart=
function(a){d.touchStartItem&&d.touchStartItem!=this&&(d.touchStartItem.onmouseout(a),d.touchStartItem=null);this.onmouseover(a);d.touchStartItem=this};b.onmouseover=function(a){this.btnGo&&this.server.scode==d.connSessionid&&(this.btnGo.style.display="block");this.btnFav&&(this.btnFav.style.display="block",this.btnFav.onclick=function(a){if(d.favList)d.favList.isInList(this.parentElement.scode)?d.callbacks&&d.callbacks.onremovefav&&(log&&log.info("Remove server from favorities: "+this.parentElement.scode+
":("+this.parentElement.name+")"),d.callbacks.onremovefav({type:"normal",name:this.parentElement.name,scode:this.parentElement.scode})):d.callbacks&&d.callbacks.onaddfav&&(log&&log.info("Add server to favorities: "+this.parentElement.scode+":("+this.parentElement.name+")"),d.callbacks.onaddfav({type:"normal",name:this.parentElement.name,scode:this.parentElement.scode}),this.src=this.parentElement.scode==d.connSessionid?"image/hc.png":"image/hs.png");else if(d.callbacks&&d.callbacks.onremovefav){log&&
log.info("Remove server from favorities: "+this.parentElement.scode+":("+this.parentElement.name+")");d.callbacks.onremovefav({type:"normal",name:this.parentElement.name,scode:this.parentElement.scode});try{d.cntnt.hasChildNodes(this.parentElement.parentElement)&&d.cntnt.removeChild(this.parentElement.parentElement)}catch(b){log&&log.info("Remove child node error?"+b)}d._refreshScroll();delete d.items["idx_"+this.parentElement.scode]}return!1})};b.onmouseout=function(){this.btnGo&&(this.btnGo.style.display=
"none");this.btnFav&&(this.btnFav.style.display="none")};d._refreshScroll()}else log&&log.info("Not supported list type: "+a.type)};this._create()};function SingalChannel(b,c,f,e,d,g){this.clientIndex=0;this.urlPars=parseUrl(null,!0)||{};this.sessioncode=f||this.urlPars.session;this.ws=c||this.urlPars.ws||singal_server_addr||"wss://wbs.relay.splashtop.com:443";this.username=encodeURIComponent(e);this.webrtcSocket=null;this.callback=g;this.needSecurity=d;this.secCode=null;this.guest=!1;this.hosts=null;this.authed={};this.pc=null;window.log=window.log||log4splashtop.getLogger();this.bNum=0;this.supportN2N=this.needUpdate=!1;this.lastRecv=this.lastSend=
this.updateTimeout=this.timeout=0;this.defaultTimeout=3E4;this.iceConfig=null;this.remoteIndex=0;this.sessionWindow=null;this.candidateMsgs=[];this.M360MeetingCode=(this.licensekey=this.accountInfo=null,null);this.autoDiscovery=0;this.destroyed=this.forceRefresh=!1;this.oem=this.urlPars.oem||(window.config_oem?window.config_oem:"splashtop");this.remoteRes=null;this.redirectToWbs=!1;this.redirectWBS=null;this.isRetry=!0;var a=this;a.getRedirectWBS=function(){return a.redirectWBS};this.setAccountInfo=
function(b){a.accountInfo=b;a.autoDiscovery=b.autoDiscovery?1:0;a.webrtcSocket&&m()};this.setLocalStream=function(b){a.pc&&a.pc.setLocalStream&&a.pc.setLocalStream(b)};this.setForceRefresh=function(b){log&&log.debug("setForceRefresh: "+b);a.forceRefresh=b};this.getLicenseKey=function(){return slef.licensekey};this.close=function(){if(a.pc&&a.pc.onHangup)a.pc.onHangup();this.destroyed=!0;a.sessionWindow&&(a.sessionWindow.close(),a.sessionWindow=null);if(a.webrtcSocket)try{a.webrtcSocket.setOpenHandler(null),
a.webrtcSocket.setMessageHandler(null),a.webrtcSocket.setErrorHandler(null),a.webrtcSocket.setCloseHandler(null),a.webrtcSocket.close()}catch(b){}0<a.updateTimeout&&clearTimeout(a.updateTimeout);0<a.timeout&&clearTimeout(a.timeout)};this._clearTimeout=function(){0<a.timeout&&(clearTimeout(a.timeout),log&&log.debug("ClearTimeout"),a.timeout=0)};this.getsessionid=function(){return storageGet("M360MeetingCode")};this._setTimeout=function(){a._clearTimeout();a.timeout=setTimeout(l,a.defaultTimeout);log&&
log.debug("SetTimeout")};var l=function(){a._clearTimeout();if(0==a.lastSend||a.lastRecv>a.lastSend&&a.lastRecv-a.lastSend<a.defaultTimeout){var b;b={id:"heartbeat",type:"webrtc/"+wbsserver_api_version};a.guest&&(b.id="forward",b.index=a.clientIndex,b.data={type:"heartbeat"});a._sendMessage(b);a.lastSend=(new Date).getTime()}else if(log&&log.error("Heartbeat Timeout"),a.close(),window.onConnectError){window.onConnectError();return}a._setTimeout()};this.sendMessage=function(b){a._sendMessage(b)};this._sendMessage=
function(b){if("string"!=typeof b)try{b=JSON.stringify(b)}catch(c){}log&&log.debug("send msg: "+b);a.webrtcSocket.send(b)};this.reset=function(){a.bNum=0;a.remoteIndex=0;a.authed={};a.sessionWindow&&(a.sessionWindow.close(),a.sessionWindow=null)};this.setNeedSecurity=function(b){log&&log.debug("setNeedSecurity: "+b);a.needSecurity=b};this.setAutoDiscovery=function(b){a.autoDiscovery=b?1:0;a.webrtcSocket&&m()};this.setSecurity=function(b){log&&log.debug("setSecurity+");a.secCode=b;a.webrtcSocket&&
0!=a.clientIndex&&(b={id:"forward",type:"webrtc/"+wbsserver_api_version,index:a.clientIndex,data:{type:"authenticate",value:a.secCode}},navigator&&navigator.userAgent&&(b.data.userAgent=navigator.userAgent),log&&log.info("request to authenticate"),a._sendMessage(b));log&&log.debug("setSecurity-")};this.getPeerConnection=function(b){return a.pc&&a.pc.remoteIndex==b?a.pc:null};this.sendByeMsg=function(b){a.webrtcSocket&&0!=a.clientIndex&&a._sendMessage({id:"forward",type:"webrtc/"+wbsserver_api_version,
index:a.clientIndex,data:{type:"bye"}})};this.checkAuth=function(b){if(a.authed[b])return a.authed[b];a._sendMessage({id:"forward",type:"webrtc/"+wbsserver_api_version,index:a.clientIndex,toIndex:b,data:{type:"bye"}});return!1};this.handleSWClose=function(){a.sendByeMsg(a.clientIndex);a.sessionWindow=null};this._startSession=function(c,d){a.remoteIndex=c;a.pc=new PeerConnection(a.webrtcSocket,a.clientIndex,!0,b,c);a.iceConfig&&a.pc.setIceConfig(a.iceConfig);var f={w:window.screen.width,h:window.screen.height};
d&&(f=d);log&&log.info("receiverRes: "+f.w+" x "+f.h);window.startCapture&&window.startCapture(f,function(b){b?(a.pc.setResolution(f),a.pc.setLocalStream(b),b&&b.getVideoTracks()[0]&&(b.getVideoTracks()[0].onended=function(){a.close()}),a.pc.doSessionMsg()):log&&log.error("startCapture failed!")})};this.doConnect=function(b){if(a.hosts&&a.hosts instanceof Array&&0<a.hosts.length){var c={id:"forward",type:"webrtc/"+wbsserver_api_version,index:a.clientIndex,data:{type:"authenticate"}};navigator&&navigator.userAgent&&
(c.data.userAgent=navigator.userAgent);if(b.security&&"1"==b.security)if(a.secCode&&""!=a.secCode)c.data.value=a.secCode;else if(log&&log.info("request security code"),window.showAuth){window.showAuth(!0);return}log&&log.info("request to authenticate");a._sendMessage(c)}else if(log&&log.error("no hosts,stop to connect"),a.close(),window.onNoHost)window.onNoHost()};var s=function(b){var c=b.data,d=b.index;switch(c.type){case "heartbeat":if(a.guest){if("undefined"==typeof b.toIndex||b.toIndex!=a.clientIndex)break;
a.lastRecv=(new Date).getTime()}else b={id:"forward",type:"webrtc/"+wbsserver_api_version,index:a.clientIndex,toIndex:d,data:{type:"heartbeat"}},a._sendMessage(b);break;case "candidate":if(!a.checkAuth(d))break;a.pc&&a.pc.doCandidateMsg?(a.pc.doCandidateMsg(c),log&&log.info("received candidate for pc")):a.sessionWindow&&a.sessionWindow.contentWindow&&a.sessionWindow.contentWindow.doCandidateMsg?(a.sessionWindow.contentWindow.doCandidateMsg(c),log&&log.info("received candidate for sw")):(a.candidateMsgs.push(c),
log&&log.info("Session window not ready!"));break;case "authenticate":if(a.guest)break;log&&log.info("received authenticate");b="nativeres";a.accountInfo&&a.accountInfo.resolution&&(b=a.accountInfo.resolution);b={id:"forward",type:"webrtc/"+wbsserver_api_version,index:a.clientIndex,toIndex:d,data:{type:"authorize",code:200,res:b,msg:"OK"}};window.localAcceptResult&&(b.data.res=window.localAcceptResult);navigator&&navigator.userAgent&&(b.data.userAgent=navigator.userAgent);var f=!1;a.needSecurity&&
""!=a.needSecurity?a.needSecurity!=c.value?(b.data.code=401,b.data.msg="Auth Failed",a.authed[d]=!1,log&&log.info("failed to authenticate")):f=!0:f=!0;if(f){if(!a.supportN2N&&0<a.bNum){for(var e in a.authed)!0==a.authed[e]&&(c={id:"forward",type:"webrtc/"+wbsserver_api_version,index:a.clientIndex,data:{type:"bye"}},0!=a.remoteIndex&&(c.toIndex=a.remoteIndex),log&&log.info("Drop old sessions"),a._sendMessage(c));a.sessionWindow&&a.sessionWindow.onClosed.removeListener(a.handleSWClose);a.reset()}log&&
log.info("authenticate success, authorize to sender");a.bNum++;a.authed[d]=!0}log&&log.info("send authorize to sender");a._sendMessage(b);break;case "authorize":e=c.code;if(200==e)a.guest&&a.hosts&&(a.authed[d]=!0,b=a.remoteRes,b||(b=c.res),log&&log.info("authorize success, start session, res: "+b),a._startSession(d,b));else if(401==e){if(log&&log.info("authorize fail: 401"),window.onAuthFailed)window.onAuthFailed()}else if(403==e||408==e){if(window.onRequestDeclined)window.onRequestDeclined()}else if(404==
e){if(log&&log.info("receriver is busy"),window.onServerBusy)window.onServerBusy()}else log&&log.error("Maybe API error! code: "+e+", msg: "+c.msg);break;case "offer":if(!a.checkAuth(d))break;if(a.pc){log&&log.error("Maybe offer error!");break}a.sessionWindow&&(a.sessionWindow.close(),a.sessionWindow=null);a.remoteIndex=d;e=768;b=1024;c.res&&(b=c.res.w,e=c.res.h);f="blank.html";d="login=auto&index="+d+"&clientIndex="+a.clientIndex+"&data="+encodeURIComponent(JSON.stringify(c));a.iceConfig&&(d+="&iceConfig="+
encodeURIComponent(JSON.stringify(a.iceConfig)));request&&1==request.debugMode&&(d+="&debugMode=1");f=f+"?key="+base64encode(encodeURIComponent(d));d=null;d=parseInt(getAppVersion());log&&log.info("Create M360 Main Window, chrome version:"+d);36>d?(d={id:"idM360SessionWindow",bounds:{width:b,height:e},hidden:!0},log&&log.info("window opt: bounds")):(d={id:"idM360SessionWindow",innerBounds:{width:b,height:e},hidden:!0},log&&log.info("window opt: innerBounds"));chrome.app.window.create(f,d,function(b){a.sessionWindow=
b;b.onClosed.addListener(a.handleSWClose);log&&log.info("Create session success!");b&&a.candidateMsgs&&b.contentWindow&&(b.contentWindow.onCreateSuccess=function(b){log&&log.info("Session window handle the saved candidates!");for(var c=0;c<a.candidateMsgs.length;c++)b(a.candidateMsgs[c]);a.candidateMsgs.length=0;a.candidateMsgs=[]})});break;case "answer":if(!a.checkAuth(d))break;if(!a.pc){log&&log.error("Maybe answer error!");break}log&&log.info("received answer");a.pc.doAnswerMsg(c);break;case "bye":log&&
log.info("received bye"),a.remoteIndex==d&&a.reset(),delete a.authed[d],a.pc&&a.pc.remoteIndex==d&&a.pc.doByeMsg(b)}},q=function(b,c){a.isRetry=!1;var d={id:"getlist",type:"webrtc/"+wbsserver_api_version,req:{product:"smx",version:clientversion,platform:getPlatformVersion(),oem:window.oem?window.oem:window.config_oem,uuid:getUUID(),name:(window.oem&&""!=window.oem?window.oem:"Sender")+"_"+parseInt(Math.random()),useragent:"smx/"+clientversion+" splashtop2 chrome "+getPlatform()}};log&&log.info("retrieveServerList!");
request.backend&&""!=request.backend&&(d.req.backend=request.backend);a._sendMessage(d)},m=function(b,c){var d=request.product?request.product:"sms";log&&log.info("Channel opened, start to send getsession");d={id:"getsession",type:"webrtc/"+wbsserver_api_version,req:{product:d,version:clientversion,platform:getPlatformVersion(),oem:a.oem,uuid:getUUID(),useragent:"smx/"+clientversion+" splashtop2 chrome "+getPlatform()}};a.accountInfo?(a.guest=!1,d.type="webrtc/"+wbsserver_api_version,d.req.discoverable=
a.autoDiscovery,a.accountInfo.computerName&&(d.req.name=encodeURIComponent(a.accountInfo.computerName)),a.sessioncode&&(d.req.value=a.sessioncode),a.needSecurity&&""!=a.needSecurity&&(d.req.security=1)):a.sessioncode&&(a.guest=!0,d.req.value=a.sessioncode);a.licensekey&&(d.req.licensekey=a.licensekey);d&&a._sendMessage(d)},n=function(b,c){log&&log.debug("recv msg: "+b.data);b=JSON.parse(b.data);a.callback&&a.callback(b);var d=b.id;""!=d&&(d=d.toLowerCase());switch(d){case "getlist":if(b&&b.ack){var d=
b.ack,f=!1,e;for(e in d)if(d[e].scode==a.sessioncode){d[e].wbs&&a.redirectWBS!=d[e].wbs?(a.redirectToWbs=!0,a.redirectWBS=d[e].wbs,a.reopenChannel(d[e].wbs)):m();f=!0;break}f||m()}else if(window.onConnectError)window.onConnectError({code:1,message:"Server Error!"});break;case "heartbeat":a.lastRecv=(new Date).getTime();break;case "getsession":e=b;d=e.ack.hosts;window.tempHosts=d;a.clientIndex=e.ack.index;e.ack.remoteIp&&log&&log.info("PublicIp: "+e.ack.remoteIp);e.ack.wbsIp&&log&&log.info("wbsIp: "+
e.ack.wbsIp);e.ack.iceServers&&(a.iceConfig=e.ack.iceServers);if(a.guest)e.ack.res&&(a.remoteRes=e.ack.res),a.hosts=d,log&&log.info("Got session, connect to receiver"),!request.name&&e.ack.name&&(request.name=encodeURIComponent(e.ack.name)),a.doConnect(e.ack);else{if(e=e.ack.value)a.sessioncode=e;log&&log.info("Got session, wait sender arrive");a.accountInfo&&(e=a.accountInfo,e={id:"getmeetingcode",type:"webrtc/"+wbsserver_api_version,req:{product:request.product?request.product:"smx",platform:getPlatformVersion(),
version:clientversion,oem:a.oem,wbssession:a.sessioncode,meetingcode:a.M360MeetingCode,name:e&&e.computerName?e.computerName:"",uuid:storageGet(location.host+"/uuid"),desc:e.mcDesc,forceRefresh:a.forceRefresh,licensekey:a.licensekey}},window.getCurrentToken&&window.getCurrentToken()&&(e.req.token=window.getCurrentToken()),a._sendMessage(e))}a._sendMessage(a.guest?{id:"forward",type:"webrtc/"+wbsserver_api_version,index:a.clientIndex,data:{type:"heartbeat"}}:{id:"heartbeat",type:"webrtc/"+wbsserver_api_version});
a.lastSend=(new Date).getTime();a._setTimeout();break;case "getmeetingcode":e=b;log&&log.info("getMC message: "+e);a.forceRefresh=!1;e&&e.ack&&200==e.ack.code&&(a.M360MeetingCode=e.ack.value,storageSet("M360MeetingCode",e.ack.value));break;case "license":e=b;if(e.ack){a.licensekey=e.ack.licensekey;if(window.onGetLicenseKey)window.onGetLicenseKey(e.ack);200==e.ack.code&&m()}break;case "getconnection":e=b;if(e.ack)if(200==e.ack.code&&e.ack.connection)if(e.ack.connection.scode&&""!=e.ack.connection.scode)if(e=
e.ack.connection,a.sessioncode=e.scode,request.getSpecSessionCode=e.scode,request.name=encodeURIComponent(e.name),a.needSecurity=e.security,e&&e.wbs){if(d=e.wbs,0>d.search(/^ws{0,2}:\/\//)&&(d="ws://"+d),a.redirectToWbs=!0,a.redirectWBS=d,a.reopenChannel(d),"function"==typeof window.onGetConnection)window.onGetConnection(e.scode)}else m();else{if(window.onConnectError)window.onConnectError({code:200,message:chrome.i18n.getMessage("msgFailed")})}else if(409==e.ack.code&&window.onConnectError)window.onConnectError({code:409,
message:chrome.i18n.getMessage("msgFailSpecID")});else{if(window.onConnectError)window.onConnectError({code:1,message:chrome.i18n.getMessage("msgFailSpecID")})}else if(window.onConnectError)window.onConnectError({code:1,message:"Server Error!"});break;case "forward":s(b)}},r=function(){console.log("dummyFunction is called!")};this.reopenChannel=function(b){if(a.webrtcSocket)try{a.webrtcSocket.setOpenHandler(r),a.webrtcSocket.setMessageHandler(r),a.webrtcSocket.setErrorHandler(r),a.webrtcSocket.setCloseHandler(r),
a.webrtcSocket.close()}catch(c){}this.ws=b;this.openChannel()};this.openChannel=function(){log&&log.info("Start openChannel");var b=function(){var b=request.product?request.product:"smx",c=storageGet(location.host+"/uuid");c||(c=genUUID(),storageSet(location.host+"/uuid",c));var d="undefined"!=typeof conf_ext_useragent?" "+conf_ext_useragent:"",b={id:"getconnection",type:"webrtc/"+wbsserver_api_version,req:{sessioncode:request.specifiedid,product:"smx",version:clientversion,platform:getPlatformVersion(),
oem:a.oem,useragent:b.toUpperCase()+"/"+clientversion+" splashtop2 chrome"+d,macaddr:"001122334455",srcuuid:c}};request.backend&&""!=request.backend&&(b.req.backend=request.backend);a._sendMessage(b)},c=function(){var b=request.product?request.product:"sms",c=storageGet(location.host+"/uuid");c||(c=genUUID(),storageSet(location.host+"/uuid",c));var d=a.accountInfo,b={id:"license",type:"webrtc/"+wbsserver_api_version,req:{platform:getPlatformVersion(),useragent:b.toUpperCase()+"/"+clientversion+" splashtop2 chrome "+
getPlatform(),version:clientversion,uuid:c,product:b,oem:a.oem,name:d&&d.computerName?d.computerName:"",license:{appid:d&&d.appid?d.appid:"",googleid:d&&d.plusid?d.plusid:"",authtoken:d&&d.token?d.token:"",licensekey:d&&d.licensekey?d.licensekey:""}}};request.backend&&""!=request.backend&&(b.req.backend=request.backend);a._sendMessage(b)};request.notbeapi&&(a.isRetry=!1);var d=new STWSOperation(this);a.accountInfo?d.onOpen=c:request&&request.specifiedid&&!a.redirectToWbs?(request.notbeapi?(a.sessioncode=
request.specifiedid,d.onOpen=m,a.redirectToWbs=!1):d.onOpen=b,a.isRetry=!1):a.isRetry?d.onOpen=q:(d.onOpen=m,a.redirectToWbs=!1);d.onMessage=n;d.onClose=function(b){log&&log.error("webrtcSocket onClose: "+b);if(window.onSessionDisconnected)window.onSessionDisconnected(a.clientIndex)};d.onError=function(a){log&&log.error("webrtcSocket error: "+a);if(window.onConnectError)window.onConnectError({code:-1,message:chrome.i18n.getMessage("msgFailConnectContent")})};a.webrtcSocket=new STWebsocket(this.ws,
d,"com.splashtop.webrtc2");0==location.href.indexOf("https:")&&a.webrtcSocket.setProt("https:");a.webrtcSocket.connect();log&&log.debug("connect to "+this.ws);return a.webrtcSocket}};
