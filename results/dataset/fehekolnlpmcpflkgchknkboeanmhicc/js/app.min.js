!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.hotkeys=e()}(this,function(){"use strict";var t="undefined"!=typeof navigator&&0<navigator.userAgent.toLowerCase().indexOf("firefox");function d(t,e,n){t.addEventListener?t.addEventListener(e,n,!1):t.attachEvent&&t.attachEvent("on"+e,function(){n(window.event)})}function l(t,e){for(var n=e.slice(0,e.length-1),i=0;i<n.length;i++)n[i]=t[n[i].toLowerCase()];return n}function c(t){t||(t="");for(var e=(t=t.replace(/\s/g,"")).split(","),n=e.lastIndexOf("");0<=n;)e[n-1]+=",",e.splice(n,1),n=e.lastIndexOf("");return e}function p(t,e){for(var n=t.length>=e.length?t:e,i=t.length>=e.length?e:t,o=!0,r=0;r<n.length;r++)-1===i.indexOf(n[r])&&(o=!1);return o}for(var e={backspace:8,tab:9,clear:12,enter:13,return:13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,delete:46,ins:45,insert:45,home:36,end:35,pageup:33,pagedown:34,capslock:20,"⇪":20,",":188,".":190,"/":191,"`":192,"-":t?173:189,"=":t?61:187,";":t?59:186,"'":222,"[":219,"]":221,"\\":220},u={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":t?224:91,cmd:t?224:91,command:t?224:91},m=[],g={16:"shiftKey",18:"altKey",17:"ctrlKey"},h={16:!1,18:!1,17:!1},f={},n=1;n<20;n++)e["f"+n]=111+n;g[t?224:91]="metaKey",h[t?224:91]=!1;var i="all",k=!1,v=function(t){return e[t.toLowerCase()]||u[t.toLowerCase()]||t.toUpperCase().charCodeAt(0)};function r(t){i=t||"all"}function _(){return i||"all"}function w(t,e,n){var i=void 0;if(e.scope===n||"all"===e.scope){for(var o in i=0<e.mods.length,h)Object.prototype.hasOwnProperty.call(h,o)&&(!h[o]&&-1<e.mods.indexOf(+o)||h[o]&&-1===e.mods.indexOf(+o))&&(i=!1);(0!==e.mods.length||h[16]||h[18]||h[17]||h[91])&&!i&&"*"!==e.shortcut||!1===e.method(t,e)&&(t.preventDefault?t.preventDefault():t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),t.cancelBubble&&(t.cancelBubble=!0))}}function b(t){var e=f["*"],n=t.keyCode||t.which||t.charCode;if(-1===m.indexOf(n)&&m.push(n),93!==n&&224!==n||(n=91),n in h){for(var i in h[n]=!0,u)u[i]===n&&(y[i]=!0);if(!e)return}for(var o in h)Object.prototype.hasOwnProperty.call(h,o)&&(h[o]=t[g[o]]);if(y.filter.call(this,t)){var r=_();if(e)for(var a=0;a<e.length;a++)e[a].scope===r&&("keydown"===t.type||"keyup"===t.type&&e[a].keyup)&&w(t,e[a],r);if(n in f)for(var s=0;s<f[n].length;s++)w(t,f[n][s],r)}}function y(t,e,n){var i=c(t),o=[],r="all",a=document,s=0;for(void 0===n&&"function"==typeof e&&(n=e),"[object Object]"===Object.prototype.toString.call(e)&&(e.scope&&(r=e.scope),e.element&&(a=e.element)),"string"==typeof e&&(r=e);s<i.length;s++)o=[],1<(t=i[s].split("+")).length&&(o=l(u,t)),(t="*"===(t=t[t.length-1])?"*":v(t))in f||(f[t]=[]),f[t].push({keyup:e.keyup||!1,scope:r,mods:o,shortcut:i[s],method:n,key:i[s]});void 0===a||k||(k=!0,d(a,"keydown",function(t){b(t)}),d(a,"keyup",function(t){b(t),function(t){var e=t.keyCode||t.which||t.charCode,n=m.indexOf(e);if(0<=n&&m.splice(n,1),93!==e&&224!==e||(e=91),e in h)for(var i in h[e]=!1,u)u[i]===e&&(y[i]=!1)}(t)}))}var o={setScope:r,getScope:_,deleteScope:function(t,e){var n=void 0,i=void 0;for(var o in t||(t=_()),f)if(Object.prototype.hasOwnProperty.call(f,o))for(n=f[o],i=0;i<n.length;)n[i].scope===t?n.splice(i,1):i++;_()===t&&r(e||"all")},getPressedKeyCodes:function(){return m.slice(0)},isPressed:function(t){return"string"==typeof t&&(t=v(t)),-1!==m.indexOf(t)},filter:function(t){var e=t.target||t.srcElement,n=e.tagName;return!("INPUT"===n||"SELECT"===n||"TEXTAREA"===n||e.isContentEditable)},unbind:function(t,e,n){var i=c(t),o=void 0,r=[],a=void 0;"function"==typeof e&&(n=e,e="all");for(var s=0;s<i.length;s++){if(1<(o=i[s].split("+")).length&&(r=l(u,o)),t="*"===(t=o[o.length-1])?"*":v(t),e||(e=_()),!f[t])return;for(var d=0;d<f[t].length;d++)a=f[t][d],(!n||a.method===n)&&a.scope===e&&p(a.mods,r)&&(f[t][d]={})}}};for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(y[a]=o[a]);if("undefined"!=typeof window){var s=window.hotkeys;y.noConflict=function(t){return t&&window.hotkeys===y&&(window.hotkeys=s),y},window.hotkeys=y}return y}),function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.ClipboardJS=e():t.ClipboardJS=e()}(this,function(){return function(n){var i={};function o(t){if(i[t])return i[t].exports;var e=i[t]={i:t,l:!1,exports:{}};return n[t].call(e.exports,e,e.exports,o),e.l=!0,e.exports}return o.m=n,o.c=i,o.d=function(t,e,n){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)o.d(n,i,function(t){return e[t]}.bind(null,i));return n},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=0)}([function(t,e,n){"use strict";var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r=function(){function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}}(),a=i(n(1)),s=i(n(3)),d=i(n(4));function i(t){return t&&t.__esModule?t:{default:t}}var l=function(t){function i(t,e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,i);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return n.resolveOptions(e),n.listenClick(t),n}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(i,s.default),r(i,[{key:"resolveOptions",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.action="function"==typeof t.action?t.action:this.defaultAction,this.target="function"==typeof t.target?t.target:this.defaultTarget,this.text="function"==typeof t.text?t.text:this.defaultText,this.container="object"===o(t.container)?t.container:document.body}},{key:"listenClick",value:function(t){var e=this;this.listener=(0,d.default)(t,"click",function(t){return e.onClick(t)})}},{key:"onClick",value:function(t){var e=t.delegateTarget||t.currentTarget;this.clipboardAction&&(this.clipboardAction=null),this.clipboardAction=new a.default({action:this.action(e),target:this.target(e),text:this.text(e),container:this.container,trigger:e,emitter:this})}},{key:"defaultAction",value:function(t){return c("action",t)}},{key:"defaultTarget",value:function(t){var e=c("target",t);if(e)return document.querySelector(e)}},{key:"defaultText",value:function(t){return c("text",t)}},{key:"destroy",value:function(){this.listener.destroy(),this.clipboardAction&&(this.clipboardAction.destroy(),this.clipboardAction=null)}}],[{key:"isSupported",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:["copy","cut"],e="string"==typeof t?[t]:t,n=!!document.queryCommandSupported;return e.forEach(function(t){n=n&&!!document.queryCommandSupported(t)}),n}}]),i}();function c(t,e){var n="data-clipboard-"+t;if(e.hasAttribute(n))return e.getAttribute(n)}t.exports=l},function(t,e,n){"use strict";var i,o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r=function(){function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}}(),a=n(2),s=(i=a)&&i.__esModule?i:{default:i};var d=function(){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),this.resolveOptions(t),this.initSelection()}return r(e,[{key:"resolveOptions",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.action=t.action,this.container=t.container,this.emitter=t.emitter,this.target=t.target,this.text=t.text,this.trigger=t.trigger,this.selectedText=""}},{key:"initSelection",value:function(){this.text?this.selectFake():this.target&&this.selectTarget()}},{key:"selectFake",value:function(){var t=this,e="rtl"==document.documentElement.getAttribute("dir");this.removeFake(),this.fakeHandlerCallback=function(){return t.removeFake()},this.fakeHandler=this.container.addEventListener("click",this.fakeHandlerCallback)||!0,this.fakeElem=document.createElement("textarea"),this.fakeElem.style.fontSize="12pt",this.fakeElem.style.border="0",this.fakeElem.style.padding="0",this.fakeElem.style.margin="0",this.fakeElem.style.position="absolute",this.fakeElem.style[e?"right":"left"]="-9999px";var n=window.pageYOffset||document.documentElement.scrollTop;this.fakeElem.style.top=n+"px",this.fakeElem.setAttribute("readonly",""),this.fakeElem.value=this.text,this.container.appendChild(this.fakeElem),this.selectedText=(0,s.default)(this.fakeElem),this.copyText()}},{key:"removeFake",value:function(){this.fakeHandler&&(this.container.removeEventListener("click",this.fakeHandlerCallback),this.fakeHandler=null,this.fakeHandlerCallback=null),this.fakeElem&&(this.container.removeChild(this.fakeElem),this.fakeElem=null)}},{key:"selectTarget",value:function(){this.selectedText=(0,s.default)(this.target),this.copyText()}},{key:"copyText",value:function(){var e=void 0;try{e=document.execCommand(this.action)}catch(t){e=!1}this.handleResult(e)}},{key:"handleResult",value:function(t){this.emitter.emit(t?"success":"error",{action:this.action,text:this.selectedText,trigger:this.trigger,clearSelection:this.clearSelection.bind(this)})}},{key:"clearSelection",value:function(){this.trigger&&this.trigger.focus(),window.getSelection().removeAllRanges()}},{key:"destroy",value:function(){this.removeFake()}},{key:"action",set:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"copy";if(this._action=t,"copy"!==this._action&&"cut"!==this._action)throw new Error('Invalid "action" value, use either "copy" or "cut"')},get:function(){return this._action}},{key:"target",set:function(t){if(void 0!==t){if(!t||"object"!==(void 0===t?"undefined":o(t))||1!==t.nodeType)throw new Error('Invalid "target" value, use a valid Element');if("copy"===this.action&&t.hasAttribute("disabled"))throw new Error('Invalid "target" attribute. Please use "readonly" instead of "disabled" attribute');if("cut"===this.action&&(t.hasAttribute("readonly")||t.hasAttribute("disabled")))throw new Error('Invalid "target" attribute. You can\'t cut text from elements with "readonly" or "disabled" attributes');this._target=t}},get:function(){return this._target}}]),e}();t.exports=d},function(t,e){t.exports=function(t){var e;if("SELECT"===t.nodeName)t.focus(),e=t.value;else if("INPUT"===t.nodeName||"TEXTAREA"===t.nodeName){var n=t.hasAttribute("readonly");n||t.setAttribute("readonly",""),t.select(),t.setSelectionRange(0,t.value.length),n||t.removeAttribute("readonly"),e=t.value}else{t.hasAttribute("contenteditable")&&t.focus();var i=window.getSelection(),o=document.createRange();o.selectNodeContents(t),i.removeAllRanges(),i.addRange(o),e=i.toString()}return e}},function(t,e){function n(){}n.prototype={on:function(t,e,n){var i=this.e||(this.e={});return(i[t]||(i[t]=[])).push({fn:e,ctx:n}),this},once:function(t,e,n){var i=this;function o(){i.off(t,o),e.apply(n,arguments)}return o._=e,this.on(t,o,n)},emit:function(t){for(var e=[].slice.call(arguments,1),n=((this.e||(this.e={}))[t]||[]).slice(),i=0,o=n.length;i<o;i++)n[i].fn.apply(n[i].ctx,e);return this},off:function(t,e){var n=this.e||(this.e={}),i=n[t],o=[];if(i&&e)for(var r=0,a=i.length;r<a;r++)i[r].fn!==e&&i[r].fn._!==e&&o.push(i[r]);return o.length?n[t]=o:delete n[t],this}},t.exports=n},function(t,e,n){var i=n(5),o=n(6);t.exports=function(t,e,n){if(!t&&!e&&!n)throw new Error("Missing required arguments");if(!i.string(e))throw new TypeError("Second argument must be a String");if(!i.fn(n))throw new TypeError("Third argument must be a Function");if(i.node(t))return function(t,e,n){return t.addEventListener(e,n),{destroy:function(){t.removeEventListener(e,n)}}}(t,e,n);if(i.nodeList(t))return function(t,e,n){return Array.prototype.forEach.call(t,function(t){t.addEventListener(e,n)}),{destroy:function(){Array.prototype.forEach.call(t,function(t){t.removeEventListener(e,n)})}}}(t,e,n);if(i.string(t))return function(t,e,n){return o(document.body,t,e,n)}(t,e,n);throw new TypeError("First argument must be a String, HTMLElement, HTMLCollection, or NodeList")}},function(t,n){n.node=function(t){return void 0!==t&&t instanceof HTMLElement&&1===t.nodeType},n.nodeList=function(t){var e=Object.prototype.toString.call(t);return void 0!==t&&("[object NodeList]"===e||"[object HTMLCollection]"===e)&&"length"in t&&(0===t.length||n.node(t[0]))},n.string=function(t){return"string"==typeof t||t instanceof String},n.fn=function(t){return"[object Function]"===Object.prototype.toString.call(t)}},function(t,e,n){var a=n(7);function r(t,e,n,i,o){var r=function(e,n,t,i){return function(t){t.delegateTarget=a(t.target,n),t.delegateTarget&&i.call(e,t)}}.apply(this,arguments);return t.addEventListener(n,r,o),{destroy:function(){t.removeEventListener(n,r,o)}}}t.exports=function(t,e,n,i,o){return"function"==typeof t.addEventListener?r.apply(null,arguments):"function"==typeof n?r.bind(null,document).apply(null,arguments):("string"==typeof t&&(t=document.querySelectorAll(t)),Array.prototype.map.call(t,function(t){return r(t,e,n,i,o)}))}},function(t,e){if("undefined"!=typeof Element&&!Element.prototype.matches){var n=Element.prototype;n.matches=n.matchesSelector||n.mozMatchesSelector||n.msMatchesSelector||n.oMatchesSelector||n.webkitMatchesSelector}t.exports=function(t,e){for(;t&&9!==t.nodeType;){if("function"==typeof t.matches&&t.matches(e))return t;t=t.parentNode}}}])}),function(t){var n=-1,r={onVisible:function(n){var t=r.isSupported();if(!t||!r.hidden())return n(),t;var i=r.change(function(t,e){r.hidden()||(r.unbind(i),n())});return i},change:function(t){if(!r.isSupported())return!1;var e=n+=1;return r._callbacks[e]=t,r._listen(),e},unbind:function(t){delete r._callbacks[t]},afterPrerendering:function(n){var t=r.isSupported(),i="prerender";if(!t||i!=r.state())return n(),t;var o=r.change(function(t,e){i!=e&&(r.unbind(o),n())});return o},hidden:function(){return!(!r._doc.hidden&&!r._doc.webkitHidden)},state:function(){return r._doc.visibilityState||r._doc.webkitVisibilityState||"visible"},isSupported:function(){return void 0!==r._doc.hidden||void 0!==r._doc.webkitHidden},_doc:document||{},_callbacks:{},_change:function(t){var e=r.state();for(var n in r._callbacks)r._callbacks[n].call(r._doc,t,e)},_listen:function(){if(!r._init){var t="visibilitychange";r._doc.webkitVisibilityState&&(t="webkit"+t);var e=function(){r._change.apply(r,arguments)};r._doc.addEventListener?r._doc.addEventListener(t,e):r._doc.attachEvent(t,e),r._init=!0}}};"undefined"!=typeof module&&module.exports?module.exports=r:t.Visibility=r}(this),function(s){var o=-1,t=function(a){return a.every=function(t,e,n){a._time(),n||(n=e,e=null);var i=o+=1;return a._timers[i]={visible:t,hidden:e,callback:n},a._run(i,!1),a.isSupported()&&a._listen(),i},a.stop=function(t){return!!a._timers[t]&&(a._stop(t),delete a._timers[t],!0)},a._timers={},a._time=function(){a._timed||(a._timed=!0,a._wasHidden=a.hidden(),a.change(function(){a._stopRun(),a._wasHidden=a.hidden()}))},a._run=function(t,e){var n,i=a._timers[t];if(a.hidden()){if(null===i.hidden)return;n=i.hidden}else n=i.visible;var o=function(){i.last=new Date,i.callback.call(s)};if(e){var r=new Date-i.last;r<n?i.delay=setTimeout(function(){i.id=setInterval(o,n),o()},n-r):(i.id=setInterval(o,n),o())}else i.id=setInterval(o,n)},a._stop=function(t){var e=a._timers[t];clearInterval(e.id),clearTimeout(e.delay),delete e.id,delete e.delay},a._stopRun=function(t){var e=a.hidden(),n=a._wasHidden;if(e&&!n||!e&&n)for(var i in a._timers)a._stop(i),a._run(i,!e)},a};"undefined"!=typeof module&&module.exports?module.exports=t(require("./visibility.core")):t(s.Visibility||require("./visibility.core"))}(window),function(t,d,e,n){t.fn.insertAtCaret=function(s){return this.each(function(){var t,e,n,i,o=this,r=0,a="selectionStart"in o&&"selectionEnd"in o;(o.tagName&&"textarea"===o.tagName.toLowerCase()||o.tagName&&"input"===o.tagName.toLowerCase()&&"text"===o.type.toLowerCase())&&(t=o.scrollTop,r=a?o.selectionStart:(o.focus(),(i=d.selection.createRange()).moveStart("character",-o.value.length),i.text.length),e=o.value.substring(0,r),n=o.value.substring(r,o.value.length),o.value=e+s+n,r+=s.length,a?(o.selectionStart=r,o.selectionEnd=r):((i=d.selection.createRange()).moveStart("character",r),i.moveEnd("character",0),i.select()),o.scrollTop=t)})}}(jQuery,document,window),function(s,i,o,d){var l=s(i);s.fn.lazyload=function(t){var e,r=this,a={threshold:0,failure_limit:0,event:"scroll",effect:"show",container:i,data_attribute:"original",skip_invisible:!0,appear:null,load:null,placeholder:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC"};function n(){var e=0;r.each(function(){var t=s(this);if(!a.skip_invisible||t.is(":visible"))if(s.abovethetop(this,a)||s.leftofbegin(this,a));else if(s.belowthefold(this,a)||s.rightoffold(this,a)){if(++e>a.failure_limit)return!1}else t.trigger("appear"),e=0})}return t&&(d!==t.failurelimit&&(t.failure_limit=t.failurelimit,delete t.failurelimit),d!==t.effectspeed&&(t.effect_speed=t.effectspeed,delete t.effectspeed),s.extend(a,t)),e=a.container===d||a.container===i?l:s(a.container),0===a.event.indexOf("scroll")&&e.bind(a.event,function(){return n()}),this.each(function(){var i=this,o=s(i);i.loaded=!1,o.attr("src")!==d&&!1!==o.attr("src")||o.is("img")&&o.attr("src",a.placeholder),o.one("appear",function(){if(!this.loaded){if(a.appear){var t=r.length;a.appear.call(i,t,a)}s("<img />").bind("load",function(){var t=o.attr("data-"+a.data_attribute);o.hide(),o.is("img")?o.attr("src",t):o.css("background-image","url('"+t+"')"),o[a.effect](a.effect_speed),i.loaded=!0;var e=s.grep(r,function(t){return!t.loaded});if(r=s(e),a.load){var n=r.length;a.load.call(i,n,a)}}).attr("src",o.attr("data-"+a.data_attribute))}}),0!==a.event.indexOf("scroll")&&o.bind(a.event,function(){i.loaded||o.trigger("appear")})}),l.bind("resize",function(){n()}),/(?:iphone|ipod|ipad).*os 5/gi.test(navigator.appVersion)&&l.bind("pageshow",function(t){t.originalEvent&&t.originalEvent.persisted&&r.each(function(){s(this).trigger("appear")})}),s(o).ready(function(){n()}),this},s.belowthefold=function(t,e){return(e.container===d||e.container===i?(i.innerHeight?i.innerHeight:l.height())+l.scrollTop():s(e.container).offset().top+s(e.container).height())<=s(t).offset().top-e.threshold},s.rightoffold=function(t,e){return(e.container===d||e.container===i?l.width()+l.scrollLeft():s(e.container).offset().left+s(e.container).width())<=s(t).offset().left-e.threshold},s.abovethetop=function(t,e){return(e.container===d||e.container===i?l.scrollTop():s(e.container).offset().top)>=s(t).offset().top+e.threshold+s(t).height()},s.leftofbegin=function(t,e){return(e.container===d||e.container===i?l.scrollLeft():s(e.container).offset().left)>=s(t).offset().left+e.threshold+s(t).width()},s.inviewport=function(t,e){return!(s.rightoffold(t,e)||s.leftofbegin(t,e)||s.belowthefold(t,e)||s.abovethetop(t,e))},s.extend(s.expr[":"],{"below-the-fold":function(t){return s.belowthefold(t,{threshold:0})},"above-the-top":function(t){return!s.belowthefold(t,{threshold:0})},"right-of-screen":function(t){return s.rightoffold(t,{threshold:0})},"left-of-screen":function(t){return!s.rightoffold(t,{threshold:0})},"in-viewport":function(t){return s.inviewport(t,{threshold:0})},"above-the-fold":function(t){return!s.belowthefold(t,{threshold:0})},"right-of-fold":function(t){return s.rightoffold(t,{threshold:0})},"left-of-fold":function(t){return!s.rightoffold(t,{threshold:0})}})}(jQuery,window,document);var GtkLanguageManager={languages:{},addLanguage:function(t,e){this.languages[t]=e},setLanguage:function(t,e){(void 0===t||"fr"!=t&&"en"!=t)&&(t="fr"),GtkLang=this.languages[t],e&&(GtkMenu.refresh(),GtkShortcuts.refresh())}};GtkLanguageManager.addLanguage("en",{announcements:"Announcements",themes:"Themes",settings:"Settings",shortcuts:"Shortcuts",about:"About",site:"Site",stats:"Statistics",maps:"Maps",tools:"Tools",forum:"Forum",allianceSection:"Alliance section",helpdesk:"Helpdesk",groups:"Towns groups",back:"Back",slogan:"The all in one for Grepolis !",academy:"Academy",zoomMap:"Zoom / De-zoom the map",barracks:"Caserne",placeDefense:"Defense (Agora)",fullscreen:"Full screen",towns:"Towns",gods:"Gods",hides:"Hides",orders:"Orders",farmingVillages:"Farming villages",attackPlanner:"Planner",units:"Units",buildings:"Buildings",outsideUnits:"Outside troops",recrutement:"Recruitment",culture:"Culture",trade:"Trade",previousTown:"Previous town",nextTown:"Next town",townsList:"List of towns",temple:"Temple",farm:"Farm",placeSimulator:"Simulator (Place)",closeAllWindows:"Close the windows",senate:"Senate",port:"Harbour",walls:"Walls",market:"Market",notepad:"Notepad",placeOutsideUnits:"Outside troops (Place)",inventory:"Inventory",goToTown:"Go to town",placeCulture:"Culture (Place)",activeTheme:"Active theme",changedTheme:"The theme has been changed",smileys:"Smileys",finishedAt:"Finished at",todayAt:"today at",tomorrowAt:"tomorrow at",tabListReports:"Management",tabReportExporter:"Export",tabListWalls:"Management",tabWallExporter:"Export",smileys:"Smileys",deselectAllUnits:"Empty fields",copy:"Copy",quoteAuthorText:"has written the following :",export:"Exporter",exportAsImage:"Export as image",manageExports:"Manage exports",exportReport:"Export a report",exportManager:"Exports manager",exportSimulator:"Export simulator",exportWalls:"Export walls",exportOrders:"Export orders",imageAvailable:"Image available",exportMessageAsBBCode:"Export the message as BBCode",BBCodeHasBeenCopied:"The BBCode has been copied",exportUnitsAsBBCode:"Export units has BBCode",troopsInTown:"Troops in the town",alliedTroopsInTown:"Allied troops in the town",outsideTroops:"Outside troops",linkHasBeenCopied:"The link has been copied",unknownDetails:"Unknown details"});var GtkLang={announcements:"Annonces",themes:"Thèmes",settings:"Réglages",shortcuts:"Raccourcis",about:"A propos",site:"Site",stats:"Statistiques",maps:"Maps",tools:"Outils",forum:"Forum",allianceSection:"Section alliance",helpdesk:"Support",groups:"Groupes de villes",back:"Retour",slogan:"Le tout en un pour Grepolis",academy:"Académie",zoomMap:"Agrandir / Réduire la carte",barracks:"Caserne",placeDefense:"Défense (Agora)",fullscreen:"Plein écran",towns:"Villes",gods:"Divinités",hides:"Grottes",orders:"Ordres",farmingVillages:"Villages de paysans",attackPlanner:"Planificateur",units:"Unités",buildings:"Bâtiments",outsideUnits:"Troupes en dehors",recrutement:"Recrutement",culture:"Culture",trade:"Commerce",previousTown:"Ville précédente",nextTown:"Ville suivante",townsList:"Liste des villes",temple:"Temple",farm:"Ferme",placeSimulator:"Simulateur (Agora)",closeAllWindows:"Fermer les fenêtres",senate:"Sénat",port:"Port",walls:"Remparts",market:"Marché",notepad:"Bloc-note",placeOutsideUnits:"Troupes en dehors (agora)",inventory:"Inventaire",goToTown:"Aller à la ville",placeCulture:"Culture (Agora)",activeTheme:"Thème actif",changedTheme:"Thème changé",smileys:"Emoticones",finishedAt:"Fini à",todayAt:"aujourd'hui à",tomorrowAt:"demain à",tabListReports:"Gestion",tabReportExporter:"Exporter",tabListWalls:"Gestion",tabWallExporter:"Exporter",smileys:"Emoticones",deselectAllUnits:"Vider les champs",copy:"Copier",quoteAuthorText:"a écrit ce qui suit :",export:"Exporter",exportAsImage:"Exporter en image",manageExports:"Gérer les exportations",exportReport:"Exportation d'un rapport",exportManager:"Gestionnaire d'exportations",exportSimulator:"Exportation du simulateur",exportWalls:"Exportation des remparts",exportOrders:"Exportation des ordres",imageAvailable:"Image disponible",exportMessageAsBBCode:"Exportation du message en BBCode",BBCodeHasBeenCopied:"Le BBCode a été copié",exportUnitsAsBBCode:"Exportation des unités en BBCode",troopsInTown:"Troupes dans la ville",alliedTroopsInTown:"Troupes alliées dans la ville",outsideTroops:"Troupes en dehors",linkHasBeenCopied:"Le lien a été copié",unknownDetails:"Détails inconnus"};GtkLanguageManager.addLanguage("fr",GtkLang);var GtkAbout={mainWindow:null,init:function(){this.addTabsListener()},openWindow:function(){this.mainWindow=GtkWindow.create(GPWindowMgr.TYPE_GTK_ABOUT,"GrepolisToolkit - "+GtkLang.about,800,600),this.loadAbout()},loadAbout:function(){GtkCommon.sendGetRequest("about",{},function(t){GtkWindow.setContent(GtkAbout.mainWindow,t)},GtkAbout.mainWindow)},addTabsListener:function(){$(document).on("click","#gtk-tab-about",function(){switch($(this).attr("data-name")){case"about":GtkAbout.loadAbout()}})}},GtkActivityLists={$draggableDivs:null,cssPermanentObj:[],updateLists:function(){GtkSettings.getValue("activity_lists")?(this.addActivityListsListeners(),this.addDragListener(),this.triggerButtons(),this.showLists()):this.visible()&&(this.removeActivityListsListeners(),this.removeDragListener(),this.hideLists(),this.removeAllPermanentCSS())},triggerButtons:function(){$("#toolbar_activity_recruits").trigger("mouseover"),$("#toolbar_activity_commands").trigger("mouseover"),$("#toolbar_activity_trades").trigger("mouseover")},visible:function(){return $("#toolbar_activity_recruits_list").is(":visible")&&$("#toolbar_activity_commands_list").is(":visible")&&$("#toolbar_activity_trades_list").is(":visible")},getSavedCoords:function(){var t=$.cookie("gtk_activity_lists_"+Game.player_id),e={recruits:{x:230,y:65},commands:{x:530,y:65},trades:{x:830,y:65}};return void 0!==t&&(e=JSON.parse(t)),e},saveCoords:function(t){$.cookie("gtk_activity_lists_"+Game.player_id,JSON.stringify(t),{expires:5e3,path:"/game",domain:".grepolis.com"})},showList:function(t,e){var n=this.getSavedCoords();$("#toolbar_activity_"+t+"_list").css({zIndex:11,top:n[t].y,left:n[t].x}).show(),e&&this.savePermanentCSS(t)},savePermanentCSS:function(t){var e=this.getSavedCoords();GtkCommon.addPermanentCSS("#toolbar_activity_"+t+"_list",[["z-index",11],["top",e[t].y+"px !important"],["left",e[t].x+"px !important"]])},removeAllPermanentCSS:function(){GtkCommon.removePermanentCSS("recruits"),GtkCommon.removePermanentCSS("commands"),GtkCommon.removePermanentCSS("trades")},showLists:function(){this.showList("recruits",!0),this.showList("commands",!0),this.showList("trades",!0)},hideLists:function(){$("#toolbar_activity_recruits_list").hide(),$("#toolbar_activity_commands_list").hide(),$("#toolbar_activity_trades_list").hide()},hoverButtonsAndListListener:function(){var t=$(this).attr("id").split("_")[2];GtkActivityLists.showList(t)},hoverCommandListListener:function(){var t=$(this).find(".js-dropdown").attr("id").split("_")[2];GtkActivityLists.showList(t)},updatedListsListener:function(){setTimeout(function(){GtkActivityLists.hideLists(),GtkActivityLists.triggerButtons()},20)},addActivityListsListeners:function(){$("#toolbar_activity_recruits_list, #toolbar_activity_recruits, #toolbar_activity_commands_list, #toolbar_activity_commands, #toolbar_activity_trades_list, #toolbar_activity_trades").on("mouseover mouseout",this.hoverButtonsAndListListener),$("div.activity.commands").on("wgtta:list:hide dd:list:hide",this.hoverCommandListListener),$(".activity.recruits .count, .activity.commands .count, .activity.trades .count").on("DOMSubtreeModified",this.updatedListsListener)},removeActivityListsListeners:function(){$("#toolbar_activity_recruits_list, #toolbar_activity_recruits, #toolbar_activity_commands_list, #toolbar_activity_commands, #toolbar_activity_trades_list, #toolbar_activity_trades").off("mouseover mouseout",this.hoverButtonsAndListListener),$("div.activity.commands").off("wgtta:list:hide dd:list:hide",this.hoverCommandListListener),$(".activity.recruits .count, .activity.commands .count, .activity.trades .count").off("DOMSubtreeModified",this.updatedListsListener)},addDragListener:function(){this.$draggableDivs=$("#toolbar_activity_recruits_list, #toolbar_activity_commands_list, #toolbar_activity_trades_list").draggable({start:function(){GtkCommon.removePermanentCSS("#"+$(this).attr("id"))},stop:function(){var t=$(this).offset(),e=t.left,n=t.top,i=$(this).attr("id").split("_")[2],o=GtkActivityLists.getSavedCoords();o[i].x=e,o[i].y=n,GtkActivityLists.saveCoords(o),GtkActivityLists.savePermanentCSS(i)}})},removeDragListener:function(){this.$draggableDivs.draggable("destroy")}},GtkAjaxDetector={init:function(){this.addAjaxSuccessListener(),this.addAjaxSendListener()},addAjaxSuccessListener:function(){$(document).ajaxSuccess(function(t,d,l){var c=l.url.split(/\?/)[0]+"?"+l.url.split(/&/)[1];$.each(Layout.wnd.getOpenedWindows(),function(t,e){var n=e.getID(),i=Layout.wnd.GetByID(n).type;switch(c){case"/game/report?action=index":if(i!=Layout.wnd.TYPE_REPORT)return;GtkReportManager.appendButton();break;case"/game/report?action=view":if(i!=Layout.wnd.TYPE_REPORT)return;GtkReportExporter.prepareData(),GtkReportExporter.appendButton();break;case"/game/alliance_forum?action=forum":if(i!=Layout.wnd.TYPE_ALLIANCE_FORUM)return;GtkReportForumExporter.appendButton(),GtkSimulatorBuilder.addButtonToSpyReports(),GtkSmileys.updateWindow(n,"forum"),GtkMaximiseTabs.modifyForumWindow(n,!0),GtkMaximiseForum.maximiseWindowContent(n);var o=JSON.parse(decodeURIComponent(l.data.replace("json=","")));o.hasOwnProperty("thread_id")?GtkForumMemory.init(o.thread_id):GtkForumMemory.resetData();break;case"/game/message?action=new":case"/game/message?action=reply":case"/game/message?action=forward":case"/game/message?action=preview":if(i!=Layout.wnd.TYPE_MESSAGE)return;GtkSmileys.updateWindow(n,"msg");break;case"/game/message?action=view":if(i!=Layout.wnd.TYPE_MESSAGE)return;GtkSmileys.updateWindow(n,"msg"),GtkMessageExporter.addButtons();break;case"/game/town_info?action=info":if(i!=Layout.wnd.TYPE_TOWN)return;GtkStats.showButton(n,"town_profile",0);break;case"/game/town_info?action=attack":case"/game/town_info?action=support":if(i!=Layout.wnd.TYPE_TOWN||0<$("#gpwnd_"+n+" .gtk_deselectAllUnits").length)return;GtkVarious.addDeselectButton(n);break;case"/game/player?action=get_profile_html":if(i!=Layout.wnd.TYPE_PLAYER_PROFILE)return;var r=l.url.match(/player_id%22%3A(\d*)%2C/)[1];GtkStats.showButton(n,"player_profile",r);break;case"/game/alliance?action=profile":if(i!=Layout.wnd.TYPE_ALLIANCE_PROFILE)return;var a=l.url.match(/alliance_id%22%3A(\d*)%2C/)[1];GtkStats.showButton(n,"alliance_profile",a),GtkProfile.showLongerAllianceName(n);break;case"/game/town_overviews?action=culture_overview":case"/game/town_overviews?action=start_all_celebrations":if(i!=Layout.wnd.TYPE_TOWN_OVERVIEWS)return;GtkCulture.updateOverviewWindow(n);break;case"/game/building_main?action=index":case"/game/building_main?action=build":case"/game/building_main?action=building_finished":case"/game/building_main?action=tearDown":case"/game/building_main?action=cancel":GtkSenatePoints.updateWindow();break;case"/game/building_place?action=culture":case"/game/building_place?action=start_celebration":GtkCulture.addCulturePoints(n),GtkCulture.showBattlePointsInAgora(n);break;case"/game/ranking?action=index":case"/game/ranking?action=global":case"/game/ranking?action=kill_player":if(i!=Layout.wnd.TYPE_RANKING)return;GtkStats.showButton(n,"players_ranking",0),GtkMaximiseTabs.modifyRankingsWindow(n);break;case"/game/ranking?action=alliance":case"/game/ranking?action=kill_alliance":if(i!=Layout.wnd.TYPE_RANKING)return;GtkStats.showButton(n,"alliances_ranking",0),GtkMaximiseTabs.modifyRankingsWindow(n);break;case"/game/ranking?action=sea_player":if(i!=Layout.wnd.TYPE_RANKING)return;GtkStats.showButton(n,"players_sea_ranking",0),GtkMaximiseTabs.modifyRankingsWindow(n);break;case"/game/ranking?action=sea_alliance":if(i!=Layout.wnd.TYPE_RANKING)return;GtkStats.showButton(n,"alliances_sea_ranking",0),GtkMaximiseTabs.modifyRankingsWindow(n);break;case"/game/ranking?action=wonder_alliance":case"/game/ranking?action=grepo_score_world":if(i!=Layout.wnd.TYPE_RANKING)return;GtkMaximiseTabs.modifyRankingsWindow(n);break;case"/game/command_info?action=conquest_info":if(i!=Layout.wnd.TYPE_CONQUEROR)return;var s=l.url.match(/command_id%22%3A(\d*)%2C/)[1];GtkConquestExporter.updateWindow(n,"infos",s);break;case"/game/command_info?action=conquest_movements":if(i!=Layout.wnd.TYPE_CONQUEROR)return;GtkConquestExporter.updateWindow(n,"movements",null);break;case"/game/command_info?action=info":case"/game/command_info?action=colonization_info":switch(i){case Layout.wnd.TYPE_ATK_COMMAND:s=l.url.match(/command_id%22%3A(\d*)%2C/)[1];break;case Layout.wnd.TYPE_COLONIZATION_COMMAND:s=l.url.match(/command_id%22%3A%22(\d*)%22%2C/)[1];break;default:return}GtkMovementExporter.updateWindow(n,s);break;case"/game/building_place?action=index":case"/game/building_place?action=units_beyond":if(i!=Layout.wnd.TYPE_BUILDING)return;GtkUnitsExporter.addButtonToAgora(n);break;case"/game/building_place?action=simulator":if(i!=Layout.wnd.TYPE_BUILDING)return;setTimeout(function(){GtkSimulatorExporter.prepareData(),GtkSimulatorExporter.appendButton()},10);break;case"/game/building_place?action=simulate":if(i!=Layout.wnd.TYPE_BUILDING)return;GtkSimulatorInfos.updateWindow(d.responseText.match(/{(.+)}/)),setTimeout(function(){GtkSimulatorExporter.prepareData()},10);break;case"/game/building_wall?action=index":if(i!=Layout.wnd.TYPE_BUILDING)return;GtkWallExporter.prepareData(),GtkWallExporter.appendButton();break;case"/game/building_barracks?action=index":GtkVarious.addSpeelsToUnitWindow(n,"fertility_improvement"),$("#units").click(function(){$("#gtk_infos_units").css("display","none"),$("#unit_order_info").css("display","block")});break;case"/game/building_docks?action=index":if(i!=Layout.wnd.TYPE_BUILDING)return;GtkVarious.addSpeelsToUnitWindow(n,"call_of_the_ocean");break;case"/game/town_overviews?action=command_overview":if(i!=Layout.wnd.TYPE_TOWN_OVERVIEWS)return;GtkOrdersExporter.prepareData(n),GtkOrdersExporter.appendButton();break;case"/game/town_overviews?action=unit_overview":if(i!=Layout.wnd.TYPE_TOWN_OVERVIEWS)return;GtkUnitsExporter.addButtonsTroopsOverview();break;case"/game/town_overviews?action=outer_units":if(i!=Layout.wnd.TYPE_TOWN_OVERVIEWS)return;GtkUnitsExporter.addFooterToWindow(n),GtkUnitsExporter.addButtonToAgora(n);break;case"/game/farm_town_info?action=pillage_info":case"/game/farm_town_info?action=claim_info":case"/game/farm_town_info?action=units_info":GtkVarious.showFarmingFinishTime(n);break;case"/game/chat?action=init":if(i!=Layout.wnd.TYPE_CHAT)return;GtkChat.init(n);break;case"/game/alliance?action=index":if(i!=Layout.wnd.TYPE_ALLIANCE)return;GtkStats.showButton(n,"alliances_recruitement",0)}})})},analyseAjaxSend:function(t,e,o){$.each(Layout.wnd.getOpenedWindows(),function(t,e){var n=e.getID(),i=Layout.wnd.GetByID(n).type;switch(o.url.split(/\?/)[0]+"?"+o.url.split(/&/)[1]){case"/game/alliance_forum?action=forum":if(i!=Layout.wnd.TYPE_ALLIANCE_FORUM)return;GtkMaximiseForum.maximiseWindow(n)}})},addAjaxSendListener:function(){$(document).ajaxSend(function(t,e,n){setTimeout(function(){GtkAjaxDetector.analyseAjaxSend(t,e,n)},10)})}},GtkAnnouncements={init:function(){this.addOpenListener()},openWindow:function(e){var n=GtkWindow.create(GPWindowMgr.TYPE_GTK_ANNOUNCEMENTS,"GrepolisToolkit - "+GtkLang.announcements,800,600);GtkCommon.sendGetRequest("announcements/show",{},function(t){GtkWindow.setContent(n,t),e&&$(".gtk-announcement-list .announcement_header:first").click()},n)},sendView:function(t){GtkCommon.sendPostRequest("announcements/add-view",{announcementId:t})},addOpenListener:function(){$(document).on("click",".gtk-announcement-list .announcement_header",function(){var t=$(this).attr("data-id");$announcementContainer=$('.announcement_content[data-id="'+t+'"]'),$announcementContainer.is(":visible")?$announcementContainer.hide():($announcementContainer.show(),GtkAnnouncements.sendView(t))})}},GtkChat={winId:0,nbMessages:1,init:function(t){this.addTransformButton(),this.addNewMessageListener(),this.addTransformListener(),this.addCloseListener(),this.winId=t},convertSmileys:function(){GtkSettings.getValue("smileys_chat")&&GtkSmileys.convertPostsSmileys(this.winId)},addTransformButton:function(){$("#chat").append('<a href="#" title="Transformer" id="gtk-chat-transform"></a>')},moveToBottom:function(){$("#ui_box").append('<div id="gtk-footer-chat"><div class="messages_box"><div class="textbox"></div></div><div class="players_box"></div><div class="both"></div></div>'),$("#chat_history_bg").prependTo("#gtk-footer-chat .messages_box"),$("#chat_message_text").appendTo("#gtk-footer-chat .textbox"),$("#chat_roominfo").appendTo("#gtk-footer-chat .players_box"),$("#gtk-footer-chat").append('<a href="#" title="Rétablir" id="gtk-chat-transform"></a>'),$("#gtk-footer-chat").append('<a href="#" title="Fermer" id="gtk-chat-close"></a>'),$("#chat").parent().parent().parent().css("visibility","hidden")},moveToTop:function(){$("#gtk-footer-chat .messages_box #chat_history_bg").appendTo(".chat_elements"),$("#gtk-footer-chat .textbox textarea").appendTo(".chat_elements"),$("#gtk-footer-chat .players_box div").appendTo(".chat_elements"),$("#gtk-footer-chat").remove(),$("#chat").parent().parent().parent().css("visibility","visible")},closeBottom:function(){$("#gtk-footer-chat").remove(),$("#chat").parent().parent().parent().find(".ui-dialog-titlebar-close").click()},addNewMessageListener:function(){$("#chat_history").on("DOMNodeInserted",function(){var t=$(this).find(".chat_line_message").length;if(GtkChat.nbMessages<t){var e=GtkSounds.getSound("message_chat");Visibility.hidden()&&GtkSettings.getValue(e.setting)&&GtkSounds.playSound(e),GtkChat.nbMessages=t,GtkChat.convertSmileys()}})},addTransformListener:function(){$(document).off("click","#gtk-chat-transform"),$(document).on("click","#gtk-chat-transform",function(){0<$("#gtk-footer-chat").length?GtkChat.moveToTop():GtkChat.moveToBottom()})},addCloseListener:function(){$(document).off("click","#gtk-chat-close"),$(document).on("click","#gtk-chat-close",function(){GtkChat.closeBottom()})}},GtkContextMenu={iconsDataArray:{town:{attack:{x:"60",y:"0"},support:{x:"37",y:"47"},trading:{x:"-13",y:"58"},espionage:{x:"-54",y:"26"},god:{x:"-54",y:"-26"},jump_to:{x:"-13",y:"-58"},gtk_stats:{x:"41",y:"-48"}},current_town:{god:{x:"0",y:"60"},info:{x:"-60",y:"0"},jump_to:{x:"0",y:"-60"},gtk_stats:{x:"60",y:"0"}},own_town:{attack:{x:"60",y:"0"},support:{x:"37",y:"47"},trading:{x:"-13",y:"58"},info:{x:"-54",y:"26"},god:{x:"-54",y:"-26"},select_town:{x:"-13",y:"-58"},gtk_stats:{x:"41",y:"-48"}},ghost_town:{jump_to:{x:"0",y:"-58"},attack:{x:"55",y:"-10"},espionage:{x:"-55",y:"-10"},support:{x:"37",y:"47"},gtk_stats:{x:"-37",y:"47"}}},init:function(){this.addClickTileListener(),this.addClickTownNameListener(),this.addClickMinimapListener(),this.deleteDioToolsCSS()},modifyMenu:function(t,e){var n=this.detectType(t,e);this.addStatsIcon(t),this.animateIcons(n)},detectType:function(t,e){return Game.townId==t?"current_town":null!=ITowns.getTown(t)?"own_town":e?"ghost_town":"town"},animateIcon:function(t,e,n){$("#context_menu #"+t).animate({left:e+"px",top:n+"px"},200)},animateIcons:function(t){$.each(this.iconsDataArray[t],function(t,e){GtkContextMenu.animateIcon(t,e.x,e.y)})},addStatsIcon:function(t){$("#context_menu").append('<a id="gtk_stats" href="'+GtkSite.generateLink("town_profile",t)+'" target="_blank"><div class="icon_caption"><div class="top"></div><div class="middle"></div><div class="bottom"></div><div class="caption">'+GtkLang.stats+"</div></div></a>")},deleteDioToolsCSS:function(){setTimeout(function(){$("#dio_context_menu").remove()},1e3)},addClickTileListener:function(){$(document).on("click","#map_towns a.tile",function(){if(0<$("#context_menu").length){var t=$(this).attr("id").match(/town_(\d+)/)[1],e=$("#town_flag_"+t+" div").hasClass("ghost_town");GtkContextMenu.modifyMenu(t,e)}})},addClickMinimapListener:function(){$(document).on("click","#minimap_canvas a.m_town",function(){if(0<$("#context_menu").length){var t=$(this).attr("id").match(/mini_t(\d+)/)[1],e="rgb(102, 102, 102)"===$(this).css("color");GtkContextMenu.modifyMenu(t,e)}})},addClickTownNameListener:function(){$(document).on("click","a.gp_town_link",function(){if(0<$("#context_menu").length){var t=JSON.parse(atob($(this).attr("href").replace("#",""))),e=t.id,n="ghost_town"==t.tp;GtkContextMenu.modifyMenu(e,n)}})}},GtkCulture={updateOverviewWindow:function(t){this.addOverviewSelectCounters(t),this.addOverviewBattlePoints(t),this.addOverviewCulturePoints(t)},addOverviewSelectCounters:function(t){var e=$(".confirm.type_party:not(.disabled)").length,n=$(".confirm.type_theater:not(.disabled)").length,i=$(".confirm.type_games:not(.disabled)").length,o=$("#gpwnd_"+t+" .points_count").text().split("/"),r=parseInt(o[0])-parseInt(o[1]),a=Math.floor(r/300)+1;void 0===$("#place_culture_count").text().split("(")[1]&&($("#place_celebration_select .caption").append(" ("+e+")"),this.appendCounterToSelect("party",e),this.appendCounterToSelect("games",i),this.appendCounterToSelect("triumph",a),this.appendCounterToSelect("theater",n))},appendCounterToSelect:function(t,e){$('#place_celebration_select_list .option[name="'+t+'"]').append(" ("+e+")")},addOverviewCulturePoints:function(t){var e=$("#gpwnd_"+t+" .eta").length,n=$("#place_culture_count").text().split("/"),i=parseInt(n[1])-parseInt(n[0])-parseInt(e);void 0===$("#place_culture_count").text().split("(")[1]&&(i=i<=0?"+"+-i:"-"+i,$("#gpwnd_"+t+" #place_culture_count").append(" ("+i+")"))},addOverviewBattlePoints:function(t){var e=$("#gpwnd_"+t+" .points_count").text().split("/"),n=parseInt(e[0])-parseInt(e[1]);void 0===$("#place_culture_count").text().split("(")[1]&&($("#gpwnd_"+t+" .points_count").append(' <span class="gtk-remaining-battlepoints">('+n+")</span>"),$("#gpwnd_"+t+" #culture_points_overview_bottom").css("height","114px"),$("#gpwnd_"+t+" #place_battle_points").css("height","38px"))},addCulturePoints:function(t){if($cultureDiv=$("#gpwnd_"+t+" #gtk-culture-count"),!(0<$cultureDiv.length)){var e=$cultureDiv.text().split("/"),n=parseInt(e[1])-parseInt(e[0]);$cultureDiv.html(e[0]+"/"+e[1]+" (-"+n+")")}},showBattlePointsInAgora:function(t){var e=$("#gpwnd_"+t).find("#place_triumph .game_footer span"),n=$(".nui_battlepoints_container .points").text(),i=e.html();e.html(n+"/"+i)}},GtkForumMemory={threadId:null,page:null,postId:null,init:function(t){if(GtkSettings.getValue("forum_memory"))if(this.page=this.getCurrentPage(),this.addScrollForumListener(),this.threadId!=t){this.threadId=t;var e=this.getThreadMemoryData();void 0!==e&&this.changePage(e)}else this.updateCookie()},resetData:function(){this.threadId=null,this.postId=null},getCurrentPage:function(){return parseInt($("#forum #paginator_selected").text())},changePage:function(t){this.getCurrentPage()!=t.page&&Forum.viewThread(this.threadId,!1,t.page,t.postId)},getThreadMemoryData:function(){var t=this.getCookie();return void 0===t?void 0:t[this.threadId]},getCookie:function(){var t=$.cookie("gtk_forum_memory_"+Game.player_id);return void 0===t?void 0:JSON.parse(atob(t))},setCookie:function(){var t=null==this.getCookie()?{}:this.getCookie();(!t.hasOwnProperty(this.threadId)||t.hasOwnProperty(this.threadId)&&t[this.threadId].postId<this.postId)&&(t[this.threadId]={page:this.page,postId:this.postId},$.cookie("gtk_forum_memory_"+Game.player_id,btoa(JSON.stringify(t)),{expires:5e3}))},updateCookie:function(){GtkForumMemory.postId=parseInt($(".post:in-viewport").last().attr("id").replace("post_","")),setTimeout(function(){GtkForumMemory.setCookie()},200)},addScrollForumListener:function(){$("#postlist").scroll(function(){GtkForumMemory.updateCookie()})}},GtkMapConnector={init:function(){this.addShowOnMapAddonListener()},addShowOnMapAddonListener:function(){window.addEventListener("message",function(t){if(t.source==window&&t.data.type&&"gtkShowInGame"==t.data.type){var e=require("map/helpers").map2Pixel(t.data.coordX,t.data.coordY);$(".topleft_navigation_area .island_view").click(),WMap.centerMapOnPos(e.x,e.y,!0,function(){HumanMessage.success("La carte a été centrée")})}},!1)}},GtkMaximiseForum={$windowDiv:null,init:function(){this.addResizeScreenListener()},maximise:function(){return GtkSettings.getValue("forum_maximised")},maximiseWindow:function(t){if(this.maximise()){var e=$("body").width(),n=$("body").height(),i=e-350,o=n-150;this.$windowDiv=$("#gpwnd_"+t).parent().parent(),750<=i&&(this.$windowDiv.css("width",i),this.$windowDiv.css("left",(e-i)/2)),520<=o&&(this.$windowDiv.css("height",o),this.$windowDiv.css("top",(n-o)/2)),GtkMaximiseTabs.modifyForumWindow(t,!1)}},maximiseWindowContent:function(t){if(this.maximise()){var e=$("body").width()-350,n=$("body").height()-150;$("#gpwnd_"+t).parent().parent(),this.$windowDiv.find(".menu_inner");if(750<=e&&(this.$windowDiv.find("#content").css("width",e-35),this.$windowDiv.find("#newthread").css("width",$("#forum").width()-5)),520<=n){var i=n-GtkMaximiseTabs.getForumTabsHeight()-80,o=i-55,r=!1;0<$("#newthread textarea.newthread").length?(this.$windowDiv.find("#newthread textarea.newthread").css("height",o-74),r=!0):0<$("#newthread textarea.newpoll").length&&(this.$windowDiv.find("#newthread textarea.newpoll").css("height",o-154),r=!0),this.$windowDiv.find("#wrapper, #content, #forum, #forum_admin").css("height",i),r&&(this.$windowDiv.find("#newthread").css("height",o),this.$windowDiv.find("#newthread form").css("height","100%"))}this.moveMaximiseForumButton(this.$windowDiv)}},getForumWindowId:function(){var t=GPWindowMgr.getByType(GPWindowMgr.TYPE_ALLIANCE_FORUM)[0];if(0<t.length)return t.getID()},moveMaximiseForumButton:function(t){0==t.find(".forum_footer").length&&t.find(".game_list_footer").append('<div class="forum_footer">'),t.find(".separate_forum_tab_link").removeClass("separate_forum_tab_link").appendTo(".forum_footer")},addResizeScreenListener:function(){$(window).on("resize",function(){if(GtkMaximiseForum.maximise()){var t=GPWindowMgr.getByType(GPWindowMgr.TYPE_ALLIANCE_FORUM);if(0<t.length){var e=t[0].getID();GtkMaximiseForum.maximiseWindow(e),GtkMaximiseForum.maximiseWindowContent(e)}}})}},GtkMaximiseTabs={$windowDiv:[],forum:{height:0,top:0,tabsHeight:0},rankings:{height:0,top:0},init:function(t,e){this.$windowDiv[e]=$("#gpwnd_"+t);var n=parseInt(this.$windowDiv[e].parent().parent().css("height")),i=parseInt(this.$windowDiv[e].parent().parent().css("top"));"forum"===e&&0===this.forum.height?(this.forum.height=n,this.forum.top=i,this.tabsHeight=0):"rankings"===e&&0===this.rankings.height&&(this.rankings.height=n,this.rankings.top=i),this.$windowDiv[e].closest(".ui-dialog").addClass("gtk-"+e+"-window")},isLoaded:function(t){return 0<this.$windowDiv[t].find(".gtk-tabs").length},modifyMenu:function(n){this.$windowDiv[n].parent().parent().find(".menu_inner, .next, .prev").hide();var t=this.$windowDiv[n].parent().parent().find(".menu_inner").html();this.$windowDiv[n].prepend('<div class="gtk-tabs"><ul>'+t+"</ul></div>"),this.$windowDiv[n].parent().parent().find(".gtk-tabs ul").children().each(function(t,e){GtkMaximiseTabs.$windowDiv[n].find(".gtk-tabs ul").prepend(e)}),this.$windowDiv[n].parent().parent().find(".gtk-tabs .submenu_link").click(function(){var t=$(this).attr("id");GtkMaximiseTabs.$windowDiv[n].parent().parent().find(".menu_inner #"+t).trigger("click")})},resetForumTabsHeight:function(){this.forum.tabsHeight=0},getForumTabsHeight:function(){return GtkSettings.getValue("forum_tabs_maximised")?GtkMaximiseTabs.forum.tabsHeight:(this.resetForumTabsHeight(),0)},setForumWindowPosition:function(){this.$windowDiv.forum.parent().parent().css({height:this.forum.height+this.forum.tabsHeight-15,top:this.forum.top-this.forum.tabsHeight})},modifyForumWindow:function(t,e){var n="forum";GtkSettings.getValue("forum_tabs_maximised")&&(GtkMaximiseTabs.init(t,n),!GtkMaximiseTabs.isLoaded(n)&&e&&(this.modifyMenu(n),this.forum.tabsHeight=this.$windowDiv[n].parent().parent().find(".gtk-tabs").height(),GtkMaximiseForum.maximise()||(this.setForumWindowPosition(),GtkMaximiseForum.moveMaximiseForumButton(this.$windowDiv[n]))))},modifyRankingsWindow:function(t){var e="rankings";GtkSettings.getValue("rankings_tabs_maximised")&&(GtkMaximiseTabs.init(t,e),GtkMaximiseTabs.isLoaded(e)||(this.modifyMenu(e),this.$windowDiv[e].find(".game_border").attr("id","rankings_content"),this.$windowDiv[e].parent().parent().css({height:this.rankings.height+40,top:this.rankings.top-20})))}},GtkMenu={scriptMenuArray:{},siteMenuArray:{},init:function(){this.setScriptMenuArray(),this.setSiteMenuArray(),this.prepareMainMenu(),this.addButtonToMainMenu(),this.addClickItemMenuListener(),this.addOpenScriptMenuListener(),this.addOpenSiteMenuListener(),this.addSlideUpMenuListener()},setScriptMenuArray:function(){this.scriptMenuArray={announcements:{text:GtkLang.announcements,icon:"bullhorn"},site:{text:GtkLang.site,icon:"gtk"},themes:{text:GtkLang.themes,icon:"paint-brush"},settings:{text:GtkLang.settings,icon:"cog"},shortcuts:{text:GtkLang.shortcuts,icon:"keyboard-o"},about:{text:GtkLang.about,icon:"info"}}},setSiteMenuArray:function(){this.siteMenuArray={stats:{text:GtkLang.stats,icon:"bar-chart"},maps:{text:GtkLang.maps,icon:"map-marker"},tools:{text:GtkLang.tools,icon:"wrench"},ally_section:{text:GtkLang.allianceSection,icon:"group"},forum:{text:GtkLang.forum,icon:"comments"},helpdesk:{text:GtkLang.helpdesk,icon:"question"}}},addClickItemMenuListener:function(){$("#ui_box").on("click",".gtk-panel-menu .main_menu_item",function(){switch($(this).attr("data-type")){case"announcements":GtkAnnouncements.openWindow();break;case"themes":GtkThemes.openWindow();break;case"settings":GtkSettings.openWindow();break;case"shortcuts":GtkShortcuts.toggleShortcuts();break;case"about":GtkAbout.openWindow();break;case"stats":GtkSite.openStats();break;case"maps":GtkSite.openMaps();break;case"tools":GtkSite.openTools();break;case"ally_section":GtkSite.openAllySection();break;case"forum":GtkSite.openForum();break;case"helpdesk":GtkSite.openHelpdesk()}})},addOpenScriptMenuListener:function(){$("#ui_box").on("click",".nui_main_menu li.gtk-menu",function(){$("#gtk-script-menu").is(":visible")?$("li.main_menu_item").removeClass("active"):$(this).addClass("active"),$("#gtk-script-menu").animate({width:"toggle"},400),$("#gtk-site-menu").hide()})},addOpenSiteMenuListener:function(){$("#ui_box").on("click",'#gtk-script-menu li.main_menu_item[data-type="site"]',function(){$("#gtk-site-menu").is(":visible")?$(this).removeClass("active"):$(this).addClass("active"),$("#gtk-site-menu").animate({width:"toggle"},400)})},addSlideUpMenuListener:function(){$("#ui_box").on("click",".slide_button",function(){$("#gtk-script-menu").is(":visible")&&($(".gtk-panel-menu").animate({width:"hide"},200),$("#gtk-shortcuts-menu").hide(),$("li.main_menu_item").removeClass("active"))})},createLi:function(t,e,n,i){return'<li class="'+t+'" data-type="'+e+'"><span class="content_wrapper"><span class="button_wrapper"><span class="button"><span class="gtk-icon gtk-icon-'+n+'"></span><span class="indicator"></span></span></span><span class="name_wrapper"><span class="name">'+i+"</span></span></span></li>"},createMenu:function(n,t){var i='<div id="'+t+'" class="gtk-panel-menu nui_main_menu"><div class="top"></div><div class="bottom"><div class="bottom_ornament"></div></div><div class="middle"><div class="content"><ul>',o="",r=0;return $.each(n,function(t,e){o="",0==r?o="first":r==Object.keys(n).length-1&&(o="last"),r++,i+=GtkMenu.createLi("main_menu_item "+o,t,e.icon,e.text)}),i+='</ul></div><div class="border"></div></div></div>'},prepareMainMenu:function(){$(".nui_main_menu li").removeClass("last"),$(".nui_main_menu ul:eq(0)").css("height","")},addButtonToMainMenu:function(){$(".nui_main_menu ul:eq(0)").append(GtkMenu.createLi("gtk-menu main_menu_item last","gtk","gtk","GrepolisToolkit"))},addGtkMenuToMainMenu:function(){$("#ui_box").after(".nui_main_menu").append(this.createMenu(this.scriptMenuArray,"gtk-script-menu")).append(this.createMenu(this.siteMenuArray,"gtk-site-menu"))},refresh:function(){$("#gtk-script-menu, #gtk-site-menu, .gtk-menu.main_menu_item").remove(),this.setScriptMenuArray(),this.setSiteMenuArray(),this.addButtonToMainMenu(),this.addGtkMenuToMainMenu()}},MapHelpers=require("map/helpers"),GtkPicomap={picomap:null,isEnabled:!1,init:function(){this.addDragMapListener(),this.addJumpMapListener()},showPicomap:function(){$("body").removeClass("gtk-picomap"),this.resetUI(),GtkSettings.getValue("picomap")?($("body").addClass("gtk-picomap"),this.updateUI(),this.loadMap(),this.refresh(),this.isEnabled=!0):this.isEnabled=!1},updateUI:function(){$(".topleft_navigation_area").prepend('<div id="picomap_wrapper" class="picomap_wrapper"></div>'),$(".topleft_navigation_area").prepend('<div id="picomap_overlayer"></div>'),$("#picomap_overlayer").append('<div id="picomap_sea"></div>'),$("#picomap_wrapper").append('<div id="picomap_canvas"></div>'),$("#picomap_canvas").append('<div id="picomap"></div>'),$("#picomap").append('<div id="picomap_islands_layer"></div>')},resetUI:function(){0<$("#picomap_wrapper").length&&$("#picomap_wrapper, #picomap_overlayer").remove()},loadMap:function(){this.picomap=new this.createPicomap,this.fillCanvas(),this.updateMapSeaNumber()},updateMapSeaNumber:function(){var t=$(".coords_box .coord.coord_x input").val(),e=$(".coords_box .coord.coord_y input").val(),n=WMap.getSea(t,e).join("");$("#picomap_sea").text(n)},fillCanvas:function(){this.picomap.fillCanvas()},refresh:function(){this.picomap.refresh(),GtkPicomap.updateMapSeaNumber()},addDragMapListener:function(){var t=!1,e=2;$("#map_move_container").mousedown(function(){t=!0}).mousemove(function(){t&&GtkPicomap.isEnabled&&(e<=0?(e=2,GtkPicomap.refresh()):e--)}).mouseup(function(){t=!1})},addJumpMapListener:function(){$.Observer(GameEvents.map.jump).subscribe(["pico"],function(t,e){GtkPicomap.isEnabled&&GtkPicomap.refresh()})},createPicomap:function(){var _=.125,w="pico",b={canvas:$("#"+w+"map_canvas"),picomap:$("#"+w+"map"),layer:$("#"+w+"map_islands_layer")},y=document,t={x:0,y:0},n={x:0,y:0},i=0,o=0,r=WMap.getMapSize()*WMap.getTileDimensions().x*_,a=WMap.getMapSize()*WMap.getTileDimensions().y*_,s={},d=this,l=b.canvas.height(),c=b.canvas.width();function h(){return t=MapHelpers.pixel2Map(c/_,l/_),{x:s.x,y:s.y,w:t.x,h:t.y}}function p(t){if(!t)return!1;var e,n,i,o,r,a,s,d=t.islands,l=function(t){var e,n,i={};for(e in t.towns)"inv_spo"===(n=t.towns[e]).type||n.invitation_spot||(i[n.x+"_"+n.y]||(i[n.x+"_"+n.y]=[]),i[n.x+"_"+n.y].push(n));return i}(t),c=!0,p=0,u=0,m=d.length;for(n=w+"_chunk_"+t.chunk.x+"_"+t.chunk.y,(e=y.createElement("div")).className="m_chunk",e.id=n;m--;){i=MapHelpers.map2Pixel(d[m].x,d[m].y),o=Math.floor(i.x*_),r=Math.floor(i.y*_),c&&(e.style.left=(p=o)+"px",e.style.top=(u=r)+"px",c=!1),s=w+"_i"+d[m].x+"_"+d[m].y,(a=y.createElement("div")).style.left=o-p+"px",a.style.top=r-u+"px",a.className="m_island gtk-picomap "+MapTiles.islands[d[m].type].img.replace(".png",""),a.id=s,e.appendChild(a);var g,h=d[m].x+"_"+d[m].y;if(g=l[h])for(var f,k=g.length;k--;)f=(w+"_t"+l[h][k].id).replace("=",""),l[h][k].fc&&!y.getElementById(f)&&l[h][k].nr<20&&a.appendChild(v(l[h][k]))}function v(t){var e=y.createElement("div");return e.id=f,e.style.left=~~(t.ox*_)+"px",e.style.top=~~(t.oy*_)+"px",e.style.color="#"+(t.fc||"f00"),t.type&&(e.style["font-size"]="50%"),e.innerHTML=t.type&&"inv_spo"===t.type||t.invitation_spot?"◉":"●",e.className="m_town",t.alliance_id&&(e.className+=" alliance_"+t.alliance_id),t.player_id&&(e.className+=" player_"+t.player_id),e}y.getElementById(e.id)||b.layer[0].appendChild(e)}this.fillCanvas=function(){var t=MapTiles.tileSize;s.x=WMap.mapX,s.y=WMap.mapY;var e={x:-(WMap.scroll.x+(WMap.size.x>>1)+t.x)*_,y:-(WMap.scroll.y+(WMap.size.y>>1)+t.y)*_};d.scrollMapTo({x:e.x,y:e.y}),function(t){var e=WMap.mapData.getCoveredChunks(t.x,t.y,t.w,t.h);WMap.mapData.checkReload(t.x,t.y,t.w,t.h,function(){for(var t=e.length;t--;)p(WMap.mapData.getChunk(e[t].x,e[t].y))})}(h()),this.drawBorders()},this.drawBorders=function(){var t,e,n,i,o,r,a=y.createDocumentFragment(),s=MapTiles.mapSize,d=s/10,l=_*MapHelpers.map2Pixel(d).x,c=h(),p=us.clamp(c.x,0,s),u=us.clamp(c.y,0,s),m=Math.ceil(c.w/d),g=Math.ceil(c.h/d);for(p-=p%d,u-=u%d,o=0;o<=m;o++)for(r=0;r<=g;r++)t=[p+d*o,u+d*r],e=MapHelpers.map2Pixel.apply(MapTiles,t),n=WMap.getSea(t[0],t[1]).join(""),y.getElementById(w+"_sea_"+n)||((i=y.createElement("div")).style.width=l+"px",i.style.height=l+"px",i.className="m_border",i.id=w+"_sea_"+n,i.style.left=e.x*_+"px",i.style.top=e.y*_+"px",i.innerHTML=n,a.appendChild(i));b.layer[0].appendChild(a)},this.refresh=function(){b.layer.empty(),this.fillCanvas()},this.scrollMapTo=function(t){n.x=Math.floor(us.clamp(t.x,-r,i)+c/2),n.y=Math.floor(us.clamp(t.y,-a,o)+l/2),b.picomap.css({translate:[n.x,n.y]});var e=MapHelpers.pixel2Map(-n.x/_,-n.y/_);s.x=e.x,s.y=e.y}}},GtkProfile={showLongerAllianceName:function(t){var e=$("#gpwnd_"+t).find(".members_list .header:eq(0)").contents().filter(function(){return 3==this.nodeType}).text();$("#gpwnd_"+t).find("#player_info h3").text(e)}},GtkSenatePoints={buildingsArray:null,init:function(){this.addUpgradeListener(),this.addTearDownListener(),this.addResourcesBuildingsTooltipListener()},calculateBuildingPoints:function(t,e){var n,i,o=GameData.buildings[t],r=o.points;for(i=0;i<e;i++)n=r,r=Math.floor(r*o.points_factor);return Math.floor(r-n)},resetBuildingArray:function(){this.buildingsArray={levelUp:{},tearDown:{}}},updateWindow:function(t){this.resetWindow(),this.resetBuildingArray(),this.updateArrayWithCommandsList(),"levelUp"==t||null==t&&$("#techtree").hasClass("build_cost_reduction_enabled")?this.updateLevelUpWindow():this.updateTearDownWindow(),this.totalCounter()},updateArrayWithCommandsList:function(){$(".gpwindow_content #building_tasks_main .queued_building_order").each(function(){var t=$(this).find(".building_icon40x40").attr("class").split(" ")[2],e=$(this).hasClass("tearing_down")?"tearDown":"levelUp";null==GtkSenatePoints.buildingsArray[e][t]?GtkSenatePoints.buildingsArray[e][t]=1:GtkSenatePoints.buildingsArray[e][t]+=1})},resetWindow:function(){$(".gtk-senate-little-points").remove(),$(".gtk-senate-total-points").remove()},updateLevelUpWindow:function(){$.each(GameData.buildings,function(t,e){($("#building_main_"+t+" .building a:eq(1)").hasClass("build")||!1===$("#building_main_"+t+" .building a:eq(1)").hasClass("disabled"))&&GtkSenatePoints.updateTreeBuildingLevel(t,"levelUp")})},updateTearDownWindow:function(){$.each(GameData.buildings,function(t,e){$("#building_main_"+t+" .building a:eq(2)").length&&GtkSenatePoints.updateTreeBuildingLevel(t,"tearDown")})},updateTreeBuildingLevel:function(t,e){var n=GtkSenatePoints.buildingsArray.tearDown[t],i=GtkSenatePoints.buildingsArray.levelUp[t];void 0===n&&(n=0),void 0===i&&(i=0);var o,r=parseInt($("#building_main_"+t+" .level").html())+parseInt(i)-parseInt(n);o="levelUp"==e?(r++,"+"):"-";var a=this.calculateBuildingPoints(t,r);$("#building_main_"+t+" .building div.name").css("width","129px").append('<span class="gtk-senate-little-points"> ('+o+a+")</span>")},totalCounter:function(){var r=0;$.each(this.buildingsArray.levelUp,function(t,e){var n=parseInt($("#building_main_"+t+" .level").html()),i=parseInt(e);if(isNaN(n))r+=GtkSenatePoints.calculateBuildingPoints(t,1);else for(var o=1;o<=i;o++)r+=GtkSenatePoints.calculateBuildingPoints(t,n+o)}),$.each(this.buildingsArray.tearDown,function(t,e){for(var n=parseInt($("#building_main_"+t+" .level").html()),i=parseInt(e),o=1;o<=i;o++)r-=GtkSenatePoints.calculateBuildingPoints(t,n-o)});var t=0<r?"+":"";0<$(".gtk-senate-total-points").length||$("#main_tasks h4:eq(0)").append('<span class="gtk-senate-total-points"> '+t+r+"pts</span>")},calculateNextFavorsProduction:function(t){var e=ITowns.towns[Game.townId],n=e.god(),i=MM.getModels().PlayerGods[Game.player_id].attributes.production_overview[n],o=i.production,r=e.buildingOrders()._byId,a=0;$.each(ITowns.towns,function(t,e){a+=e.buildings().attributes.temple,a=GtkSenatePoints.updateBuildingLevelWithOrdersList(r,"temple",a)});var s=this.roundValue(o/Game.game_speed)/this.roundValue(Math.sqrt(a));t?a++:a--;var d=this.roundValue(this.roundValue(Math.sqrt(a))*Game.game_speed),l=this.roundValue(d*s);return{godName:i.god.trim(),prod:l,diff:this.roundValue(l-o)}},calculateNextResourcesProduction:function(t,e){var n=this.getResourceName(t),i=ITowns.towns[Game.townId],o=i.buildings().attributes[t],r=i.buildingOrders()._byId,a=i.getProduction()[n];o=this.updateBuildingLevelWithOrdersList(r,t,o),e?o++:o--;var s=function(t){window.TownResources.call(this,t)};for(key in window.TownResources.prototype)s.prototype[key]=window.TownResources.prototype[key];s.prototype.getResourceBuildingLevel=function(t){return o};var d=3600*new s(MM.getModels().Town[Game.townId]).getProduction(n);return{prod:d,diff:this.roundValue(d-a)}},updateBuildingLevelWithOrdersList:function(t,n,i){return $.each(t,function(t,e){e.cid==t&&(e=e.attributes).building_type==n&&(e.tear_down?i--:i++)}),i},roundValue:function(t){return Math.round(10*t)/10},getResourceName:function(t){var e;switch(t){case"lumber":e="wood";break;case"stoner":e="stone";break;case"ironer":e="iron";break;case"temple":e="favor"}return e},addResourcesProductionToTooltip:function(t,e,n,i,o){var r=0<=o?"+":"",a=this.getResourceName(e),s="<strong>"+n+'</strong><br><img src="'+Game.urlImg+"/game/res/"+a+'.png" alt="'+e+'"><span>'+i+" ("+r+o+")</span>";if(t.find(".gtk-resources-notice").length<=0){s='<div class="gtk-resources-notice">'+s+"</div>";var d=$("#popup_content p"),l=$("#popup_content b"),c=$("#popup_content br:last-child");0<d.length?d.before(s):0<l.length?l.prev().before(s):c.after("<br>"+s)}else $(".gtk-resources-notice").html(s)},addUpgradeListener:function(){$(document).on("click","#upgrade_buildings",function(){GtkSenatePoints.updateWindow("levelUp")})},addTearDownListener:function(){$(document).on("click","#tear_down_buildings",function(){GtkSenatePoints.updateWindow("tearDown")})},addResourcesBuildingsTooltipListener:function(){$(document).on("mouseover","#buildings .building a.small, .city_overview_overlay .button_container div",function(){var t=!1,e=$("#popup_div"),n="Production par heure";if(null==(i=$(this).attr("data-building_id")))var i=$(this).parent().parent().attr("id").replace("building_main_","");var o=$("#techtree").hasClass("build_cost_reduction_enabled");switch(i){case"lumber":case"stoner":case"ironer":var r=GtkSenatePoints.calculateNextResourcesProduction(i,o);t=!0;break;case"temple":r=GtkSenatePoints.calculateNextFavorsProduction(o);n+=" ("+r.godName+")",t=!0}t&&setTimeout(function(){GtkSenatePoints.addResourcesProductionToTooltip(e,i,n,r.prod,r.diff)},255)})}},GtkSettings={init:function(){this.addMenuClickListener(),this.addSaveClickListener(),this.addDisconnectUserClickListener()},openWindow:function(){var e=GtkWindow.create(GPWindowMgr.TYPE_GTK_OPTIONS,"GrepolisToolkit - "+GtkLang.settings,800,600,{fullwindow:!0});GtkCommon.sendGetRequest("settings/show",{},function(t){GtkWindow.setContent(e,t),$("#gtk-settings .settings-link:eq(0)").click(),GtkSettings.updateDisconnectLink(e)},e)},sendData:function(){var t=$("#gtk-settings-form").serializeArray();GtkCommon.sendPostRequest("settings/update",{settings:t},function(t){HumanMessage.success(t.message),GtkSettings.saveBddSettings(t.settings),GtkSettings.applySettings()})},saveBddSettings:function(t){GtkDataManager.settings=t,$.cookie("gtk_settings_"+Game.player_id,btoa(JSON.stringify(t)),{expires:5e3,path:"/game",domain:".grepolis.com"})},applySettings:function(){GtkActivityLists.updateLists(),GtkPicomap.showPicomap(),GtkLanguageManager.setLanguage(this.getValue("language"),!0)},getValue:function(t){var e=$.cookie("gtk_settings_"+Game.player_id);return null!=GtkDataManager.settings?GtkDataManager.settings[t]:void 0!==e?JSON.parse(atob(e))[t]:void 0},updateDisconnectLink:function(t){var e=$("#gpwnd_"+t.getID()).find('.settings-link[data-type="logout"]'),n=$("#gpwnd_"+t.getID()).find('.settings-link[data-type="not_logged_in"]');return GtkCertification.hasCookie()?(e.show(),n.hide(),e):(e.hide(),n.show(),n)},addMenuClickListener:function(){$(document).on("click","#gtk-settings .settings-link",function(){var t=$(this).attr("data-type");$("#gtk-settings .settings-link").removeClass("underline"),$(this).addClass("underline"),$("#gtk-settings .section").hide(),$("#gtk-settings-"+t).show()})},addSaveClickListener:function(){$(document).on("click","#gtk-btn-save-options",function(){GtkSettings.sendData()})},addDisconnectUserClickListener:function(){$(document).on("click","#gtk-btn-disconnect-user",function(t){t.preventDefault();var e=$(this).attr("href"),n=$(this);GtkCommon.sendGetRequest(e,{},function(t){GtkCertification.disconnectUser();var e=GtkWindow.getWindowBySelector(n);$menuLink=GtkSettings.updateDisconnectLink(e),$menuLink.click()}),HumanMessage.success("Vous avez été déconnecté de GrepolisToolkit")})}},GtkShortcuts={shortcuts:{},init:function(){this.initShortcutsObj(),this.initShortcutsListeners(),this.addClickReturnButtonListener(),this.addClickHideShortcutsListener()},initShortcutsObj:function(){this.addCategory("normal","Usuels"),this.addShortcut("normal","academy",GtkLang.academy,"A",AcademyWindowFactory.openAcademyWindow),this.addShortcut("normal","zoom_map",GtkLang.zoomMap,"B",this.strategyMapSwitcher),this.addShortcut("normal","barracks",GtkLang.barracks,"C",BarracksWindowFactory.openBarracksWindow),this.addShortcut("normal","place_defense",GtkLang.placeDefense,"D",this.openPlaceWindow,["index"]),this.addShortcut("normal","fullscreen",GtkLang.fullscreen,"E",this.toggleFullScreen),this.addShortcut("normal","farm",GtkLang.farm,"F",this.openGameWindow,["farm"]),this.addShortcut("normal","hides",GtkLang.hides,"G",HideWindowFactory.openHideWindow),this.addShortcut("normal","inventory",GtkLang.inventory,"I",$(".toolbar_button.inventory"),"click"),this.addShortcut("normal","go_to_town",GtkLang.goToTown,"J",$(".btn_jump_to_town"),"click"),this.addShortcut("normal","place_culture",GtkLang.placeCulture,"K",PlaceWindowFactory.openPlaceWindow),this.addShortcut("normal","market",GtkLang.market,"M",this.openGameWindow,["market"]),this.addShortcut("normal","notes",GtkLang.notepad,"N",NotesWindowFactory.openNotesWindow),this.addShortcut("normal","place_units_beyond",GtkLang.placeOutsideUnits,"O",this.openPlaceWindow,["units_beyond"]),this.addShortcut("normal","docks",GtkLang.port,"P",DocksWindowFactory.openDocksWindow),this.addShortcut("normal","wall",GtkLang.walls,"R",this.openGameWindow,["wall"]),this.addShortcut("normal","senate",GtkLang.senate,"S",MainWindowFactory.openMainWindow),this.addShortcut("normal","temple",GtkLang.temple,"T",GodSelectionWindowFactory.openWindow),this.addShortcut("normal","place_simulator",GtkLang.placeSimulator,"Z",this.openPlaceWindow,["simulator"]),this.addShortcut("normal","close_all_windows",GtkLang.closeAllWindows,"ESC",GPWindowMgr.closeAll),this.addShortcut("normal","towns_list",GtkLang.townsList,"Down",this.dropTownList),this.addCategory("administrator","Administrateur"),this.addShortcut("administrator","trade",GtkLang.trade,"Shift+C",TownOverviewWindowFactory.openTradeOverview),this.addShortcut("administrator","orders",GtkLang.orders,"Shift+O",TownOverviewWindowFactory.openCommandOverview),this.addShortcut("administrator","recrutement",GtkLang.recrutement,"Shift+R",TownOverviewWindowFactory.openMassRecruitOverview),this.addShortcut("administrator","units",GtkLang.units,"Shift+U",TownOverviewWindowFactory.openUnitsOverview),this.addShortcut("administrator","outside_units",GtkLang.placeOutsideUnits,"Shift+E",TownOverviewWindowFactory.openOuterUnitsOverview),this.addShortcut("administrator","buildings",GtkLang.buildings,"Shift+B",TownOverviewWindowFactory.openBuildingOverview),this.addShortcut("administrator","culture",GtkLang.culture,"Shift+K",TownOverviewWindowFactory.openCultureOverview),this.addShortcut("administrator","gods",GtkLang.gods,"Shift+D",TownOverviewWindowFactory.openGodsOverview),this.addShortcut("administrator","hides",GtkLang.hides,"Shift+G",TownOverviewWindowFactory.openHidesOverview),this.addShortcut("administrator","towns",GtkLang.towns,"Shift+V",TownOverviewWindowFactory.openTownsOverview),this.addShortcut("administrator","groups",GtkLang.groups,"Shift+G",TownOverviewWindowFactory.openTownGroupsOverview),this.addCategory("capitain","Capitaine"),this.addShortcut("capitain","attack_planner",GtkLang.attackPlanner,"Shift+P",AttackPlannerWindowFactory.openAttackPlannerWindow),this.addShortcut("capitain","farming_villages",GtkLang.farmingVillages,"Shift+I",FarmTownOverviewWindowFactory.openFarmTownOverview),this.addCategory("gtk","GrepolisToolkit"),this.addShortcut("gtk","site",GtkLang.site,"Shift+W",GtkSite.openSite),this.addShortcut("gtk","stats",GtkLang.stats,"Shift+S",GtkSite.openStats),this.addShortcut("gtk","maps",GtkLang.maps,"Shift+M",GtkSite.openMaps),this.addShortcut("gtk","tools",GtkLang.tools,"Shift+T",GtkSite.openTools),this.addShortcut("gtk","ally_section",GtkLang.allianceSection,"Shift+A",GtkSite.openAllySection),this.addShortcut("gtk","forum",GtkLang.forum,"Shift+F",GtkSite.openForum)},addCategory:function(t,e){this.shortcuts[t]={title:e,data:{}}},addShortcut:function(t,e,n,i,o,r){this.shortcuts[t].data[e]={title:n,keys:i,handler:o,params:r}},initShortcutsListeners:function(){$.each(this.shortcuts,function(t,e){$.each(e.data,function(t,e){if("click"!==e.params)var n=void 0!==e.params?e.params.join(","):"";hotkeys(e.keys,function(){void 0===n?e.handler.click():e.handler(n)})})})},showShortcuts:function(){var n='<div id="gtk-shortcuts-menu"><div class="box top left"><div class="box top right"><div class="box top center"></div></div></div><div class="box middle left"><div class="box middle right"><div class="box middle center">';$.each(this.shortcuts,function(t,e){n+='<div class="column"><table><tr><td colspan="2"><div class="title">'+e.title+"</div></td></tr>",$.each(e.data,function(t,e){n+="<tr><td>"+e.keys+"</td><td>"+e.title+"</td></tr>"}),n+="</table></div>"}),n+='</div></div></div><div class="box bottom left"><div class="box bottom right"><div class="box bottom center"></div></div></div></div>',$("body").append(n),$("#gtk-shortcuts-menu").slideDown(400)},hideShortcuts:function(){$("#gtk-shortcuts-menu").slideUp(400,function(){$(this).remove()})},toggleShortcuts:function(){0<$("#gtk-shortcuts-menu").length?this.hideShortcuts():this.showShortcuts()},openPlaceWindow:function(t){return PlaceWindowFactory.openPlaceWindow(t,{})},openGameWindow:function(t){return BuildingWindowFactory.open(t)},toggleFullScreen:function(){var t=$("#ui_box > div:not(#main_area)"),e=$("#gtk-return-fullscreen");0<e.length?(e.remove(),t.css("visibility","visible")):($("body").append('<div id="gtk-return-fullscreen"><a href="#">'+GtkLang.back+"</a></div>"),t.css("visibility","hidden"))},dropTownList:function(){$(".town_groups_dropdown .button").click()},strategyMapSwitcher:function(){$(".island_view").hasClass("checked")?$(".strategic_map").click():$(".island_view").click()},addClickReturnButtonListener:function(){$(document).on("click","#gtk-return-fullscreen",function(){GtkShortcuts.toggleFullScreen()})},addClickHideShortcutsListener:function(){$(document).on("click","body",function(t){"shortcuts"!=$(t.target).closest(".main_menu_item").attr("data-type")&&GtkShortcuts.hideShortcuts()})},refresh:function(){this.initShortcutsObj()}},GtkSimulatorBuilder={simulatorData:{},init:function(){this.addClickAddToSimulatorListener()},appendButton:function(t,e){$("#"+t+" .gtk-btn-container").prepend(GtkCommon.createButton("Ajouter au simulateur",null,"gtk-btn-add-to-simulator",'data-id="'+e+'"'))},buildJsonUnitsFromImages:function(t,e,n){var i={att:{},def:{},def_mods:{building_wall:0,building_tower:0}};return t.each(function(){var t=$(this).attr("class").trim().split(" ").pop(),e=parseInt($(this).find(".place_unit_black").text());i.def[t]=e}),i.def_mods.building_wall=""==e?0:e,i.def_mods.building_tower=""==n?0:n,i},addButtonToSpyReports:function(){$(".published_report").each(function(){if(0<$(this).find(".espionage_report").length&&0==$(this).find(".gtk-btn-add-to-simulator").length){var t=Math.floor(1e5*Math.random()+1),e=parseInt($(this).find(".building_wall .place_unit_black").text()),n=parseInt($(this).find(".tower_wall .place_unit_black").text());GtkSimulatorBuilder.simulatorData[t]=GtkSimulatorBuilder.buildJsonUnitsFromImages($(this).find(".spy_units .report_unit"),e,n),GtkSimulatorBuilder.appendButton($(this).attr("id"),t)}})},addClickAddToSimulatorListener:function(){$(document).on("click",".gtk-btn-add-to-simulator",function(){var t=$(this).attr("data-id");PlaceWindowFactory.openPlaceWindow("simulator",GtkSimulatorBuilder.simulatorData[t])})}},GtkSimulatorInfos={resourcesArray:null,init:function(){this.addDisplayContainerListener()},initData:function(){this.resourcesArray={attacker:{wood:0,stone:0,iron:0,favor:0,population:0,battlePoints:0},defender:{wood:0,stone:0,iron:0,favor:0,population:0,battlePoints:0}}},updateWindow:function(t){this.initData(),this.calculateData(t),this.appendContainer(),this.appendButton()},calculateData:function(t){var e=GameData.units,n=$.parseJSON(t[0]).json;$.each(e,function(t,e){"militia"!=t&&(GtkSimulatorInfos.resourcesArray.attacker.wood+=e.resources.wood*n.att_losses[t],GtkSimulatorInfos.resourcesArray.attacker.stone+=e.resources.stone*n.att_losses[t],GtkSimulatorInfos.resourcesArray.attacker.iron+=e.resources.iron*n.att_losses[t],GtkSimulatorInfos.resourcesArray.attacker.favor+=e.favor*n.att_losses[t],GtkSimulatorInfos.resourcesArray.attacker.population+=e.population*n.att_losses[t],GtkSimulatorInfos.resourcesArray.attacker.battlePoints+=e.population*n.def_losses[t],GtkSimulatorInfos.resourcesArray.defender.wood+=e.resources.wood*n.def_losses[t],GtkSimulatorInfos.resourcesArray.defender.stone+=e.resources.stone*n.def_losses[t],GtkSimulatorInfos.resourcesArray.defender.iron+=e.resources.iron*n.def_losses[t],GtkSimulatorInfos.resourcesArray.defender.favor+=e.favor*n.def_losses[t],GtkSimulatorInfos.resourcesArray.defender.population+=e.population*n.def_losses[t],GtkSimulatorInfos.resourcesArray.defender.battlePoints+=e.population*n.att_losses[t])})},appendButton:function(){if($containerDiv=$("#place_simulator_form .game_list_footer"),0<$containerDiv.find("#gtk-btn-simulator-container").length)return!1;$containerDiv.append(GtkCommon.createButton("Ressources","gtk-btn-simulator-container"))},appendContainer:function(){var o=1,r=0;$("#gtk-simulator-container").remove(),$("#place_simulator").parent().parent().parent().append(GtkCommon.createInfoContainer("gtk-simulator-container","<table></table>")),$containerTable=$("#gtk-simulator-container table"),$containerTable.append("<tr><td></td></tr>"),$.each(this.resourcesArray,function(i,t){r=0,$containerTable.append("<tr></tr>"),$.each(t,function(t,e){if(1==o&&$containerTable.find("tr:eq(0)").append('<td><i class="gtk-icon-'+t+'"></i></td>'),$containerTr=$containerTable.find("tr:eq("+o+")"),0==r){var n="attacker"==i?"place_att":"place_def";$containerTr.append('<td><div class="place_symbol '+n+'"></div></td>')}$containerTr.append("<td>"+e+"</td>"),r++}),o++})},addDisplayContainerListener:function(){$(document).on("click","#gtk-btn-simulator-container",function(){var t=$("#gtk-simulator-container"),e=$(this).offset(),n=$(this).closest(".gpwindow_content").offset(),i=e.left-n.left+$(this).width()/2-t.width()/2;t.css("left",i).toggle(),t.is(":visible")&&GtkSimulatorInfos.addHideByClickListener()})},addHideByClickListener:function(){$(document).one("click","body",function(t){var e=$("#gtk-simulator-container");e.is(t.target)||0!==e.has(t.target).length||e.hide()})}},GtkSite={openSite:function(){window.open(GtkDataManager.urlSite)},openStats:function(){window.open(this.generateLink("stats_index"))},openMaps:function(){window.open(this.generateLink("maps_index"))},openTools:function(){window.open(this.generateLink("tools_index"))},openAllySection:function(){window.open(this.generateLink("alliance_section_index"))},openForum:function(){window.open(this.generateLink("forum_index"))},openHelpdesk:function(){window.open(this.generateLink("helpdesk_index"))},generateLink:function(t,e){var n=GtkDataManager.urlSite+"/"+GtkDataManager.worldName;switch(t){case"stats_index":n+="/stats";break;case"maps_index":n+="/maps";break;case"tools_index":n+="/tools";break;case"alliance_section_index":n+="/alliance_department";break;case"forum_index":n=GtkDataManager.urlSite+"/forum";break;case"helpdesk_index":n+="/support";break;case"town_profile":n+="/stats/town/"+e+"/";break;case"player_profile":n+="/stats/player/"+e+"/";break;case"alliance_profile":n+="/stats/alliance/"+e+"/";break;case"players_ranking":n+="/stats/ranking/players";break;case"alliances_ranking":n+="/stats/ranking/alliances";break;case"sea_profile":n+="/stats/sea/"+e+"/";break;case"players_sea_ranking":case"alliances_sea_ranking":n+="/stats/sea/"+e+"/rankings"}return n}},GtkSmileys={smileysArray:{"about-to-cry.png":":about-to-cry:","adore.png":":adore:","angel.png":":angel:","big-eyes.png":":bigeyes:","bored.png":":bored:","cool.png":":cool:","cross-mouth.png":":x:","crying.png":":crying:","cry.png":":cry:","disappointed.png":":disappointed:","fear.png":":fear:","furious.png":":furious:","blushing.png":":blushing:","kiss.png":":kiss:","happy.png":":happy:","inlove.png":":inlove:","keep-talking.png":":keep-talking:","laugh.png":":laugh:","nerd.png":":nerd:","ninja.png":":ninja:","pudently.png":":pudently:","regret.png":":regret:","shocked.png":":shocked:","shouting.png":":shouting:","sick-eyes.png":":sick-eyes:","sleeping.png":":sleeping:","smile.png":":smile:","struggle.png":":struggle:","study.png":":study:","thumbsup.png":":thumbsup:","annoyed.png":":annoyed:","wink.png":":wink:","worry.png":":worry:","grepolis-smile.png":":)","grepolis-laugh.png":":d","grepolis-unhappy.png":":(","grepolis-angry.png":":angry:","grepolis-smirk.png":":smirk:","grepolis-surprised.png":":surprised:","grepolis-doubtfully.png":":doubtfully:","grepolis-wink.png":";)","grepolis-hmmm.png":":hmmm:","grepolis-cool.png":":8","grepolis-chocked.png":":o","grepolis-anger.png":":anger:","grepolis-tig.png":":tig:","grepolis-hat.png":":hat:"},init:function(){this.addClickMenuListener(),this.addSelectSmileyListener(),this.addClickModifyMessageButtonListener()},updateWindow:function(t,e){GtkSettings.getValue("smileys_"+e)&&(this.addButtonToMenu(t),this.createMenu(t),this.convertPostsSmileys(t),this.alterSendButton(t),this.convertSmileysToText(t))},addButtonToMenu:function(t){$("#gpwnd_"+t+" .gtk-smiley").length||$("#gpwnd_"+t+" .bb_button_wrapper").append('<a title="'+GtkLang.smileys+'" href="#" class="bbcode_option gtk-smileys" name="smileys"><span></span></a>')},createMenu:function(n){$("#gpwnd_"+n+" .gtk-smiley").length||($("#gpwnd_"+n+" .bb_button_wrapper").append('<div class="gtk-smiley-chooser"><div class="bbcode_box middle_center"><div class="bbcode_box top_left"></div><div class="bbcode_box top_right"></div><div class="bbcode_box top_center"></div><div class="bbcode_box bottom_center"></div><div class="bbcode_box bottom_right"></div><div class="bbcode_box bottom_left"></div><div class="bbcode_box middle_left"></div><div class="bbcode_box middle_right"></div><div class="bbcode_box content clearfix"></div></div></div>'),$.each(this.smileysArray,function(t,e){$("#gpwnd_"+n+" .gtk-smiley-chooser .content").append('<img src="'+GtkDataManager.urlSmileyImg+t+'" class="gtk-smiley" name="'+e+'" title="'+e+'"/><br>')}))},convertPostsSmileys:function(t){$("#gpwnd_"+t).find(".message_post_content, #message_new_preview_body, #message_reply_preview_body, .post .content p, .chat_line_message").html(function(t,o){return $.each(GtkSmileys.smileysArray,function(i,t){$.each([t,t.toUpperCase()],function(t,e){var n=new RegExp(GtkSmileys.escapeRegExp(e),"mg");o=o.replace(n,'<img src="'+GtkDataManager.urlSmileyImg+i+'"/>')})}),o})},unbindMessageButtons:function(){$("#btn_message_sent").unbind(),$("#btn_message_preview_sent").unbind()},alterSendButton:function(t){var e=$("#gpwnd_"+t).find("#btn_message_sent, #btn_message_preview_sent");0<e.length&&(this.unbindMessageButtons(),e.attr("onclick","return Message.create('new', true);"));var n=$("#gpwnd_"+t).find('#btn_message_sent, #btn_message_preview_sent, #message_new a.button:first, #message_reply_create a.button:first, #message_reply_preview a.button:first, #forum a[onclick="Forum.postSave()"], #forum a[onclick="Forum.threadCreate()"]'),i=n.attr("onclick");void 0!==i&&-1==i.indexOf("GtkSmileys")&&n.attr("onclick","GtkSmileys.convertTextboxToSmileys("+t+");"+i)},convertTextboxToSmileys:function(t,e){$("#gpwnd_"+t+" textarea").val(function(t,o){return $.each(GtkSmileys.smileysArray,function(i,t){$.each([t,t.toUpperCase()],function(t,e){var n=new RegExp(GtkSmileys.escapeRegExp(e),"mg");o=o.replace(n,"[img]"+GtkDataManager.urlSmileyImg+i+"[/img]")})}),o})},convertSmileysToText:function(t){$("#gpwnd_"+t+" textarea").val(function(t,i){return $.each(GtkSmileys.smileysArray,function(t,e){var n=new RegExp(GtkSmileys.escapeRegExp("[img]"+GtkDataManager.urlSmileyImg+t+"[/img]"),"mg");i=i.replace(n,e)}),i})},escapeRegExp:function(t){return t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+"(?!\\S)"},addClickMenuListener:function(){$(document).on("click",".bb_button_wrapper .bbcode_option.gtk-smileys",function(){$(".gtk-smiley-chooser").toggle()})},addSelectSmileyListener:function(){$(document).on("click",".gtk-smiley-chooser .gtk-smiley",function(){var t=$(this).attr("name");$(this).closest(".game_inner_box").find("textarea").insertAtCaret(t),$(".gtk-smiley-chooser").hide()})},addClickModifyMessageButtonListener:function(){$(document).on("click","#btn_message_preview_edit",function(){GtkSmileys.unbindMessageButtons()})}},GtkSounds={sounds:{attack_incoming:{event:GameEvents.attack.incoming,category:"effects",file:"000001_Angriff_Version_01",setting:"sound_attack_incoming"},message_arrive:{event:GameEvents.notification.message.arrive,category:"effects",file:"002004_Nachricht_erhalten_Version_02",setting:"sound_message_arrive"},message_chat:{event:null,category:"effects",file:"003009_Forum_und_Chat_Version_01",setting:"sound_message_chat"}},init:function(){this.registerSounds()},getSound:function(t){return this.sounds[t]},playSound:function(t){new Audio("https://gpfr.innogamescdn.com/audio/"+t.category+"/"+t.file+".ogg").play()},registerSounds:function(){$.each(this.sounds,function(t,n){null!=n.event&&$.Observer(n.event).subscribe("game_sounds",function(t,e){GtkSettings.getValue(n.setting)&&!Game.Audio.categoryEnabled(n.category)&&GtkSounds.playSound(n)})})}},GtkStats={showButton:function(t,e,n){var i=$("#gpwnd_"+t);switch(e){case"town_profile":if(i.find("#gtk-btn-alliance-profile-town").length)return;var o=i.find("#town_bbcode_id").val().replace("[town]","").replace("[/town]","");i.find("#towninfo_towninfo .game_list .list_item_right.town").prepend(this.generateButton("gtk-btn-town-profile",GtkSite.generateLink(e,o)));var r=i.find("#towninfo_towninfo a.gp_player_link").attr("href").split(/#/),a=$.parseJSON(atob(r[1]||r[0])).id;i.find(".write_message").parent().prepend(this.generateButton("gtk-btn-player-profile-town",GtkSite.generateLink("player_profile",a))).css("width","93px");var s=i.find(".jmp_2_town").parent().text().split(" ")[3];if(i.find(".jmp_2_town").parent().prepend(this.generateButton("gtk-btn-sea-profile-town",GtkSite.generateLink("sea_profile",s))),i.find('a[onclick^="Layout.allianceProfile"]').length){var d=i.find('a[onclick^="Layout.allianceProfile"]').attr("onclick").replace(")","").split(",")[1];i.find('a[onclick^="Layout.allianceProfile"]').parent().find(".list_item_right").prepend(this.generateButton("gtk-btn-alliance-profile-town",GtkSite.generateLink("alliance_profile",d))).css("width","50px")}break;case"player_profile":if(i.find("#gtk-btn-player-profile").length)return;i.find("#player_buttons").append(this.generateButton("gtk-btn-player-profile",GtkSite.generateLink(e,n)));break;case"alliance_profile":if(i.find("#gtk-btn-alliance-profile").length)return;i.find("#ally_buttons").append(this.generateButton("gtk-btn-alliance-profile",GtkSite.generateLink(e,n)));break;case"players_ranking":if(i.find("#gtk-btn-players-ranking").length)return;$('input[id="player_name"]').css("width","200px"),i.find("#ranking_search").append(this.generateButton("gtk-btn-players-ranking",GtkSite.generateLink(e)));break;case"alliances_ranking":if(i.find("#gtk-btn-alliances-ranking").length)return;$('input[id="alliance_name"]').css("width","200px"),i.find("#ranking_search").append(this.generateButton("gtk-btn-alliances-ranking",GtkSite.generateLink(e)));break;case"players_sea_ranking":if(i.find("#gtk-btn-players-sea-ranking").length)return;s=$('input[id="seaid"]').val();i.find("#ranking_search").append(this.generateButton("gtk-btn-players-sea-ranking",GtkSite.generateLink(e,s)));break;case"alliances_sea_ranking":if(i.find("#gtk-btn-alliances-sea-ranking").length)return;s=$('input[id="seaid"]').val();i.find("#ranking_search").append(this.generateButton("gtk-btn-alliances-sea-ranking",GtkSite.generateLink(e,s)));break;case"alliances_recruitement":if(i.find("#gtk-btn-alliances-recruitement").length)return;i.find("#ally_finder_text tbody tr").each(function(){var t=$(this).find(".ally_application div").attr("data-alliance_id");$(this).find(".ally_application").append(GtkStats.generateButton("gtk-btn-alliances-recruitement",GtkSite.generateLink("alliance_profile",t)))})}},generateButton:function(t,e){return'<a id="'+t+'" class="gtk-btn-stats" target="_blank" href="'+e+'"></a>'}},GtkThemes={activeTheme:null,init:function(){this.addPreviewGodListener(),this.addSwitchGodListener(),this.addChangeThemeListener()},openWindow:function(){var e=GtkWindow.create(GPWindowMgr.TYPE_GTK_THEMES,"GrepolisToolkit - "+GtkLang.themes,800,600);GtkCommon.sendGetRequest("themes/show",{},function(t){GtkWindow.setContent(e,t),$("#gtk-themes .gtk-switch-god a:eq(0)").click()},e)},addPreviewGodListener:function(){$(document).on("click","#gtk-themes .gtk-presentation-god:visible .god_mini",function(){var t=$(this).attr("data-name");$("#gtk-themes .gtk-presentation-god:visible .gtk-big-god").attr("class","gtk-big-god "+t)})},addSwitchGodListener:function(){$(document).on("click","#gtk-themes .gtk-switch-god .god_mini",function(){var t=$(this).attr("data-name");$("#gtk-themes .gtk-presentation-god").css("display","none"),$("#gtk-themes .gtk-presentation-"+t).fadeIn().css("display","block"),$("#gtk-themes .gtk-switch-god .god_mini").removeClass("selected"),$(this).addClass("selected"),$("#gtk-themes .gtk-presentation-god:visible .god_mini:eq(0)").click(),t==GtkThemes.activeTheme||"none"==t&&null==GtkThemes.activeTheme?GtkThemes.changeBtnStatus(!1):GtkThemes.changeBtnStatus(!0)})},addChangeThemeListener:function(){$(document).on("click","#gtk-btn-change-theme",function(){var t=$("#gtk-themes .god_mini.selected").attr("data-name");GtkThemes.changeBtnStatus(!1),GtkThemes.changeTheme(t),GtkThemes.sendData()})},changeTheme:function(t){this.removeThemeClass(),"none"!=(this.activeTheme=t)&&$("body").addClass("gtk-theme-"+t)},removeThemeClass:function(){$body=$("body"),$body.attr("class",$body.attr("class").replace(/gtk-theme-[^\s]+/,""))},changeBtnStatus:function(t){var e,n;n=t?(e="Appliquer le thème","button"):(e="Thème actif","button inactive"),$("#gtk-btn-change-theme span:eq(2)").html(e),$("#gtk-btn-change-theme").attr("class",n)},sendData:function(){GtkCommon.sendPostRequest("themes/update",{themeName:this.activeTheme},function(t){HumanMessage.success(t.message)})}},GtkVarious={init:function(){this.addEmptyUnitInputsListener(),this.addTriggerSpellListener(),this.addRedirectionListener(),this.addResourceTooltipsListener()},skipRedirectionWindow:function(t,e){if(GtkSettings.getValue("redirection_link")){t.preventDefault();var n=$(e).attr("data-href").split("url=")[1];void 0!==n&&window.open(decodeURIComponent(n))}},showFarmingFinishTime:function(t){var e,n,i,o;if(-1!=$("#gpwnd_"+t+" .farm_next_claim_time:eq(0)").text().indexOf(":")){var r=$("#ui_box .server_time_area").text().split(" ")[0].split(":"),a=$("#gpwnd_"+t+" .farm_next_claim_time").text().split(":");e=parseInt(r[0])+parseInt(a[0]),n=parseInt(r[1])+parseInt(a[1]),i=parseInt(r[2])+parseInt(a[2]),o=GtkCommon.formatTime(e,n,i),$("#gpwnd_"+t+" .farm_next_claim:eq(0)").append('<div class="farm_next_claim bold" id="gtk-farming-finish-time">'+GtkLang.finishedAt+' <span class="farm_next_claim_time">'+o[1]+":"+o[2]+":"+o[3]+"</span></div>")}},addSpeelsToUnitWindow:function(t,e){var n=0<$(".casted_powers_area ."+e).length,i=parseInt($(".gods_favor_amount").text()),o=n||60<=i?"":"disabled";$("#gpwnd_"+t+" #unit_order_count").after("</h4>").append('<a href="#" class="power_icon24x24 '+e+" gtk-icon-spell "+o+'" data-type="'+e+'"></a>')},triggerSpell:function(t){if($(".gods_spells_menu").is(":visible"))$('.gods_spells_menu div[data-power_id="'+t+'"]').click();else{var e=$(".btn_gods_spells");e.click(),setTimeout(function(){e.click()},300),$('.gods_spells_menu div[data-power_id="'+t+'"]').click()}},emptyUnitInputs:function(t){$("#gpwnd_"+t+" .unit_input").val("")},addDeselectButton:function(t){$('<a class="gtk-deselect-units" href="#">'+GtkLang.deselectAllUnits+"</a>").insertAfter("#gpwnd_"+t+" .send_units_form .select_all_units")},addEmptyUnitInputsListener:function(){$(document).on("click",".gtk-deselect-units",function(){var t=$(this).closest(".gpwindow_content").attr("id").replace("gpwnd_","");GtkVarious.emptyUnitInputs(t)})},addFinishTimeInResourceTooltip:function(t){if($("#gtk-popup-finish-time").length<=0){var e=$(".indicator."+t+" .amount").html(),n=$("#popup_div span:eq(1)").text().match(/\d+/)-e;if(0<n){var i=$("#popup_div span:eq(0)").text().match(/\d+/),o=(Math.round(n/i*100)/100).toString().split("."),r=$("#ui_box .server_time_area").text().split(" ")[0].split(":"),a=parseInt(r[0])+parseInt(o[0]),s=parseInt(r[1])+parseInt(o[1]),d=GtkCommon.formatTime(a,s,0);$("#popup_div span:eq(1)").append(' <span id="gtk-popup-finish-time">('+d[0]+" "+d[1]+":"+d[2]+")</span>")}}},addTriggerSpellListener:function(){$(document).on("click",".gtk-icon-spell",function(){if(!$(this).hasClass("disabled")){var t=$(this).attr("data-type");GtkVarious.triggerSpell(t)}})},addRedirectionListener:function(){$(document).on("click",".game_border .post .content a:not(.button), #player_profile a, #ally_profile a",function(t){GtkVarious.skipRedirectionWindow(t,this)})},addResourceTooltipsListener:function(){$(document).on("mouseover",".indicator",function(){var t=$(this).attr("data-type");setTimeout(function(){GtkVarious.addFinishTimeInResourceTooltip(t)},255)})}},GtkWelcomeWindow={welcomeWindows:null,init:function(){this.addNextStepListener()},nextStepDispatcher:function(t){switch(t){case 2:this.replaceWindowContent(this.welcomeWindows[1]);break;case 3:GtkSettings.openWindow(),this.replaceWindowContent(this.welcomeWindows[2]);break;case 4:this.replaceWindowContent(this.welcomeWindows[3]);break;case 5:this.closeWindow()}},replaceWindowContent:function(t){$("#gtk-welcome-window").html(t)},openWindow:function(){$("#main_area").append(this.welcomeWindows[0]),$("#gtk_welcome_window").delay(2e3).slideDown(1e3),this.setCookie()},closeWindow:function(){$("#gtk-welcome-window").slideUp()},getCookie:function(){return void 0!==$.cookie("gtk_welcome_"+Game.player_id)?1:0},setCookie:function(){$.cookie("gtk_welcome_"+Game.player_id,1,{expires:5e3,path:"/game",domain:".grepolis.com"})},addNextStepListener:function(){$(document).on("click",".gtk-btn-next-step-welcome",function(){var t=$(this).attr("data-step-id");GtkWelcomeWindow.nextStepDispatcher(parseInt(t))})}},GtkWindow={init:function(){this.addTabClickListener()},create:function(t,e,n,i,o){var r=GPWindowMgr.Create(t,e,o);return r.setWidth(n),r.setHeight(i),r.setPosition(["center","center"]),r},setContent:function(t,e){if(e.hasOwnProperty("tabs")){var n='<div class="menu_wrapper minimize closable" style="left: 76px;"><ul class="menu_inner" style="width: 5000px; ">';$.each(e.tabs,function(t,e){n+=GtkWindow.createTabHtml(t,e.title,e.url,e.option)}),n+="</ul></div>";var i=$("#gpwnd_"+t.getID()).parent().parent().find(".ui-dialog-titlebar");i.prepend(n),i.find(".gtk-tab:last").addClass("active")}t.setContent2(GtkWindow.createContentHtml(e.html))},createTabHtml:function(t,e,n,i){var o="";return null!=i&&(o='data-option="'+i+'"'),'<li><a class="submenu_link gtk-tab" href="#" id="gtk-tab-'+t+'" '+o+' data-name="'+t+'"><span class="left"><span class="right"><span class="middle">'+e+"</span></span></span></a></li>"},createContentHtml:function(t){return'<div class="gtk-content">'+t+"</div>"},getWindowBySelector:function(t){var e=parseInt(t.closest(".gpwindow_content").attr("id").replace("gpwnd_",""));return GPWindowMgr.getWindowById(e)},addTabClickListener:function(){$(document).on("click",".gtk-tab",function(){$gpWindowDiv=$(this).closest(".ui-dialog").find(".gpwindow_content"),$gpWindowDiv.removeClass("fullwindow");var t=$(this).attr("data-name");$gpWindowDiv.find(".gtk-content").empty(),$(this).closest(".menu_inner").find(".submenu_link.active").removeClass("active"),$(".menu_inner #gtk-tab-"+t).addClass("active"),"fullwindow"==$(this).attr("data-option")&&$gpWindowDiv.addClass("fullwindow")})}},GtkCommonExportation={getOptionsAsSerialiazeArray:function(t){var e=[];return t.find('input[type="checkbox"]').each(function(){var t=$(this).is(":checked")?"on":"off";e.push({name:this.name,value:t})}),e},addOptionToList:function(t,e,n,i,o){t[e]={selector:n,label:i,display:void 0!==o&&o}},generateOption:function(t,e,n){return GtkCommonExportation.generateCheckboxHtml(e,t[e].selector,t[e].label,t[e].display,n)},generateCheckboxHtml:function(t,e,n,i,o){return'<li><input type="checkbox" id="checkbox_'+t+'" name="'+t+'" class="gtk-checkbox" data-selector="'+e+'" data-display="'+i+'" data-type="'+o+'" checked><label for="checkbox_'+t+'"><span></span>'+n+"</label></li>"},addListOptions:function(n,t){$.each(t,function(t,e){n[t]=e})},showOptionsPanel:function(t,i){var o='<div class="gtk-export-options-panel"><div class="box top left"><div class="box top right"><div class="box top center"></div></div></div><div class="box middle left"><div class="box middle right"><div class="box middle center"><table><tr><th colspan="2">Réglages</th></tr>';void 0!==t?$.each(t,function(t,e){var n=e.value?"gtk-checkbox-checked":"";o+="<tr><td>"+i[e.name].label+'</td><td><div class="gtk-checkbox '+n+'"></div></td></tr>'}):o+='<tr><td colspan="2">'+GtkLang.unknownDetails+"</td></tr>",o+='</table></div></div></div><div class="box bottom left"><div class="box bottom right"><div class="box bottom center"></div></div></div></div></div>',$("body").append(o)},addThumbnailListener:function(t){$(".gtk-"+t+"-manager img").lazyload({container:$(".gtk-"+t+"-manager .gtk-data-container")})}},GtkConquestExporter={type:"conquest",movementId:0,init:function(){this.addNewExportListener(),this.addManageExportListener(),this.addRefreshExportListener(),this.addDeleteImageListener(),this.addCopyLinkListener()},getContainer:function(t){return $("#gpwnd_"+t).find(".tab_content")},updateWindow:function(t,e,n){GtkSettings.getValue("exportation_conquests")&&(null!=n?this.movementId=n:n=this.movementId,GtkMovementAbstractExporter.updateWindow(t,this.type,e,n,this.getContainer(t)))},addNewExportListener:function(){GtkMovementAbstractExporter.addNewExportListener(this.type,this.getContainer)},addManageExportListener:function(){GtkMovementAbstractExporter.addManageExportListener(this.type)},addRefreshExportListener:function(){GtkMovementAbstractExporter.addRefreshExportListener(this.type,this.getContainer)},addDeleteImageListener:function(){GtkMovementAbstractExporter.addDeleteImageListener(this.type,this.getContainer)},addCopyLinkListener:function(){GtkMovementAbstractExporter.addCopyLinkListener(this.type)}},GtkMessageExporter={init:function(){this.addOpenWindowListener(),this.addCopyListener()},addButtons:function(){this.addUniqueButtons()},openWindow:function(t){var e='<center><textarea id="gtk-bbcode-message" readonly="readonly">'+t+"</textarea>"+GtkCommon.createButton(GtkLang.copy,"gtk-copy-message-quote",null,'data-clipboard-target="#gtk-bbcode-message"')+"</center>",n=GtkWindow.create(GPWindowMgr.TYPE_GTK_MESSAGE_EXPORTER,"GrepolisToolkit - "+GtkLang.exportMessageAsBBCode,400,250);GtkWindow.setContent(n,{html:e})},addUniqueButtons:function(){GtkSettings.getValue("exportation_messages")&&$(".message_poster_id").prepend('<a class="gtk-btn-export-message message_icon" href="#" title="'+GtkLang.export+'"></a>')},convertHtmlToBBCode:function(t){var i,e,n=t.html();return t.find("span").each(function(){e=$(this)[0].outerHTML,i=e,$(this).hasClass("bbcodes_font")&&(i=i.replace(/<span class="bbcodes bbcodes_font (.*?)">([\s\S]*)<\/span>/gi,"[font=$1]$2[/font]")),$(this).hasClass("bbcodes_color")&&(i=i.replace(/<span class="bbcodes bbcodes_color" style="color:(.*?)">([\s\S]*)<\/span>/gi,"[color=$1]$2[/color]")),$(this).hasClass("bbcodes_size")&&(i=i.replace(/<span class="bbcodes bbcodes_size" style="font-size:(.*?)pt">([\s\S]*)<\/span>/gi,"[size=$1]$2[/size]")),$(this).hasClass("bbcodes_town")&&(i=GtkMessageExporter.replaceTownNameById($(this).find("a"),i)),n=n.replace(e,i)}),t.find(".reservation_list").each(function(){$link=$(this).find(".col_town_name a"),e=$link[0].outerHTML,i=e,i=GtkMessageExporter.replaceTownNameById($link,i),n=n.replace(e,i)}),t.find(".grepolis_score").each(function(){e=$(this)[0].outerHTML,i=(i=(i=e).replace(/\s+</g,"<")).replace(/>\s+/g,">"),n=n.replace(e,i)}),t.find(".bbcodes_quote").each(function(){e=$(this)[0].outerHTML,i=(i=(i=e).replace(/<div class="bbcodes bbcodes_quote quote"><div class="quote_author bold small">(.*?)<\/div><div class="quote_message small">([\s\S]*)<\/div><\/div>/gi,"[quote=$1]$2[/quote]")).replace(" "+GtkLang.quoteAuthorText,""),n=n.replace(e,i)}),t.find(".bbcodes_spoiler").each(function(){e=$(this)[0].outerHTML,i=(i=e).replace(/<div class="bbcodes bbcodes_spoiler">([\s\S]*)<b>(.*?)<\/b>([\s\S]*)<div class="bbcodes_spoiler_text" (.*?)>([\s\S]*)<\/div>([\s\S]*)<\/div>/gi,"[spoiler=$2]$5[/spoiler]"),n=n.replace(e,i)}),t.find("table").each(function(){e=$(this)[0].outerHTML,i="[table]",$(this).find("tr").each(function(){var t=$(this).find("th").length,e=$(this).find("td").length+t,n=0;i+=0<t?"[**]":"[*]",$(this).find("th, td").each(function(){n++,i+=$(this).text(),i+=n<e?"[|]":""}),i+=0<t?"[/**]":"[/*]"}),i+="[/table]",n=n.replace(e,i)}),n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=n.replace(/<br(.*?)>/gi,"")).replace(/<center>/gi,"[center]")).replace(/<\/center>/gi,"[/center]")).replace(/<b>/gi,"[b]")).replace(/<\/b>/gi,"[/b]")).replace(/<i>/gi,"[i]")).replace(/<\/i>/gi,"[/i]")).replace(/<u>/gi,"[u]")).replace(/<\/u>/gi,"[/u]")).replace(/<s>/gi,"[s]")).replace(/<\/s>/gi,"[/s]")).replace(/<a href="#" class="bbcodes bbcodes_player" (.*?)>(.*?)<\/a>/gi,"[player]$2[/player]")).replace(/<span class="bbcodes bbcodes_player">(.*?)<\/span>/gi,"[player]$1[/player]")).replace(/<span class="bbcodes bbcodes_ally"><a href="(.*?)" (.*?)>(.*?)<\/a><\/span>/gi,"[ally]$3[/ally]")).replace(/<span class="bbcodes bbcodes_ally_deleted">(.*?)<\/span>/gi,"[ally]$1[/ally]")).replace(/<span class="bbcodes bbcodes_town"><a href="(.*?)" (.*?)>(.*?)<\/a><\/span>/gi,"[town]$3[/town]")).replace(/<span class="bbcodes bbcodes_town">(.*?)<\/span>/gi,"[town]$1[/town]")).replace(/<span class="bbcodes bbcodes_island"><a href="(.*?)" (.*?)>(.*?) (.*?)<\/a><\/span>/gi,"[island]$4[/island]")).replace(/<span class="bbcodes bbcodes_island">(.*?) (.*?)<\/span>/gi,"[island]$2[/island]")).replace(/<div class="grepolis_score bbcode"><div class="bbcode_playername">(.*?)<\/div>(.*?)<\/div><\/div>/gi,"[score]$1[/score]")).replace(/<div class="game_border reservation_list">([\s\S]*)<a (.*?)>(.*?)<\/a>([\s\S]*)<\/script>/gi,"[reservation]$3[/reservation]")).replace(/<img(.*?)src="(.*?)"(.*?)>/gi,"[img]$2[/img]")).replace(/<a(.*?)href="(.*?)"(.*?)>(.*?)<\/a>/gi,"[url=$2]$4[/url]")).replace(/<script(.*?)>([\s\S]*)<\/script>/gi,"")).replace(/<style(.*?)>([\s\S]*)<\/style>/gi,""),$("<div/>").html(n).text().trim()},replaceTownNameById:function(t,e){var n=t.attr("href"),i=t.text();if(null!=n&&0<=n.indexOf("#")){var o=JSON.parse(atob(n.replace("#",""))).id;e=e.replace(">"+i+"<",">"+o+"<")}return e},addOpenWindowListener:function(){$(document).on("click",".gtk-btn-export-message",function(){var t=$(this).parent().parent().parent().find(".message_post_content"),e=GtkMessageExporter.convertHtmlToBBCode(t),n=$(this).parent().parent().find("a.gp_player_link").html(),i=$(this).parent().parent().find(".message_date").text().split(" "),o=i.length-1,r=$("#ui_box .server_time_area").text().split(" ");if(void 0===n)n="grepolis";-1==i[o-2].indexOf("/")?dateFinal=r[1]:dateFinal=i[o-2],timeFinal=i[o];var a="[quote="+("("+dateFinal.trim()+" "+timeFinal.trim()+")")+", "+n+"]"+e+"[/quote]";GtkMessageExporter.openWindow(a)})},addCopyListener:function(){new ClipboardJS("#gtk-copy-message-quote").on("success",function(){setTimeout(function(){HumanMessage.success(GtkLang.BBCodeHasBeenCopied)},50)})}},GtkMovementAbstractExporter={addButtonToWindow:function(t,e,n,i){i.append(GtkCommon.createButton(t,"gtk-btn-"+n+"-"+e+"-export")),1<i.find(".button").length&&$("#gtk-btn-"+n+"-"+e+"-export").css("margin-right",120)},appendNewExportButton:function(t,e,n,i){this.canAddElement(n,"gtk-btn-new-"+t+"-export",i)&&($("#gtk-btn-manage-"+t+"-export").remove(),this.addButtonToWindow(GtkLang.exportAsImage,t,"new",i),this.closeManageContainer(t),$("#gtk-btn-new-"+t+"-export").attr({"data-movement-id":n,"data-movement-type":e}))},appendManageExportButton:function(t,e,n,i,o,r){this.canAddElement(n,"gtk-btn-refresh-"+t+"-export",r)&&($("#gtk-btn-new-"+t+"-export").remove(),this.addButtonToWindow("Gérer l'exportation",t,"manage",r),$("#gtk-"+t+"-export-container .gtk-"+t+"-export-input").html("Image: "+GtkCommon.createTextBox("gtk-"+t+"-export-link",o)+GtkCommon.createButton("Copier","gtk-"+t+"-copy-link",null,'data-clipboard-target="#gtk-'+t+'-export-link"')),$("#gtk-"+t+"-export-container .gtk-"+t+"-export-buttons").html(GtkCommon.createButton("Mettre à jour","gtk-btn-refresh-"+t+"-export")+GtkCommon.createButton("Supprimer","gtk-btn-delete-"+t+"-export")),$("#gtk-btn-manage-"+t+"-export, #gtk-btn-refresh-"+t+"-export, #gtk-btn-delete-"+t+"-export").attr({"data-movement-id":n,"data-movement-type":e,"data-movement-code":i}))},createManageContainer:function(t,e){$("#gpwnd_"+t).append(GtkCommon.createInfoContainer("gtk-"+e+"-export-container",'<h3></h3><div class="divider"></div><div class="gtk-'+e+'-export-input"></div><div class="divider"></div> <div class="gtk-'+e+'-export-buttons"></div>')),$("#gtk-"+e+"-export-container h3").text("Gestion de l'exportation")},closeManageContainer:function(t){$("#gtk-"+t+"-export-container").hide()},canAddElement:function(t,e,n){return n.find("#"+e).length<=0&&(n.find("a.button").length<=0||0<n.find("#cancel_command_"+t).length)||0<n.find('.gtk-button[data-movement-id="'+t+'"]').length||0<n.find(".button.publish_btn").length},updateWindow:function(t,e,n,i,o){this.createManageContainer(t,e),GtkCommon.sendGetRequest(e+"/check",{movementId:i,movementType:n},function(t){t.link?GtkMovementAbstractExporter.appendManageExportButton(e,n,i,t.code,t.link,o):GtkMovementAbstractExporter.appendNewExportButton(e,n,i,o)})},exportMovement:function(e,n,i,t,o,r){GtkCommon.convertToAbsoluteLink(".command_info");var a=r.closest(".ui-dialog").clone();a.find("script, noscript, style, .button, .submenu_link:not(.active), #gtk-"+e+"-export-container").remove(),a.find(".command_info_container").css("height","auto");var s=a.appendTo("#gtk-temporary-container").find("."+r.attr("class")).height()+70;a.find(".gpwindow_frame").css("height",s+3);var d=a.html();if(null==n)n=a.find("img:eq(0)").attr("src").split("/")[6].replace(".png","");$("#gtk-temporary-container").empty(),GtkCommon.sendPostRequest(e+"/export",{movementId:i,movementType:n,movementHtml:d,movementHeight:s,movementCode:t,action:o},function(t){HumanMessage.success(t.message),"refresh"!=o&&GtkMovementAbstractExporter.appendManageExportButton(e,n,i,t.code,t.link,r)})},deleteImage:function(e,n,i,t,o){GtkCommon.sendPostRequest(e+"/delete",{movementId:i,movementType:n,movementCode:t},function(t){HumanMessage.success(t.message),GtkMovementAbstractExporter.appendNewExportButton(e,n,i,o)})},addNewExportListener:function(i,o){$(document).on("click","#gtk-btn-new-"+i+"-export",function(){var t=$(this).attr("data-movement-id"),e=$(this).attr("data-movement-type"),n=GtkMovementAbstractExporter.getWindowId($(this));GtkMovementAbstractExporter.exportMovement(i,e,t,null,"new",o(n))})},addManageExportListener:function(i){$(document).on("click","#gtk-btn-manage-"+i+"-export",function(){var t=$(this).offset(),e=$(this).closest(".gpwindow_content").offset(),n=t.left-e.left-$(this).width()/2-7;$("#gtk-"+i+"-export-container").css("left",n).toggle()})},addRefreshExportListener:function(o,r){$(document).on("click","#gtk-btn-refresh-"+o+"-export",function(){var t=$(this).attr("data-movement-id"),e=$(this).attr("data-movement-type"),n=$(this).attr("data-movement-code"),i=GtkMovementAbstractExporter.getWindowId($(this));GtkMovementAbstractExporter.exportMovement(o,e,t,n,"refresh",r(i))})},addDeleteImageListener:function(o,r){$(document).on("click","#gtk-btn-delete-"+o+"-export",function(){var t=$(this).attr("data-movement-id"),e=$(this).attr("data-movement-type"),n=$(this).attr("data-movement-code"),i=GtkMovementAbstractExporter.getWindowId($(this));GtkMovementAbstractExporter.deleteImage(o,e,t,n,r(i))})},addCopyLinkListener:function(t){new ClipboardJS("#gtk-"+t+"-copy-link").on("success",function(){setTimeout(function(){HumanMessage.success(GtkLang.linkHasBeenCopied)},50)})},getWindowId:function(t){return parseInt(t.closest(".gpwindow_content").attr("id").replace("gpwnd_",""))}},GtkMovementExporter={type:"movement",init:function(){this.addNewExportListener(),this.addManageExportListener(),this.addRefreshExportListener(),this.addDeleteImageListener(),this.addCopyLinkListener()},getContainer:function(){return $(".command_info")},updateWindow:function(t,e){GtkSettings.getValue("exportation_movements")&&GtkMovementAbstractExporter.updateWindow(t,this.type,null,e,this.getContainer())},addNewExportListener:function(){GtkMovementAbstractExporter.addNewExportListener(this.type,this.getContainer)},addManageExportListener:function(){GtkMovementAbstractExporter.addManageExportListener(this.type)},addRefreshExportListener:function(){GtkMovementAbstractExporter.addRefreshExportListener(this.type,this.getContainer)},addDeleteImageListener:function(){GtkMovementAbstractExporter.addDeleteImageListener(this.type,this.getContainer)},addCopyLinkListener:function(){GtkMovementAbstractExporter.addCopyLinkListener(this.type)}},GtkOrdersExporter={ordersHtml:null,mainWindow:null,linkWindow:null,origWinId:null,$origWinDiv:null,init:function(){this.addTabsListener(),this.addPreviewWindowListener(),this.addExportReportListener(),this.addDeleteImageListener(),this.addHideOrderListener(),this.addFilterChangeListener(),this.addCloseLinkWindowListener()},appendButton:function(){0<$("#gtk-btn-orders-exporter").length||!GtkSettings.getValue("exportation_orders")||this.$origWinDiv.find("#place_defense #game_list_header").append(GtkCommon.createButton(GtkLang.exportAsImage,"gtk-btn-orders-exporter"))},prepareData:function(t){this.origWinId=t,this.$origWinDiv=$("#gpwnd_"+this.origWinId),this.ordersHtml='<div class="game_border" style="width: 780px;">'+this.$origWinDiv.find("#place_defense .game_border").html()+"</div>"},openPreviewWindow:function(){this.mainWindow=GtkWindow.create(GPWindowMgr.TYPE_GTK_ORDERS_EXPORTER,"GrepolisToolkit - "+GtkLang.exportOrders,850,600),this.loadPreview(!0)},preparePreview:function(){$(".gtk-orders-image-preview").html(this.ordersHtml),$(".gtk-orders-image-preview #command_filter, .gtk-orders-image-preview .game_arrow_delete").remove(),$(".gtk-orders-image-preview #command_overview").css("height","auto"),$(".gtk-orders-image-preview .game_list_footer").prepend('<span style="font-size: 10px; margin-top: 6px; margin-left: 5px; float: left;">Généré par GrepolisToolkit</span>')},loadPreview:function(t){GtkCommon.sendGetRequest("orders/export/preview",{isInit:t},function(t){GtkWindow.setContent(GtkOrdersExporter.mainWindow,t),GtkOrdersExporter.preparePreview()},GtkOrdersExporter.mainWindow)},loadManager:function(){GtkCommon.sendGetRequest("orders/export/manage",{},function(t){GtkWindow.setContent(GtkOrdersExporter.mainWindow,t),GtkCommonExportation.addThumbnailListener("orders")},GtkOrdersExporter.mainWindow)},exportReport:function(){var t=$(".gtk-orders-image-preview"),e=t.html();t.find(".gtk-remove").remove();var n=t.find(".game_border")[0].scrollHeight+1,i=t.html();t.html(e),GtkCommon.sendPostRequest("orders/export",{ordersHtml:i,ordersHeight:n},function(t){HumanMessage.success(t.message),GtkOrdersExporter.openLinkWindow(t),GtkOrdersExporter.mainWindow.close()})},deleteImage:function(e){GtkCommon.sendPostRequest("orders/delete",{ordersCode:e},function(t){HumanMessage.success(t.message),$('.gtk-orders-manager tr[data-code="'+e+'"]').remove()})},openLinkWindow:function(t){this.linkWindow=GtkWindow.create(GPWindowMgr.TYPE_GTK_ORDERS_LINK,"GrepolisToolkit - "+GtkLang.imageAvailable,300,200),GtkWindow.setContent(GtkOrdersExporter.linkWindow,t)},addTabsListener:function(){$(document).on("click","#gtk-tab-orders-preview, #gtk-tab-orders-manager",function(){switch($(this).attr("data-name")){case"orders-preview":GtkOrdersExporter.loadPreview(!1);break;case"orders-manager":GtkOrdersExporter.loadManager()}})},addPreviewWindowListener:function(){$(document).on("click","#gtk-btn-orders-exporter",function(){GtkOrdersExporter.openPreviewWindow()})},addExportReportListener:function(){$(document).on("click","#gtk-btn-send-orders",function(){GtkOrdersExporter.exportReport()})},addHideOrderListener:function(){$(document).on("click",".gtk-orders-image-preview li",function(){$(this).toggleClass("gtk-remove")})},addFilterChangeListener:function(){$(document).on("click","#dd_commands_command_type_list div",function(){GtkOrdersExporter.prepareData(GtkOrdersExporter.origWinId)})},addCloseLinkWindowListener:function(){$(document).on("click","#gtk-orders-link-window a",function(){GtkOrdersExporter.linkWindow.close()})},addDeleteImageListener:function(){$(document).on("click",".gtk-orders-manager a.gtk-delete",function(){var t=$(this).parent().parent().attr("data-code");ConfirmationWindowFactory.openSimpleConfirmation("Supprimer les ordres","Voulez-vous supprimer cette image ? <br> ATTENTION : cette opération est irréversible",function(){GtkOrdersExporter.deleteImage(t)})})}},GtkReportExporter={$reportTitleDiv:null,$reportDivSaved:null,$reportDiv:null,reportHeight:null,reportId:null,reportTitle:null,reportType:null,mainWindow:null,linkWindow:null,optionsList:{},init:function(){this.addTabsListener(),this.addPreviewWindowListener(),this.addChangeVisibilityListener(),this.addExportReportListener(),this.addCloseLinkWindowListener(),this.setOptionsList()},appendButton:function(){if(0==$("#es_page_reports").length){if(0<$("#gtk-btn-report-exporter").length||!GtkSettings.getValue("exportation_reports"))return;$("#report_report .game_list_footer").append(GtkCommon.createButton(GtkLang.exportAsImage,"gtk-btn-report-exporter"))}},prepareData:function(){var t=$(".support_report_cities");if(t.length){var e=t.css("max-height");t.css("max-height","100%").css("overflow-y","hidden")}GtkCommon.convertToAbsoluteLink("#report_report"),this.$reportDiv=$("#report_report").clone(),this.$reportDiv.find("script,noscript,style").remove(),this.reportHeight=$("#report_report .game_border")[0].scrollHeight+1,this.reportId=$("#report_report_header .game_arrow_delete").attr("onclick").replace("return w(this).sendMessage('reportDeleteOne', ","").replace(");",""),this.reportTitle=$("#report_report_header").text().trim(),this.reportType=this.getReportType(),t.length&&t.css("max-height",e).css("overflow-y","scroll"),this.$reportDiv.find("#report_report_header").html(this.$reportDiv.find("#report_report_header").html().replace(this.reportTitle,"")).append('<span class="gtk-report-title">'+this.reportTitle+"</span>"),this.$reportDiv.find(".button, #select_folder_id").remove(),this.$reportDiv.find(".game_list_footer").append('<p class="gtk-watermark" style="float: right; margin-top: 8px; margin-right: 5px; font-size: 10px;">Généré par GrepolisToolkit</p>'),this.$reportTitleDiv=this.$reportDiv.find(".gtk-report-title"),this.$reportDivSaved=this.$reportDiv.clone()},getReportType:function(){var t="simple_rapport";return $("div#report_arrow img").length&&(t=$("div#report_arrow img").attr("src").replace(/.*\/([a-z_]*).*\.png.*/,"$1").replace(/_$/,"")),"espionage"==t&&$("#report_report #spy_buildings").length<=0?t="missed_espionage":"powers"==t&&$("#report_report #report_sending_town .town_owner").text().trim()==Game.player_name?t="sent_spell":"powers"==t?t="received_spell":"attack"==t&&0<$("#report_report .big_horizontal_report_separator").length&&(t="attack_support"),t},openPreviewWindow:function(t){var e=this.reportHeight+175;e=500<e?e:500,this.mainWindow=GtkWindow.create(GPWindowMgr.TYPE_GTK_REPORT_EXPORTER,"GrepolisToolkit - "+GtkLang.exportReport,1050,e),this.loadPreview(!0,t)},loadPreview:function(t,e){GtkCommon.sendGetRequest("report/export/preview",{isInit:t,reportId:GtkReportExporter.reportHeight,reportTitle:GtkReportExporter.reportTitle},function(t){GtkWindow.setContent(GtkReportExporter.mainWindow,t),GtkReportExporter.updatePreview(!0),e.addOptions()},GtkReportExporter.mainWindow)},loadManager:function(){GtkCommon.sendGetRequest("report/export/manage",{reportId:GtkReportExporter.reportId},function(t){GtkWindow.setContent(GtkReportExporter.mainWindow,t),GtkReportManager.addReportsOptions(t.options),GtkCommonExportation.addThumbnailListener("report")},GtkReportExporter.mainWindow)},updatePreview:function(t){t&&this.resetImage(),$(".gtk-report-image-preview").html(GtkReportExporter.getReportHtml())},resetImage:function(){this.$reportDiv=this.$reportDivSaved.clone()},getReportHtml:function(){return this.$reportDiv[0].outerHTML},setOptionsList:function(){GtkCommonExportation.addOptionToList(this.optionsList,"title",".gtk-report-title","Titre"),GtkCommonExportation.addOptionToList(this.optionsList,"sending_town","#report_sending_town .town_name","Ville émettrice"),GtkCommonExportation.addOptionToList(this.optionsList,"sending_player","#report_sending_town .town_owner","Joueur émetteur"),GtkCommonExportation.addOptionToList(this.optionsList,"sending_alliance","#report_sending_town .town_owner_ally","Alliance émettrice"),GtkCommonExportation.addOptionToList(this.optionsList,"receiving_town","#report_receiving_town .town_name","Ville cible"),GtkCommonExportation.addOptionToList(this.optionsList,"receiving_player","#report_receiving_town .town_owner","Joueur cible"),GtkCommonExportation.addOptionToList(this.optionsList,"receiving_alliance","#report_receiving_town .town_owner_ally","Alliance cible"),GtkCommonExportation.addOptionToList(this.optionsList,"kill_points","#kill_points","Points de combat"),GtkCommonExportation.addOptionToList(this.optionsList,"end_conquest","#resources span","Fin de conquête"),GtkCommonExportation.addOptionToList(this.optionsList,"attacker_unit",".report_side_attacker .report_side_attacker_unit, #left_side:not(#spy_buildings)","Unités attaquantes"),GtkCommonExportation.addOptionToList(this.optionsList,"defender_unit",".report_side_defender_unit, #right_side","Unités défensives"),GtkCommonExportation.addOptionToList(this.optionsList,"attacker_powers",".report_side_attacker .report_power","Sorts attaquant"),GtkCommonExportation.addOptionToList(this.optionsList,"defender_powers",".report_side_defender .report_power","Sorts défenseur"),GtkCommonExportation.addOptionToList(this.optionsList,"resources","#resources","Ressources"),GtkCommonExportation.addOptionToList(this.optionsList,"moral",".morale","Moral"),GtkCommonExportation.addOptionToList(this.optionsList,"chance",".luck","Chance"),GtkCommonExportation.addOptionToList(this.optionsList,"wall",".oldwall","Remparts"),GtkCommonExportation.addOptionToList(this.optionsList,"night_bonus",".nightbonus","Bonus nuit"),GtkCommonExportation.addOptionToList(this.optionsList,"description","#left_side p","Description"),GtkCommonExportation.addOptionToList(this.optionsList,"result","#right_side","Résultat"),GtkCommonExportation.addOptionToList(this.optionsList,"units",".unit_icon40x40","Troupes"),GtkCommonExportation.addOptionToList(this.optionsList,"buildings","#spy_buildings .report_unit","Bâtiments"),GtkCommonExportation.addOptionToList(this.optionsList,"payed_iron","#payed_iron, #right_side p","Pièces utilisées"),GtkCommonExportation.addOptionToList(this.optionsList,"remaining_iron","#payed_iron, #right_side p:eq(2)","Pièces restantes")},addOptions:function(){var t="";switch(t+=this.generateOption("title"),t+="<br>",this.reportType){case"attack":case"attack_support":case"take_over":case"breach":t+=this.generateOption("sending_town"),t+=this.generateOption("sending_player"),t+=this.generateOption("sending_alliance"),t+="<br>",t+=this.generateOption("receiving_town"),t+=this.generateOption("receiving_player"),t+=this.generateOption("receiving_alliance"),t+="<br>",t+=this.generateOption("attacker_unit"),t+=this.generateOption("attacker_powers"),t+=this.generateOption("moral"),t+=this.generateOption("chance"),t+="<br>",t+=this.generateOption("kill_points"),t+=this.generateOption("end_conquest"),t+=this.generateOption("resources"),t+="<br>",t+=this.generateOption("defender_unit"),t+=this.generateOption("defender_powers"),t+=this.generateOption("wall"),t+=this.generateOption("night_bonus");break;case"support":t+=this.generateOption("sending_town"),t+=this.generateOption("sending_player"),t+=this.generateOption("sending_alliance"),t+="<br>",t+=this.generateOption("receiving_town"),t+=this.generateOption("receiving_player"),t+=this.generateOption("receiving_alliance"),t+="<br>",t+=this.generateOption("units");break;case"sent_spell":case"received_spell":t+=this.generateOption("sending_player"),t+=this.generateOption("sending_alliance"),t+="<br>",t+=this.generateOption("receiving_town"),t+=this.generateOption("receiving_player"),t+=this.generateOption("receiving_alliance"),t+="<br>",t+=this.generateOption("description"),t+=this.generateOption("result");break;case"espionage":t+=this.generateOption("sending_town"),t+=this.generateOption("sending_player"),t+=this.generateOption("sending_alliance"),t+="<br>",t+=this.generateOption("receiving_town"),t+=this.generateOption("receiving_player"),t+=this.generateOption("receiving_alliance"),t+="<br>",t+=this.generateOption("units"),t+=this.generateOption("buildings"),t+=this.generateOption("resources"),t+="<br>",t+=this.generateOption("payed_iron");break;case"missed_espionage":t+=this.generateOption("sending_town"),t+=this.generateOption("sending_player"),t+=this.generateOption("sending_alliance"),t+="<br>",t+=this.generateOption("receiving_town"),t+=this.generateOption("receiving_player"),t+=this.generateOption("receiving_alliance"),t+="<br>",t+=this.generateOption("description"),t+="<br>",t+=this.generateOption("payed_iron"),t+=this.generateOption("remaining_iron");break;case"conquer":t+=this.generateOption("sending_town"),t+=this.generateOption("sending_player"),t+=this.generateOption("sending_alliance"),t+="<br>",t+=this.generateOption("receiving_town"),t+=this.generateOption("receiving_player"),t+=this.generateOption("receiving_alliance"),t+="<br>",t+=this.generateOption("description");break;case"raise":t+=this.generateOption("sending_town"),t+=this.generateOption("sending_player"),t+=this.generateOption("sending_alliance"),t+="<br>",t+=this.generateOption("receiving_town"),t+=this.generateOption("receiving_player"),t+="<br>",t+=this.generateOption("attacker_unit"),t+=this.generateOption("defender_unit");break;case"simple_rapport":t+=this.generateOption("description")}$(".gtk-modify-report-options ul").append(t)},generateOption:function(t){return GtkCommonExportation.generateOption(this.optionsList,t,"report")},removeFromTitle:function(t,e,n){var i=this.$reportDiv.find(t);i.html(i.html().trim().replace(new RegExp(n,"g"),"****"))},updateTitle:function(o,t,r){GtkReportExporter.$reportDiv.find(o).html(t.html()),$('#gtk-report-options input[type="checkbox"]').each(function(){var t=$(this).attr("name");if(r.doUpdateTitle(t)){var e=$(this).is(":checked"),n=$(this).attr("data-selector"),i=GtkReportExporter.$reportDiv.find(n).text().trim();e||r.removeFromTitle(o,t,i)}})},exportReport:function(){GtkCommon.sendPostRequest("report/export",{reportHtml:GtkReportExporter.getReportHtml(),reportOptions:GtkCommonExportation.getOptionsAsSerialiazeArray($("#gtk-report-options")),reportHeight:GtkReportExporter.reportHeight,reportId:GtkReportExporter.reportId,reportTitle:GtkReportExporter.reportTitle,reportType:GtkReportExporter.reportType},function(t){HumanMessage.success(t.message),GtkReportExporter.openLinkWindow(t),GtkReportExporter.mainWindow.close()})},openLinkWindow:function(t){this.linkWindow=GtkWindow.create(GPWindowMgr.TYPE_GTK_REPORT_LINK,"GrepolisToolkit - Image disponible",300,200),GtkWindow.setContent(GtkReportExporter.linkWindow,t)},doUpdateTitle:function(t){return-1!=$.inArray(t,["sending_town","sending_player","receiving_town","receiving_player"])},changeElementVisibility:function(t,e,n){var i=t.is(":checked")?"visible":"hidden",o=(t.attr("name"),t.attr("data-selector"));this.updateTitle(n,this.$reportTitleDiv,e),this.$reportDiv.find(o).css("visibility",i)},addTabsListener:function(){$(document).on("click","#gtk-tab-report-preview, #gtk-tab-report-manager",function(){switch($(this).attr("data-name")){case"report-preview":"attack_report"==GtkReportExporter.reportType||"espionage_report"==GtkReportExporter.reportType?GtkReportExporter.loadPreview(!1,GtkReportForumExporter):GtkReportExporter.loadPreview(!1,GtkReportExporter);break;case"report-manager":GtkReportExporter.loadManager()}})},addPreviewWindowListener:function(){$(document).on("click","#gtk-btn-report-exporter",function(){GtkReportExporter.openPreviewWindow(GtkReportExporter)})},addExportReportListener:function(){$(document).on("click","#gtk-btn-send-report",function(){GtkReportExporter.exportReport()})},addChangeVisibilityListener:function(){$(document).on("change",'.gtk-modify-report-options input[data-type="report"]',function(){GtkReportExporter.changeElementVisibility($(this),GtkReportExporter,".gtk-report-title"),GtkReportExporter.updatePreview()})},addCloseLinkWindowListener:function(){$(document).on("click","#gtk-report-link-window a",function(){GtkReportExporter.linkWindow.close()})}},GtkReportForumExporter={$reportTitleDiv:null,init:function(){this.addPreviewWindowListener(),this.addChangeVisibilityListener(),this.setOptionsList()},appendButton:function(){$(".published_report").each(function(){0<$(this).find(".gtk-btn-report-forum-exporter").length||!GtkSettings.getValue("exportation_reports_forum")||($bodyDiv=$(this).find(".espionage_report, .published"),$btnDiv=GtkCommon.createButton(GtkLang.exportAsImage,null,"gtk-btn-report-forum-exporter"),$bodyDiv.find(".button").length?$bodyDiv.find("a.button.simulator:last").after($btnDiv):($bodyDiv.after('<div class="gtk-btn-container"></div>'),$bodyDiv.parent().find("div.gtk-btn-container").append($btnDiv)))})},prepareData:function(t){var e=t.find(".report_data").html();GtkReportExporter.$reportDiv=t.clone(),GtkReportExporter.$reportDiv.find("script,noscript,style").remove(),GtkReportExporter.$reportDiv.find(".button").closest("div").remove(),GtkReportExporter.reportHeight=t[0].scrollHeight-t.find(".button").closest("div")[0].scrollHeight+2,GtkReportExporter.reportId=void 0===e?t.attr("id").replace("bb_codes_report_","").match(/\d/g).join("").substring(0,10):JSON.parse(e).report_id,GtkReportExporter.$reportTitleDiv=t.find(".published_report_header span:eq(0)"),GtkReportExporter.reportTitle=GtkReportExporter.$reportTitleDiv.text().trim(),GtkReportExporter.reportType=this.getReportType(),GtkReportExporter.$reportDiv.find(".game_list_footer").append('<p class="gtk-watermark" style="float: right; margin-top: 8px; margin-right: 5px; font-size: 10px;">Généré par GrepolisToolkit</p>');var n=GtkReportExporter.$reportDiv.find(".report_details .morale");0<n.length&&$(n[0].nextSibling).wrap('<span class="morale">');var i=GtkReportExporter.$reportDiv.find(".report_details .luck");0<i.length&&$(i[0].nextSibling).wrap('<span class="luck">'),GtkReportExporter.$reportDivSaved=GtkReportExporter.$reportDiv.clone()},getReportType:function(){return 0<GtkReportExporter.$reportDiv.find(".fight_report_classic").length?"attack_report":"espionage_report"},setOptionsList:function(){GtkCommonExportation.addOptionToList(GtkReportExporter.optionsList,"title_forum",".published_report_header span:eq(0)","Titre"),GtkCommonExportation.addOptionToList(GtkReportExporter.optionsList,"sending_town_forum","#report_sending_town .town_name","Ville émettrice"),GtkCommonExportation.addOptionToList(GtkReportExporter.optionsList,"receiving_town_forum","#report_receiving_town .town_name","Ville cible"),GtkCommonExportation.addOptionToList(GtkReportExporter.optionsList,"receiving_player_forum","#report_receiving_town .town_owner","Joueur cible"),GtkCommonExportation.addOptionToList(GtkReportExporter.optionsList,"end_conquest_forum","#resources span","Fin de conquête"),GtkCommonExportation.addOptionToList(GtkReportExporter.optionsList,"resources_forum",".resources","Ressources"),GtkCommonExportation.addOptionToList(GtkReportExporter.optionsList,"wall_forum",".report_details tr:eq(3) td:eq(0)","Remparts"),GtkCommonExportation.addOptionToList(GtkReportExporter.optionsList,"night_bonus_forum",".report_details tr:eq(4) td:eq(0)","Bonus nuit"),GtkCommonExportation.addOptionToList(GtkReportExporter.optionsList,"description_forum","#left_side p","Description"),GtkCommonExportation.addOptionToList(GtkReportExporter.optionsList,"buildings_forum",".spy_buildings .report_unit","Bâtiments"),GtkCommonExportation.addOptionToList(GtkReportExporter.optionsList,"payed_iron_forum",".spy_payed span","Pièces utilisées"),GtkCommonExportation.addOptionToList(GtkReportExporter.optionsList,"remaining_iron_forum","#payed_iron, #right_side p:eq(2)","Pièces restantes")},addOptions:function(){var t="";switch(t+=GtkReportForumExporter.generateOption("title_forum"),GtkReportExporter.reportType){case"attack_report":t+=GtkReportForumExporter.generateOption("sending_town_forum"),t+=GtkReportForumExporter.generateOption("receiving_town_forum"),t+=GtkReportForumExporter.generateOption("receiving_player_forum"),t+="<br>",t+=GtkReportForumExporter.generateOption("attacker_unit"),t+=GtkReportForumExporter.generateOption("attacker_powers"),t+="<br>",t+=GtkReportForumExporter.generateOption("moral"),t+=GtkReportForumExporter.generateOption("chance"),t+=GtkReportForumExporter.generateOption("wall_forum"),t+=GtkReportForumExporter.generateOption("night_bonus_forum"),t+=GtkReportForumExporter.generateOption("resources_forum"),t+="<br>",t+=GtkReportForumExporter.generateOption("defender_unit"),t+=GtkReportForumExporter.generateOption("defender_powers");break;case"espionage_report":t+=GtkReportForumExporter.generateOption("sending_town_forum"),t+=GtkReportForumExporter.generateOption("receiving_town_forum"),t+=GtkReportForumExporter.generateOption("receiving_player_forum"),t+="<br>",t+=GtkReportForumExporter.generateOption("units"),t+=GtkReportForumExporter.generateOption("buildings_forum"),t+=GtkReportForumExporter.generateOption("resources_forum"),t+=GtkReportForumExporter.generateOption("payed_iron_forum")}$(".gtk-modify-report-options ul").append(t)},generateOption:function(t){return GtkCommonExportation.generateOption(GtkReportExporter.optionsList,t,"report_forum")},doUpdateTitle:function(t){return-1!=$.inArray(t,["sending_town_forum","receiving_town_forum","receiving_player_forum"])},removeFromTitle:function(t,e){var n,i=GtkReportExporter.$reportDiv.find(t);switch(GtkReportExporter.reportType){case"attack_report":case"espionage_report":switch(e){case"sending_town_forum":n=GtkReportExporter.$reportTitleDiv.find(".gp_town_link:eq(0)").text();break;case"receiving_town_forum":n=GtkReportExporter.$reportTitleDiv.find(".gp_town_link:eq(1)").text();break;case"receiving_player_forum":n=GtkReportExporter.$reportTitleDiv.find(".gp_player_link:eq(0)").text()}}""!=n&&i.html(i.html().replace(n,"****"))},addPreviewWindowListener:function(){$(document).on("click",".gtk-btn-report-forum-exporter",function(){GtkCommon.convertToAbsoluteLink(".published_report");var t=$(this).closest(".published_report");GtkReportForumExporter.prepareData(t),GtkReportExporter.openPreviewWindow(GtkReportForumExporter)})},addChangeVisibilityListener:function(){$(document).on("change",'.gtk-modify-report-options input[data-type="report_forum"]',function(){GtkReportExporter.changeElementVisibility($(this),GtkReportForumExporter,".published_report_header span:eq(0)"),GtkReportExporter.updatePreview()})}},GtkReportManager={reportsOptions:[],init:function(){this.addOpenWindowListener(),this.addDeleteImageListener(),this.addSeeOptionsListener()},appendButton:function(){0<$("#gtk-btn-report-manager").length||!GtkSettings.getValue("exportation_reports")||$("#report_reports .button_area").append(GtkCommon.createButton(GtkLang.manageExports,"gtk-btn-report-manager"))},openWindow:function(){var e=GtkWindow.create(GPWindowMgr.TYPE_GTK_REPORT_MANAGER,"GrepolisToolkit - "+GtkLang.exportManager,950,600);GtkCommon.sendGetRequest("report/manage",{},function(t){GtkWindow.setContent(e,t),GtkReportManager.addReportsOptions(t.options),GtkCommonExportation.addThumbnailListener("report")},e)},deleteImage:function(e){GtkCommon.sendPostRequest("report/delete",{reportCode:e},function(t){HumanMessage.success(t.message),$('.gtk-report-manager tr[data-code="'+e+'"]').remove()})},addReportsOptions:function(t){$.each(t,function(t,e){GtkReportManager.reportsOptions[t]=e})},addOpenWindowListener:function(){$(document).on("click","#gtk-btn-report-manager",function(){GtkReportManager.openWindow()})},addDeleteImageListener:function(){$(document).on("click",".gtk-report-manager a.gtk-delete",function(){var t=$(this).parent().parent().attr("data-code");ConfirmationWindowFactory.openSimpleConfirmation("Supprimer cette image","Voulez-vous supprimer cette image ? <br> ATTENTION : cette opération est irréversible",function(){GtkReportManager.deleteImage(t)})})},addSeeOptionsListener:function(){$(document).on("mouseenter",".gtk-report-manager .gtk-icon-see",function(t){var e=$(this).parent().parent().attr("data-code"),n=GtkReportManager.reportsOptions[e];GtkCommonExportation.showOptionsPanel(n,GtkReportExporter.optionsList),$(".gtk-export-options-panel").css({left:t.pageX,top:t.pageY}).show()}).on("mouseleave",".gtk-report-manager .gtk-icon-see",function(t){$(".gtk-export-options-panel").remove()})}},GtkSimulatorExporter={simulatorHtml:null,mainWindow:null,linkWindow:null,init:function(){this.addTabsListener(),this.addPreviewWindowListener(),this.addExportSimulatorListener(),this.addDeleteImageListener(),this.addCloseLinkWindowListener()},appendButton:function(){0<$("#gtk-btn-simulator-exporter").length||!GtkSettings.getValue("exportation_simulators")||$("#place_simulator_form .game_list_footer").append(GtkCommon.createButton(GtkLang.exportAsImage,"gtk-btn-simulator-exporter"))},prepareData:function(){GtkCommon.convertToAbsoluteLink("#place_simulator"),$("#place_simulator input").each(function(){$(this).attr("value",$(this).val())}),this.simulatorHtml=$("#place_simulator").parent().clone().find("script, noscript, style, #gtk-simulator-resources, .game_list_footer .button").remove().end().html()},openPreviewWindow:function(){this.mainWindow=GtkWindow.create(GPWindowMgr.TYPE_GTK_SIMULATOR_EXPORTER,"GrepolisToolkit - "+GtkLang.exportSimulator,850,650),this.loadPreview(!0)},preparePreview:function(){$(".gtk-simulator-image-preview").html(this.simulatorHtml),$(".gtk-simulator-image-preview .game_list_footer").html('<span style="font-size: 10px; margin-top: 6px; margin-right: 5px; float: right;">Généré par GrepolisToolkit</span>')},loadPreview:function(t){GtkCommon.sendGetRequest("simulator/export/preview",{isInit:t},function(t){GtkWindow.setContent(GtkSimulatorExporter.mainWindow,t),GtkSimulatorExporter.preparePreview()},GtkSimulatorExporter.mainWindow)},loadManager:function(){GtkCommon.sendGetRequest("simulator/export/manage",{},function(t){GtkWindow.setContent(GtkSimulatorExporter.mainWindow,t),GtkCommonExportation.addThumbnailListener("simulator")},GtkSimulatorExporter.mainWindow)},exportSimulator:function(){var t=$("#place_simulator").parent()[0].scrollHeight+3,e=$('style[id^="dio_simulator"]').text();GtkCommon.sendPostRequest("simulator/export",{simulatorHtml:GtkSimulatorExporter.simulatorHtml,simulatorHeight:t,simulatorStyles:e},function(t){HumanMessage.success(t.message),GtkSimulatorExporter.openLinkWindow(t),GtkSimulatorExporter.mainWindow.close()})},deleteImage:function(e){GtkCommon.sendPostRequest("simulator/delete",{simulatorCode:e},function(t){HumanMessage.success(t.message),$('.gtk-simulator-manager tr[data-code="'+e+'"]').remove()})},openLinkWindow:function(t){this.linkWindow=GtkWindow.create(GPWindowMgr.TYPE_GTK_SIMULATOR_LINK,"GrepolisToolkit - "+GtkLang.imageAvailable,300,200),GtkWindow.setContent(GtkSimulatorExporter.linkWindow,t)},addTabsListener:function(){$(document).on("click","#gtk-tab-simulator-preview, #gtk-tab-simulator-manager",function(){switch($(this).attr("data-name")){case"simulator-preview":GtkSimulatorExporter.loadPreview(!1);break;case"simulator-manager":GtkSimulatorExporter.loadManager()}})},addPreviewWindowListener:function(){$(document).on("click","#gtk-btn-simulator-exporter",function(){GtkSimulatorExporter.openPreviewWindow()})},addExportSimulatorListener:function(){$(document).on("click","#gtk-btn-send-simulator",function(){GtkSimulatorExporter.exportSimulator()})},addCloseLinkWindowListener:function(){$(document).on("click","#gtk-simulator-link-window a",function(){GtkSimulatorExporter.linkWindow.close()})},addDeleteImageListener:function(){$(document).on("click",".gtk-simulator-manager a.gtk-delete",function(){var t=$(this).parent().parent().attr("data-code");ConfirmationWindowFactory.openSimpleConfirmation("Supprimer cette image","Voulez-vous supprimer cette image ? <br> ATTENTION : cette opération est irréversible",function(){GtkSimulatorExporter.deleteImage(t)})})}},GtkUnitsExporter={town:null,isInit:!1,init:function(){this.addExportUnitsClickListener(),this.addExportSupportUnitsClickListener(),this.addExportOuterUnitsClickListener(),this.addOpenBBCodeWindowListener()},openExportToBBCodeWindow:function(t){this.town=ITowns.towns[t];var e=this.generateHtmlFieldset(GtkLang.troopsInTown,"gtk-bbcode-units","gtk-btn-export-units","gtk-btn-copy-units");e+=this.generateHtmlFieldset(GtkLang.alliedTroopsInTown,"gtk-bbcode-support-units","gtk-btn-export-support-units","gtk-btn-copy-support-units"),e+=this.generateHtmlFieldset(GtkLang.outsideTroops,"gtk-bbcode-outer-units","gtk-btn-export-outer-units","gtk-btn-copy-outer-units");var n=GtkWindow.create(GPWindowMgr.TYPE_GTK_UNITS_EXPORTER,"GrepolisToolkit - "+GtkLang.exportUnitsAsBBCode,400,350);GtkWindow.setContent(n,{html:e}),this.isInit||(GtkUnitsExporter.copyBBCode("gtk-btn-copy-units"),GtkUnitsExporter.copyBBCode("gtk-btn-copy-support-units"),GtkUnitsExporter.copyBBCode("gtk-btn-copy-outer-units"),this.isInit=!0)},generateHtmlFieldset:function(t,e,n,i){return"<fieldset><legend>"+t+'</legend><input type="textarea" id="'+e+'"  class="gtk-export-bbcode-input" />'+GtkCommon.createButton("Générer",n)+GtkCommon.createButton("Copier",i,"gtk-btn-copy-bbcode",'data-clipboard-target="#'+e+'"')+"</fieldset><br>"},generateTownBBCodeUnits:function(t,e){var n="[table][**][|][town]"+GtkUnitsExporter.town.id+"[/town][|][/**]",i="";if(e){var o=MM.getModels().PlayerHero,r=null,a=null;$.each(o,function(t,e){if((e=e.attributes).home_town_id==GtkUnitsExporter.town.id)return r=e.level,a=e.type,!1}),null!=a&&(i="[*][img]"+GtkDataManager.urlUnitsImg+a+".png[/img][|][|]"+r+"[/*]")}return 0<Object.keys(t).length||null!=a?($.each(t,function(t,e){n+="[*][img]"+GtkDataManager.urlUnitsImg+t+".png[/img][|][|]"+e+"[/*]"}),n+=i):n+="[*][|]Aucune unité[|][/*]",n+="[/table]"},copyBBCode:function(t){new ClipboardJS("#"+t).on("success",function(){setTimeout(function(){HumanMessage.success(GtkLang.BBCodeHasBeenCopied)},50)})},addExportUnitsClickListener:function(){$(document).on("click","#gtk-btn-export-units",function(){var t=GtkUnitsExporter.generateTownBBCodeUnits(GtkUnitsExporter.town.units(),!0);$input=$("#gtk-bbcode-units"),$input.val(t),$input.css("display","block"),$("#gtk-btn-copy-units").addClass("gtk-show")})},addExportSupportUnitsClickListener:function(){$(document).on("click","#gtk-btn-export-support-units",function(){var t=GtkUnitsExporter.generateTownBBCodeUnits(GtkUnitsExporter.town.unitsSupport(),!1);$input=$("#gtk-bbcode-support-units"),$input.val(t),$input.css("display","block"),$("#gtk-btn-copy-support-units").addClass("gtk-show")})},addExportOuterUnitsClickListener:function(){$(document).on("click","#gtk-btn-export-outer-units",function(){var t=GtkUnitsExporter.generateTownBBCodeUnits(GtkUnitsExporter.town.unitsOuter(),!1);$input=$("#gtk-bbcode-outer-units"),$input.val(t),$input.css("display","block"),$("#gtk-btn-copy-outer-units").addClass("gtk-show")})},generateOpenWindowButton:function(t){return GtkCommon.createButton("Exporter",null,"gtk-btn-units-bbcode-window",'data-town-id="'+t+'"')},addOpenBBCodeWindowListener:function(){$(document).on("click",".gtk-btn-units-bbcode-window",function(t){t.preventDefault();var e=$(this).attr("data-town-id");GtkUnitsExporter.openExportToBBCodeWindow(e)})},addButtonsTroopsOverview:function(){$("#unit_overview_town_list .town_item").each(function(){var t=$(this).attr("id").replace("ov_town_","");$(this).find(".town_name").append(GtkUnitsExporter.generateOpenWindowButton(t)+'<div style="clear: both;"></div>'),$(this).parent().addClass("gtk-window-overview")})},addButtonToAgora:function(t){GtkSettings.getValue("exportation_units")&&$("#gpwnd_"+t).find(".game_list_footer").append(GtkUnitsExporter.generateOpenWindowButton(Game.townId))},addFooterToWindow:function(t){GtkSettings.getValue("exportation_units")&&$("#gpwnd_"+t).find(".game_border").append('<div class="game_list_footer"></div>')}},GtkWallExporter={$wallDivSaved:null,$wallDiv:null,wallHeight:null,mainWindow:null,linkWindow:null,optionsList:{},wallsOptions:{},wallCounters:{},init:function(){this.addTabsListener(),this.addPreviewWindowListener(),this.addChangeVisibilityListener(),this.addExportWallListener(),this.addCloseLinkWindowListener(),this.addDeleteImageListener(),this.setOptionsList(),this.addSeeOptionsListener()},appendButton:function(){0<$("#gtk-btn-wall-exporter").length||!GtkSettings.getValue("exportation_walls")||$("#building_wall").append(GtkCommon.createButton(GtkLang.exportAsImage,"gtk-btn-wall-exporter"))},prepareData:function(){var t=$("#building_wall");this.$wallDiv=t.clone(),this.$wallDiv.find("script,noscript,style,.button").remove(),this.$wallDiv.css({left:0,width:650}),this.$wallDiv.find(".game_list p:eq(0)").css({"font-size":12,margin:5}),this.$wallDiv.find(".game_list").css("max-height","none"),this.$wallDiv.find("h3").css({margin:5}),this.$wallDiv.find(".game_border").prepend('<div class="gtk-watermark" style="float: right;font-size: 10px;margin-top: 5px;color: white;margin-right: 10px;">Généré par GrepolisToolkit</div>'),this.wallHeight=this.getWallHeight(t),this.$wallDivSaved=this.$wallDiv.clone(),t.find(".game_list").css("max-height",450),this.saveCounters()},saveCounters:function(){this.wallCounters.defeated_attacker=this.getCounter(".even:eq(1) .list_item_left"),this.wallCounters.defeated_defender=this.getCounter(".even:eq(1) .list_item_right"),this.wallCounters.losses_attacker=this.getCounter(".even:eq(2) .list_item_left"),this.wallCounters.losses_defender=this.getCounter(".even:eq(2) .list_item_right")},getCounter:function(t){return{selector:t,value:this.$wallDiv.find(t).html().match(/\((.*?)\)/)[1]}},openPreviewWindow:function(){var t=this.wallHeight+175;t=500<t?t:500,this.mainWindow=GtkWindow.create(GPWindowMgr.TYPE_GTK_WALL_EXPORTER,"GrepolisToolkit - "+GtkLang.exportWalls,975,t),this.loadPreview(!0)},loadPreview:function(t){GtkCommon.sendGetRequest("wall/export/preview",{isInit:t},function(t){GtkWindow.setContent(GtkWallExporter.mainWindow,t),GtkWallExporter.updatePreview(!0),GtkWallExporter.addOptions()},GtkWallExporter.mainWindow)},loadManager:function(){GtkCommon.sendGetRequest("wall/export/manage",{},function(t){GtkWindow.setContent(GtkWallExporter.mainWindow,t),GtkCommonExportation.addListOptions(GtkWallExporter.wallsOptions,t.options),GtkCommonExportation.addThumbnailListener("wall")},GtkWallExporter.mainWindow)},updatePreview:function(t){t&&this.resetImage(),$(".gtk-wall-image-preview").html(GtkWallExporter.getWallHtml())},resetImage:function(){this.$wallDiv=this.$wallDivSaved.clone()},getWallHtml:function(){return this.$wallDiv[0].outerHTML},getWallHeight:function(t){return t[0].scrollHeight},setOptionsList:function(){GtkCommonExportation.addOptionToList(this.optionsList,"description",".even:eq(0)","Description",!0),GtkCommonExportation.addOptionToList(this.optionsList,"defeated_attacker",".odd:eq(1) .list_item_left","Vaincu en tant qu'attaquant"),GtkCommonExportation.addOptionToList(this.optionsList,"defeated_defender",".odd:eq(1) .list_item_right","Vaincu en tant que défenseur"),GtkCommonExportation.addOptionToList(this.optionsList,"losses_attacker",".odd:eq(2) .list_item_left","Pertes en tant qu'attaquant"),GtkCommonExportation.addOptionToList(this.optionsList,"losses_defender",".odd:eq(2) .list_item_right","Pertes en tant que défenseur")},addOptions:function(){var n="";$.each(this.optionsList,function(t,e){n+=GtkCommonExportation.generateOption(GtkWallExporter.optionsList,t,"wall")}),$(".gtk-modify-wall-options ul").append(n)},exportWall:function(){GtkCommon.sendPostRequest("wall/export",{wallHtml:GtkWallExporter.getWallHtml(),wallOptions:GtkCommonExportation.getOptionsAsSerialiazeArray($("#gtk-wall-options")),wallHeight:GtkWallExporter.getWallHeight($(".gtk-wall-image-preview #building_wall"))},function(t){HumanMessage.success(t.message),GtkWallExporter.openLinkWindow(t),GtkWallExporter.mainWindow.close()})},openLinkWindow:function(t){this.linkWindow=GtkWindow.create(GPWindowMgr.TYPE_GTK_WALL_LINK,"GrepolisToolkit - "+GtkLang.imageAvailable,300,200),GtkWindow.setContent(GtkWallExporter.linkWindow,t)},changeElementVisibility:function(t){var e=t.is(":checked"),n=t.attr("name"),i=t.attr("data-selector"),o=t.attr("data-display"),r=this.$wallDiv.find(i);if("false"==o){var a,s,d=this.wallCounters[n],l=this.$wallDiv.find(d.selector);s=e?(a=l.html().replace("***",d.value),"visible"):(a=l.html().replace(d.value,"***"),"hidden"),l.html(a),r.css("visibility",s)}else e=e?"block":"none",r.css("display",e)},deleteImage:function(e){GtkCommon.sendPostRequest("wall/delete",{wallCode:e},function(t){HumanMessage.success(t.message),$('.gtk-wall-manager tr[data-code="'+e+'"]').remove()})},addTabsListener:function(){$(document).on("click","#gtk-tab-wall-preview, #gtk-tab-wall-manager",function(){switch($(this).attr("data-name")){case"wall-preview":GtkWallExporter.loadPreview(!1);break;case"wall-manager":GtkWallExporter.loadManager()}})},addPreviewWindowListener:function(){$(document).on("click","#gtk-btn-wall-exporter",function(){GtkWallExporter.openPreviewWindow()})},addExportWallListener:function(){$(document).on("click","#gtk-btn-send-wall",function(){GtkWallExporter.exportWall()})},addChangeVisibilityListener:function(){$(document).on("change",".gtk-modify-wall-options input",function(){GtkWallExporter.changeElementVisibility($(this)),GtkWallExporter.updatePreview(!1)})},addCloseLinkWindowListener:function(){$(document).on("click","#gtk-wall-link-window a",function(){GtkWallExporter.linkWindow.close()})},addDeleteImageListener:function(){$(document).on("click",".gtk-wall-manager a.gtk-delete",function(){var t=$(this).parent().parent().attr("data-code");ConfirmationWindowFactory.openSimpleConfirmation("Supprimer les ordres","Voulez-vous supprimer cette image ? <br> ATTENTION : cette opération est irréversible",function(){GtkWallExporter.deleteImage(t)})})},addSeeOptionsListener:function(){$(document).on("mouseenter",".gtk-wall-manager .gtk-icon-see",function(t){var e=$(this).parent().parent().attr("data-code"),n=GtkWallExporter.wallsOptions[e];GtkCommonExportation.showOptionsPanel(n,GtkWallExporter.optionsList),$(".gtk-export-options-panel").css({left:t.pageX,top:t.pageY}).show()}).on("mouseleave",".gtk-wall-manager .gtk-icon-see",function(t){$(".gtk-export-options-panel").remove()})}},GtkCommon={cssPermanentObj:{},indexStyleSheet:null,createButton:function(t,e,n,i){return"<a "+(i=void 0===i?"":i)+' class="gtk-button button '+(n=null==n||void 0===n?"":n)+'" href="#" '+(e=null==e?"":'id="'+e+'"')+'><span class="left"><span class="right"><span class="middle">'+t+'</span></span></span><span style="clear:both;"></span></a>'},createIconButton:function(t,e,n,i){return void 0===i&&(i=""),'<div data-clipboard-target="#'+i+'" id="'+e+'" class="gtk-btn-icon button_new icon_only icon_left"><div class="left"></div><div class="right"></div><div class="caption js-caption"><div class="icon '+n+'"></div><div class="effect js-effect"></div></div></div>'},createTextBox:function(t,e){return'<span class="grepo_input"><span class="left"><span class="right"><input type="text" name="password" id="'+t+'" value="'+e+'"></span></span></span>'},createInfoContainer:function(t,e){return'<div id="'+t+'" class="tooltip_with_arrow arrow-bottom-center"> <div class="twa_border_top"></div><div class="twa_border_bottom"></div><div class="twa_border_left"></div><div class="twa_border_right"></div><div class="twa_corner_tl"></div> <div class="twa_corner_tr"></div><div class="twa_corner_br"></div><div class="twa_corner_bl"></div><div class="twa_arrow js-arrow"></div><div class="twa_background_fake"></div> <div class="twa_content js-content-area">'+e+"</div></div></div>"},sendAjaxRequest:function(t,e,n,i,o){var r,a={marketId:Game.market_id,playerId:Game.player_id,playerName:Game.player_name,accountId:$.cookie("toid"),worldId:parseInt(Game.world_id.replace(Game.market_id,"")),worldName:GtkDataManager.worldName,sessionId:GtkCertification.getCookieValue()};if($.extend(a,n),void 0!==i){Layout.showAjaxLoader();var s=i;i=function(t){var e=s.apply(this,arguments);return Layout.hideAjaxLoader(),e}}if(void 0!==o){var d=o;o=function(t){var e,n=t.responseJSON;if(void 0!==n&&n.hasOwnProperty("success"))e=n.message;else switch(t.status){case 400:case 501:e="La demande est erronée.";break;case 404:e="Impossible de trouver la page demandée.";break;case 502:case 503:e="Le serveur n'est momentanément pas accessible.";break;case 504:e="Le réseau n'a pas répondu car le délai est dépassé.";break;default:e="Une erreur interne s'est produite !"}return HumanMessage.error("GrepolisToolkit : "+e),d.apply(this,arguments)}}r=e.match(/\/script\//)?GtkDataManager.urlSite+e:GtkDataManager.urlSite+GtkDataManager.pathScript+e,$.ajax({type:t,url:r,data:a,dataType:"json",xhrFields:{withCredentials:!0},crossDomain:!0,success:i,error:o})},sendGetRequest:function(t,e,n,i){if(void 0!==n){var o=n;n=function(t){if(!t.hasOwnProperty("saveContext")||!t.saveContext)return t.hasOwnProperty("sessionId")&&GtkCertification.setCookieValue(t.sessionId),o.apply(this,arguments);GtkCertification.urls[i.getID()]={url:this.url.replace(GtkDataManager.urlSite,"").replace(/&sessionId=(.*?)(?=&)/,""),callbackSuccess:o},GtkWindow.setContent(i,t)}}this.sendAjaxRequest("GET",t,e,n)},sendPostRequest:function(t,e,n,i){this.sendAjaxRequest("POST",t,e,n,i)},convertToAbsoluteLink:function(t){$(t+" img").attr("src",function(){return $(this)[0].src})},formatTime:function(t,e,n){var i=GtkLang.todayAt;return 59<n&&(e+=Math.floor(n/60),n%=60),59<e&&(t+=Math.floor(e/60),e%=60),23<t&&(t=Math.floor(t/24),i=GtkLang.tomorrowAt),t<=9&&(t="0"+t),e<=9&&(e="0"+e),n<=9&&(n="0"+n),[i,t,e,n]},addPermanentCSS:function(t,e){if(null==this.indexStyleSheet){this.indexStyleSheet=document.styleSheets.length;var n=document.createElement("style");document.head.appendChild(n)}var i,o,r=document.styleSheets[this.indexStyleSheet];i=t+"{",$.each(e,function(t,e){i+=e[0]+": "+e[1]+";"}),i+="}",o=this.cssPermanentObj.hasOwnProperty(t)?this.cssPermanentObj[t].deleted?this.cssPermanentObj[t].index:GtkCommon.removePermanentCSS(t):r.cssRules.length,r.insertRule(i,o),this.cssPermanentObj[t]={rule:i,index:o,deleted:!1}},removePermanentCSS:function(t){var e=document.styleSheets[this.indexStyleSheet],n=null;return void 0!==this.cssPermanentObj[t]&&(n=this.cssPermanentObj[t].index,e.deleteRule(n),this.cssPermanentObj[t].deleted=!0),n}},GtkDataManager={urlSite:"https://fr.grepolistoolkit.com",urlCdn:"https://cdn.grepolistoolkit.com",pathScript:"/script/",urlImg:null,urlUnitsImg:null,scriptVersion:"2.0.20",worldName:null,settings:null,init:function(){this.urlImg=this.urlCdn+"/images/",this.urlUnitsImg=this.urlImg+"units/",this.urlSmileyImg=this.urlImg+"smileys/"}},GtkCertification={urls:{},init:function(){this.addSendFormListener(),this.addSendCertificationListener(),this.addLoadInWindowWithoutSavingContext(),this.addDeleteCertificationListener(),this.addLogoutSettingsListener()},getCookieValue:function(){return $.cookie("gtk_session_"+Game.player_id)},setCookieValue:function(t){$.cookie("gtk_session_"+Game.player_id,t,{expires:365,path:"/game",domain:".grepolis.com"})},hasCookie:function(){return null!=this.getCookieValue()},addSendFormListener:function(){$(document).on("click","#gtk-login .gtk-submit",function(){$form=$("#gtk-login-form");var t=$form.attr("action"),e=$form.serializeArray(),n=$("#"+$form.attr("id"));GtkCommon.sendPostRequest(t,{formData:e},function(t){null!=t.sessionId&&GtkCertification.setCookieValue(t.sessionId),GtkCertification.updateWindowContent(n,t)})})},addSendCertificationListener:function(){$(document).on("click","#gtk-certification #gtk-btn-send-certification",function(t){t.preventDefault();var e=$(this).attr("href"),n=$(this);GtkCommon.sendPostRequest(e,{},function(t){GtkCertification.updateWindowContent(n,t)})})},addLoadInWindowWithoutSavingContext:function(){$(document).on("click","#gtk-certification .gtk-logout, #gtk-certification .gtk-login",function(t){t.preventDefault();var e=$(this),n=$(this).attr("href"),i=GtkWindow.getWindowBySelector(e);GtkCommon.sendGetRequest(n,{},function(t){GtkWindow.setContent(i,t)},i)})},addDeleteCertificationListener:function(){$(document).on("click","#gtk-certification .gtk-delete-certification",function(t){t.preventDefault();var e=$(this),n=$(this).attr("href"),i=GtkWindow.getWindowBySelector(e),o=$(this).attr("data-username");GtkCommon.sendGetRequest(n,{username:o},function(t){GtkWindow.setContent(i,t)},i)})},addLogoutSettingsListener:function(){$(document).on("click","#gtk-logout",function(t){t.preventDefault();$(this);var e=$(this).attr("href");GtkCommon.sendGetRequest(e,{},function(t){Human.success("Vous avez été déconnecté")})})},updateWindowContent:function(t,e){var n=GtkWindow.getWindowBySelector(t);if(e.hasOwnProperty("redirectToUrl")){var i=GtkCertification.urls[n.getID()];GtkCommon.sendGetRequest(i.url,{},function(t){i.callbackSuccess(t)},n)}else GtkWindow.setContent(n,e)},disconnectUser:function(){$.removeCookie("gtk_session_"+Game.player_id,{domain:".grepolis.com"})}},GtkLauncher={loadScript:!0,supportedCommunity:["fr"],checkGameInit:function(){void 0!==Game.market_id&&void 0!==Game.player_id||(this.loadScript=!1)},checkSupportedCommunity:function(){if($.inArray(Game.market_id,this.supportedCommunity)<0){HumanMessage.error("The script is not maintained for this community"),this.loadScript=!1}},showWelcomeWindow:function(t){0<t.length?(GtkWelcomeWindow.welcomeWindows=t,GtkWelcomeWindow.openWindow()):GtkWelcomeWindow.getCookie()||GtkWelcomeWindow.setCookie()},showNewAnnouncement:function(t,e){(t||void 0===$.cookie("gtk_announcement_"+Game.player_id))&&(t&&GtkAnnouncements.openWindow(!0),$.cookie("gtk_announcement_"+Game.player_id,e,{expires:5e3,path:"/game",domain:".grepolis.com"}))},getInitData:function(){var t={hasBeenWelcomed:GtkWelcomeWindow.getCookie(),lastAnnouncementId:$.cookie("gtk_announcement_"+Game.player_id),scriptVersion:GtkDataManager.scriptVersion};GtkThemes.changeTheme(GtkSettings.getValue("theme")),GtkCommon.sendPostRequest("init",t,function(t){GtkDataManager.worldName=t.worldName,$.cookie("gtk_world_name",t.worldName,{expires:5e3}),GtkSettings.saveBddSettings(t.settings),GtkSettings.applySettings(),GtkLauncher.showNewAnnouncement(t.showAnnouncement,t.lastAnnouncementId),GtkLauncher.showWelcomeWindow(t.welcomeWindows),GtkThemes.changeTheme(GtkSettings.getValue("theme"))},function(){GtkSettings.applySettings()})},registerWindows:function(){GPWindowMgr.addWndType("GTK_WELCOME",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_ANNOUNCEMENTS",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_THEMES",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_OPTIONS",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_ABOUT",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_REPORT_EXPORTER",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_REPORT_LINK",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_REPORT_MANAGER",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_ORDERS_EXPORTER",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_ORDERS_LINK",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_SIMULATOR_EXPORTER",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_SIMULATOR_LINK",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_WALL_EXPORTER",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_WALL_LINK",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_UNITS_EXPORTER",null,window.WndHandlerDefault,1,!1),GPWindowMgr.addWndType("GTK_MESSAGE_EXPORTER",null,window.WndHandlerDefault,1,!1)},initTempDiv:function(){$("body").append('<div id="gtk-temporary-container"></div>')},init:function(){this.checkGameInit(),this.loadScript&&(this.checkSupportedCommunity(),this.loadScript&&(0<$(".nui_main_menu .messages").length?(this.registerWindows(),this.initTempDiv(),this.getInitData(),GtkLanguageManager.setLanguage(GtkSettings.getValue("language"),!1),GtkSettings.init(),GtkMenu.init(),GtkWindow.init(),GtkDataManager.init(),GtkAnnouncements.init(),GtkThemes.init(),GtkShortcuts.init(),GtkAbout.init(),GtkCertification.init(),GtkReportExporter.init(),GtkReportManager.init(),GtkReportForumExporter.init(),GtkOrdersExporter.init(),GtkSimulatorExporter.init(),GtkMovementExporter.init(),GtkConquestExporter.init(),GtkWallExporter.init(),GtkSenatePoints.init(),GtkSimulatorInfos.init(),GtkSmileys.init(),GtkVarious.init(),GtkSimulatorBuilder.init(),GtkMaximiseForum.init(),GtkAjaxDetector.init(),GtkSounds.init(),GtkPicomap.init(),GtkMapConnector.init(),GtkUnitsExporter.init(),GtkWelcomeWindow.init(),GtkContextMenu.init(),GtkMessageExporter.init()):setTimeout(function(){GtkLauncher.init()},100)))}};$(document).ready(function(){GtkLauncher.init()});