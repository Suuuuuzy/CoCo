var DiskStorage={init:function(){var e,t=this,o=this.dbName||location.href.replace(/\/|:|#|%|\.|\[|\]/g,""),n=indexedDB.open(o,1);function l(e){e.createObjectStore(t.dataStoreName)}function a(){try{var o=null;o=!0===t.data.get?e.transaction([t.dataStoreName],"readonly"):e.transaction([t.dataStoreName],"readwrite");var n=null,l=t.data.key;!0===t.data.get?n=o.objectStore(t.dataStoreName).get(l):!0===t.data.put&&void 0!==t.data.value?n=o.objectStore(t.dataStoreName).put(t.data.value,l):!0===t.data.delete&&(n=o.objectStore(t.dataStoreName).delete(l)),n.onsuccess=function(e){if("function"==typeof t.callback){var o=t.callback;t.callback=null,!0===t.data.get?o(e.target.result,l):o("success",l)}},n.onerror=function(e){if("function"==typeof t.callback){var o=t.callback;t.callback=null,o(null,l,e)}}}catch(e){if(console.log(e),"function"==typeof t.callback){var a=t.callback;t.callback=null,a(null,t.data.key,"Data store does not exist")}}}n.onerror=t.onError,n.onsuccess=function(){((e=n.result).onerror=t.onError,e.setVersion)?1!==e.version?e.setVersion(1).onsuccess=function(){l(e),a()}:a():a()},n.onupgradeneeded=function(e){l(e.target.result)}},Fetch:function(e,t){return this.data={key:e,get:!0},this.callback=t,this.init(),this},Store:function(e,t){return this.data=e,this.data.put=!0,this.data.get=!1,this.data.delete=!1,this.callback=t,this.init(),this},onError:function(e){console.error(e)},Delete:function(e,t){return this.data={key:e,delete:!0},this.callback=t,this.init(),this},callback:null,dataStoreName:"outklip",dbName:"outklip",data:{value:"",key:"outklip-video",get:!1,put:!1,delete:!1}},runtimePort=chrome.runtime.connect({name:location.href.replace(/\/|:|#|\?|\$|\^|%|\.|`|~|!|\+|@|\[|\||]|\|*. /g,"").split("\n").join("").split("\r").join("")});function formatBytes(e,t){if(0==e)return"0 Bytes";var o=t||2,n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(o))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][n]}$(document).ready(function(){M.AutoInit();var e=null,t=new URL(window.location.href).searchParams.get("autoconvert"),o=null;o="false"!==t,DiskStorage.Fetch("outklip-video",function(t){if(t){var n=t.name;DiskStorage.Fetch("outklip-seekable-video",function(l){if(l&&n==l.name)e=l;else if(e=t,o){if("undefined"==typeof EBML)throw new Error("Seekable file converter is missing.");const t=new EBML.Decoder,o=new EBML.Reader;var a=EBML.tools,i=new FileReader;i.onload=function(n){t.decode(i.result).forEach(function(e){o.read(e)}),o.stop();var l=a.makeMetadataSeekable(o.metadatas,o.duration,o.cues),d=e.slice(o.metadataSize),r=new Blob([l,d],{type:"video/webm"}),s=new File([r],e.name,{type:"video/webm"});DiskStorage.Store({key:"outklip-seekable-video",value:s},function(e,t,o){document.getElementById("reload-webpage").style.display="block"})},i.readAsArrayBuffer(e)}var d=URL.createObjectURL(e),r=document.getElementById("lastvideo"),s=document.getElementById("videocontainer");r&&s&&(r.src=d,s.style.display="block"),document.getElementById("savedvideoon").innerHTML="Saved on "+moment(e.lastModifiedDate).format("MMMM Do YYYY, h:mm a");var c=document.getElementById("videofilesize");e.size&&(c.innerHTML="File size: "+formatBytes(e.size));var m=document.getElementById("downloadlink");m.href=d,m.download="OutKlip Video "+moment(e.lastModifiedDate).format("MMMM Do YYYY, h:mm a");var u=document.getElementById("uploadvideo");runtimePort.postMessage({initIframe:!0}),u.addEventListener("click",function(){runtimePort.postMessage({uploadVideo:!0}),$("#uploadmodal").modal({dismissible:!1}),$("#uploadmodal").modal("open")})}),document.getElementById("novideosaved").style.display="none"}else{var l=document.getElementById("videocontainer");l&&(l.style.display="none"),document.getElementById("novideosaved").style.display="block"}chrome.storage.sync.get(["cloudVideoStorage"],function(e){var t=document.getElementById("cloudvideostoragedisabled"),o=document.getElementById("settingslink");"false"==e.cloudVideoStorage?(o.href="chrome-extension://"+chrome.runtime.id+"/settings.html",t.style.display="block"):t.style.display="none"})});var n=document.getElementById("uploaderror"),l=document.getElementById("uploaderrormessage"),a=(chrome.storage.local.get(["uploaderror"],function(e){e.uploaderror?(l.innerHTML=e.uploaderror,n.style.display="block"):n.style.display="none"}),document.getElementById("lastvideoprogresslog")),i=document.getElementById("uploaderrorfix"),d=(chrome.storage.local.get(["videoprogresslog","customertype","videoerrorfix"],function(e){var t=document.getElementById("limitedmodecta"),o=document.getElementById("uploadvideo"),n=document.getElementById("myklips-menu-link"),l=document.getElementById("myklips-menu-link-sidenav");"limited"==e.customertype?(t.style.display="block",o.style.display="none",n.style.display="none",l.style.display="none"):(t.style.display="none",o.style.display="inline-block",n.style.display="block",l.style.display="block");var d="";if(e.videoprogresslog){for(var r=0;r<e.videoprogresslog.length;r++)d+=e.videoprogresslog[r],r==e.videoprogresslog.length-1?d+=".":d+=", ";a.innerHTML=d}i&&e.videoerrorfix&&e.videoerrorfix.length>0&&(i.innerHTML=e.videoerrorfix)}),document.getElementById("togglelogbutton")),r=document.getElementById("progresslogcontainer");d.addEventListener("click",function(){"Show Log"==d.innerHTML?(d.innerHTML="Hide Log",r.style.display="block"):"Hide Log"==d.innerHTML&&(d.innerHTML="Show Log",r.style.display="none")}),document.getElementById("deletevideobutton").addEventListener("click",function(){$("#deletevideomodal").modal({dismissible:!1}),$("#deletevideomodal").modal("open")}),document.getElementById("confirmvideodeletion").addEventListener("click",function(){$(".modal").modal("close"),$(".modal-overlay").remove(),$("#videodeletioninprogressmodal").modal({dismissible:!1}),$("#videodeletioninprogressmodal").modal("open"),DiskStorage.Delete("outklip-video",function(e){DiskStorage.Delete("outklip-seekable-video",function(e){M.toast({html:'<span style="color:white">Deleted video.</span>'});var t=document.getElementById("videocontainer");t&&(t.style.display="none"),document.getElementById("novideosaved").style.display="block",$(".modal").modal("close"),$(".modal-overlay").remove()})})})}),chrome.runtime.onMessage.addListener(function(e,t,o){if("MANUAL_UPLOAD_PROGRESS_PERCENTAGE"==e.greeting)document.getElementById("upload_progress_in_percent").innerHTML=e.progressinpercent+"% complete";else if("MANUAL_UPLOAD_COMPLETE"==e.greeting)$(".modal").modal("close"),$(".modal-overlay").remove();else if("MANUAL_UPLOAD_ERROR"==e.greeting){var n=document.getElementById("uploaderror");document.getElementById("uploaderrormessage").innerHTML=e.uploaderror,n.style.display="block"}});